# è¯·æ±‚å¤„ç†

## ä»‹ç»

**Handlerç”¨äºæ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚è·¯å¾„è¿›è¡Œé’ˆå¯¹æ€§å¤„ç†ã€‚**

å®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥**ServiceCore**åï¼Œå°†å…ˆåç»è¿‡[å…¨å±€æ‹¦æˆªå™¨](/guide/web-service.html#å…¨å±€æ‹¦æˆªå™¨)å’Œ[å…¨å±€ä¸­é—´ä»¶ç®¡é“](/guide/web-service.html#å…¨å±€ä¸­é—´ä»¶)ã€‚å½“**å…¨å±€ä¸­é—´ä»¶ç®¡é“**ä¸­çš„æœ€åä¸€ä¸ªä¸­é—´ä»¶æ‰§è¡Œå®Œæˆåï¼Œ**ServiceCore**å°†è‡ªåŠ¨åˆ›å»ºä¸è¯·æ±‚è·¯å¾„åŒ¹é…çš„**Handlerå®ä¾‹**å¹¶å¼•å¯¼è¯·æ±‚è¿›å…¥å…¶ä¸­è¿›è¡Œåç»­å¤„ç†ã€‚

::: tip æç¤º
**Handler**æ‹¥æœ‰ç‹¬ç«‹äº**ServiceCore**çš„[ä¸­é—´ä»¶ç³»ç»Ÿ](#ä¸­é—´ä»¶ç³»ç»Ÿ-2)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨**Handler**ç»´åº¦æŒ‡å®šçš„ä¸­é—´ä»¶åªä½œç”¨äºç¬¦åˆè¯·æ±‚è·¯å¾„è§„åˆ™çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚

å¦å¤–ï¼Œ**Handlerçš„ä¸­é—´ä»¶ç³»ç»Ÿå…¼å®¹Expressç”Ÿæ€ä¸”æ”¯æŒåŠ¨æ€ä¸­é—´ä»¶**ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚çš„å®é™…ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ï¼šè¯·æ±‚å‚æ•°ï¼‰ï¼š

- **åŠ¨æ€æŒ‡å®šä¸­é—´ä»¶åˆ—è¡¨**
- **æ§åˆ¶ä¸­é—´ä»¶æ‰§è¡Œè§„åˆ™**ï¼ˆæ¯”å¦‚ï¼šè·³è¿‡æ‰§è¡Œï¼‰
:::

åœ¨[WebæœåŠ¡-è®¾ç½®è¯·æ±‚è·¯å¾„](/guide/web-service.html#è®¾ç½®è¯·æ±‚è·¯å¾„)ä¸€ç« ä¸­æˆ‘ä»¬å·²ç»äº†è§£åˆ°ï¼Œ**è‡ªå®šä¹‰Handler**éœ€è¦å®ç°ä¸€ä¸ªç»§æ‰¿è‡ª```Core.Handler```çš„ç±»ã€‚æœ¬è´¨ä¸Š```Core.Handler```æ˜¯ä¸€ä¸ªåŒ…å«äº†æ ¸å¿ƒå¤„ç†æµç¨‹çš„**æŠ½è±¡ç±»**ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°**æŠ½è±¡ç±»**å†…çš„HOOKæ–¹æ³•ä»¥å®šåˆ¶è¯·æ±‚å¤„ç†æµç¨‹çš„å„ä¸ªç¯èŠ‚ã€‚

**ä¸‹é¢ï¼Œæˆ‘ä»¬å°†åˆ†ç±»ä»‹ç»```Core.Handler```ä¸­æ¨èè¢«é‡å†™çš„æ–¹æ³•ï¼š**

### è¯·æ±‚è·¯å¾„

- **```static getRoutePath()```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šè®¾ç½®**Handler**çš„è¯·æ±‚è·¯å¾„è§„åˆ™ã€‚**ServiceCore**å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå°†æ ¹æ®è¯·æ±‚è·¯å¾„æŒ‡å®šå®Œæˆå®é™…å¤„ç†åŠ¨ä½œçš„**Handlerå®ä¾‹**ã€‚
  
  - **è°ƒç”¨æ—¶æœº**ï¼š**ServiceCore**æ‰§è¡Œå®ä¾‹æ–¹æ³•```bind()```æ—¶è°ƒç”¨æ­¤æ–¹æ³•è·å–**Handler**çš„è¯·æ±‚è·¯å¾„è§„åˆ™ã€‚
  
  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œä½¿ç”¨```return```è¿”å›è¯·æ±‚è·¯å¾„è§„åˆ™ã€‚
    
    ::: warning æ³¨æ„
    **ServiceCore**å°†è‡ªåŠ¨æ ¡æ­£**Handler**çš„è¯·æ±‚è·¯å¾„è§„åˆ™ï¼š**å½“è¯·æ±‚è·¯å¾„è§„åˆ™ä¸ä»¥```'/'```å¼€å¤´æ—¶ï¼Œé™„åŠ ```'/'```ä½œä¸ºå‰ç¼€**ã€‚
    
    å› æ­¤ï¼Œæˆ‘ä»¬é…ç½®è¯·æ±‚è·¯å¾„è§„åˆ™æ—¶åº”å°½é‡ä»¥```'/'```å¼€å¤´ã€‚
    :::
  
  - **é»˜è®¤è¡Œä¸º**ï¼šè®¾ç½®è¯·æ±‚è·¯å¾„è§„åˆ™ä¸º```'/'```ã€‚
    
    ```javascript
    static getRoutePath() {
      return '/';
    }
    ```

### ç”Ÿå‘½å‘¨æœŸ

- **```initHandler(req, res, next)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šæŒ‡å®š[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)é€»è¾‘ã€‚

    ::: tip æç¤º
    æ­¤æ–¹æ³•ä¸­é€šå¸¸æ‰§è¡Œçš„æ˜¯**éä¸šåŠ¡ç›¸å…³çš„é€šç”¨é€»è¾‘**ï¼ˆæ¯”å¦‚ï¼šåˆ›å»º**æ—¥å¿—è¾“å‡ºå™¨**ï¼‰ï¼Œå¯¹äº**ä¸šåŠ¡ç›¸å…³çš„åˆå§‹åŒ–é€»è¾‘**æ¨èæ”¾å…¥[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)æˆ–[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)é˜¶æ®µã€‚
    :::

  - **è°ƒç”¨æ—¶æœº**ï¼š**ServiceCore**å¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œéƒ½å°†åˆ›å»ºä¸è¯·æ±‚è·¯å¾„åŒ¹é…çš„**Handlerå®ä¾‹**å¹¶è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

    ::: tip æç¤º
    æˆ‘ä»¬åœ¨å®ç°[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)é€»è¾‘æ—¶ï¼Œé€šå¸¸ä¸ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œè€Œæ˜¯é€šè¿‡[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ§åˆ¶è¯·æ±‚å¤„ç†é“¾è·¯ã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::

  - **é»˜è®¤è¡Œä¸º**ï¼šç›´æ¥è°ƒç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)è¿›å…¥ä¸‹ä¸€å¤„ç†é˜¶æ®µã€‚
    
    ```javascript
    initHandler(req, res, next) {
      next();
    }
    ```

- **```destroyHandler(req, res)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šæŒ‡å®š[Handlerææ„](#handlerææ„)é€»è¾‘ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šè¿›å…¥**Handler**å¤„ç†çš„å®¢æˆ·ç«¯è¯·æ±‚è¿”å›æ—¶å°†è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘[Handlerææ„](#handlerææ„)ã€‚
    
    ::: tip æç¤º
    **å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚åœ¨ServiceCoreçš„[å…¨å±€æ‹¦æˆªå™¨](/guide/web-service.html#å…¨å±€æ‹¦æˆªå™¨)å’Œ[å…¨å±€ä¸­é—´ä»¶ç®¡é“](/guide/web-service.html#å…¨å±€ä¸­é—´ä»¶)é˜¶æ®µè¿”å›åˆ™ä¸ä¼šè§¦å‘[Handlerææ„](#handlerææ„)ã€‚**
    :::

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

    ::: tip æç¤º
    è¿›å…¥[Handlerææ„](#handlerææ„)é˜¶æ®µæ—¶ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å·²è¿”å›å¤„ç†ç»“æœã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”ä»…å¯¹**å®¢æˆ·ç«¯è¯·æ±‚å®ä¾‹**```req```å’Œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹**```res```å‘èµ·è¯»å–åŠ¨ä½œã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::

### ä¸­é—´ä»¶ç³»ç»Ÿ

- **```getMiddlewares(req, res)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šæ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚çš„å®é™…ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ï¼šè¯·æ±‚å‚æ•°ï¼‰åŠ¨æ€æŒ‡å®š[Handlerä¸­é—´ä»¶](#ä¸­é—´ä»¶ç³»ç»Ÿ-2)åˆ—è¡¨ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šåœ¨[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)å®Œæˆåå°†è¿›å…¥**ä¸­é—´ä»¶é˜¶æ®µ**ï¼Œåœ¨å¼€å§‹åˆ†å‘**Handlerä¸­é—´ä»¶**å‰å°†è°ƒç”¨æ­¤æ–¹æ³•è·å–**ä¸­é—´ä»¶åˆ—è¡¨**ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œä½¿ç”¨```return```è¿”å›**ä¸­é—´ä»¶åˆ—è¡¨**å³å¯ï¼›å½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚
  
    ::: tip æç¤º
    æˆ‘ä»¬åœ¨æŒ‡å®š**Handler**çš„**ä¸­é—´ä»¶åˆ—è¡¨**æ—¶ï¼Œé€šå¸¸ä¸ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::
  
  - **é»˜è®¤è¡Œä¸º**ï¼šè¿”å›```[]```ã€‚
    
    ```javascript
    getMiddlewares(req, res) {
      return [];
    }
    ```

- **```onInterceptMiddleware(middleware, req, res, next)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼š**åŠ¨æ€ä¸­é—´ä»¶**çš„æ ¸å¿ƒHOOKæ–¹æ³•ï¼Œæä¾›äº†**åœ¨åˆ†å‘ä¸­é—´ä»¶æ—¶æ§åˆ¶å…¶æ‰§è¡Œè¡Œä¸º**çš„èƒ½åŠ›ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼š**ä¸­é—´ä»¶é˜¶æ®µ**åˆ†å‘æ¯ä¸ªä¸­é—´ä»¶æ—¶ï¼Œéƒ½å°†è°ƒç”¨æ­¤æ–¹æ³•å®Œæˆä¸­é—´ä»¶çš„å®é™…æ‰§è¡Œè¡Œä¸ºã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚
  
    ::: tip æç¤º
    æˆ‘ä»¬åœ¨å®ç°**åŠ¨æ€ä¸­é—´ä»¶**æ—¶ï¼Œé€šå¸¸ä¸ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œè€Œæ˜¯é€šè¿‡[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ§åˆ¶ä¸­é—´ä»¶çš„æ‰§è¡Œé“¾è·¯ã€‚

    åœ¨**ä¸­é—´ä»¶æ‹¦æˆª**é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®**å½“å‰åˆ†å‘ä¸­é—´ä»¶**```middleware.type```çš„ç±»å‹ï¼Œå†³å®šæ˜¯å¦è°ƒç”¨**ä¸­é—´ä»¶çš„æ‰§è¡Œå‡½æ•°**```middleware.exec```ä»¥å®ç°å¯¹ä¸­é—´ä»¶æ‰§è¡Œè¡Œä¸ºçš„åŠ¨æ€æ§åˆ¶ã€‚
    :::

  - **é»˜è®¤è¡Œä¸º**ï¼šæ‰§è¡Œä¸­é—´ä»¶å¹¶å°†å…¶ç»“æœä½œä¸ºæ‰§è¡Œ[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)çš„å‚æ•°ã€‚
  
    ```javascript
    onInterceptMiddleware(middleware, req, res, next) {
      const { exec } = middleware;
      exec((result) => next(result));
    }
    ```

### è¯·æ±‚å¤„ç†

- **```preHandler(req, res, next)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šæ ¹æ®ä¸­é—´ä»¶æ‰§è¡Œç»“æœåˆå§‹åŒ–å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ‰€éœ€çš„åŸºç¡€ç¯å¢ƒï¼Œæ¯”å¦‚ï¼šå‚æ•°èšåˆã€åˆ›å»ºåŸºç¡€èµ„æºç­‰ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šåœ¨**ä¸­é—´ä»¶é˜¶æ®µ**å®Œæˆåï¼ˆå³ï¼šæœ€åä¸€ä¸ªä¸­é—´ä»¶çš„æ‹¦æˆªé˜¶æ®µç»“æŸæ—¶ï¼‰ï¼Œå°†è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

    ::: tip æç¤º
    æˆ‘ä»¬åœ¨æŒ‡å®š[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)é€»è¾‘æ—¶ï¼Œé€šå¸¸ä¸ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œè€Œæ˜¯é€šè¿‡[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ§åˆ¶è¯·æ±‚å¤„ç†é“¾è·¯ã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::

  - **é»˜è®¤è¡Œä¸º**ï¼šç›´æ¥è°ƒç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)è¿›å…¥ä¸‹ä¸€å¤„ç†é˜¶æ®µã€‚
    
    ```javascript
    preHandler(req, res, next) {
      next();
    }
    ```

- **```[METHOD]Handler(req, res, next)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šæ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚æ–¹å¼è§¦å‘å¯¹åº”çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šå½“[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)é˜¶æ®µç»“æŸæ—¶ï¼Œå°†è°ƒç”¨ä¸å®¢æˆ·ç«¯è¯·æ±‚æ–¹å¼åŒ¹é…çš„å®ä¾‹æ–¹æ³•ä»¥è¿›å…¥[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

    ::: tip æç¤º
    **```[METHOD]Handler```ä¸æ˜¯åœ¨æŒ‡å®š[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)é€»è¾‘æ—¶å®é™…é‡å†™çš„æ–¹æ³•å**ï¼Œåªæ˜¯**Handler Method**çš„ä»£ç§°ï¼Œæ¯”å¦‚ï¼šå¤„ç†å®¢æˆ·ç«¯POSTè¯·æ±‚ï¼Œæˆ‘ä»¬åº”è¯¥é‡å†™**Handler**ä¸­çš„**å®ä¾‹æ–¹æ³•```postHandler()```**ã€‚

    æˆ‘ä»¬åœ¨æŒ‡å®š[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)é€»è¾‘æ—¶ï¼Œé€šå¸¸ä¸ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œè€Œæ˜¯é€šè¿‡[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ§åˆ¶è¯·æ±‚å¤„ç†é“¾è·¯ã€‚

    å¦‚æœåœ¨**Handler**ä¸­æ²¡æœ‰å®ç°ä¸å®¢æˆ·ç«¯è¯·æ±‚æ–¹å¼åŒ¹é…çš„**å®ä¾‹æ–¹æ³•**ï¼Œæ­¤æ—¶å°†è°ƒç”¨```defaultHandler()```æ‰§è¡Œé»˜è®¤åå¤„ç†é€»è¾‘ã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::


- **```defaultHandler(req, res, next)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šå¯¹è¯·æ±‚æ–¹å¼ä¸ç¬¦åˆé¢„æœŸçš„å®¢æˆ·ç«¯è¯·æ±‚è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šå½“[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)ç»“æŸæ—¶ï¼Œå¦‚æœ**Handler**ä¸­æ²¡æœ‰å®ç°ä¸å®¢æˆ·ç«¯è¯·æ±‚æ–¹å¼åŒ¹é…çš„å®ä¾‹æ–¹æ³•æ—¶ï¼Œå°†è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘é»˜è®¤çš„[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

    ::: tip æç¤º
    æˆ‘ä»¬åœ¨æŒ‡å®šé»˜è®¤çš„[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)é€»è¾‘æ—¶ï¼Œé€šå¸¸ä¸ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œè€Œæ˜¯é€šè¿‡[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ§åˆ¶è¯·æ±‚å¤„ç†é“¾è·¯ã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::
  
  - **é»˜è®¤è¡Œä¸º**ï¼šç›´æ¥è°ƒç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)è§¦å‘[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)å‘å®¢æˆ·ç«¯è¿”å›404çŠ¶æ€ç ã€‚
    
    ```javascript
    defaultHandler(req, res, next) {
      next(404);
    }
    ```

### ç»Ÿä¸€å¤„ç†

- **```onFinish(data, req, res)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šå¯¹å®¢æˆ·ç«¯è¯·æ±‚å¤„ç†å®Œæˆåçš„é€»è¾‘è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šåœ¨ä»»æ„è¯·æ±‚å¤„ç†é˜¶æ®µä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ‰§è¡Œ```next(data)```æ—¶å°†è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚
    
    ::: tip æç¤º
    æˆ‘ä»¬åœ¨æŒ‡å®š[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)é€»è¾‘æ—¶ï¼Œé€šå¸¸åº”ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œå‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::
  
  - **é»˜è®¤è¡Œä¸º**ï¼šæ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œå‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœã€‚

    ```javascript
    onFinish(data, req, res) {
      // å½“è¯·æ±‚å·²è¿”å›æ—¶ä¸å†æ‰§è¡Œå®é™…é€»è¾‘
      if (this.isEnded) {
        return;
      }
      // å½“dataä¸ºnullæˆ–undefinedæ—¶ - è¿”å›204
      else if (isNullOrUndefined(data)) {
        res.status(204).end();
      }
      // å½“dataä¸ºNumberç±»å‹æ—¶ - dataä½œä¸ºçŠ¶æ€ç 
      else if (getType(data) === VALUE_TYPE_NUMBER) {
        res.status(data).end();
      }
      // å…¶ä»–æƒ…å†µ - dataä½œä¸ºåº”ç­”å†…å®¹
      else {
        res.status(200).send(data);
      }
    }
    ```

- **```onError(error, req, res)```**

  - **ä½¿ç”¨åœºæ™¯**ï¼šå¯¹å®¢æˆ·ç«¯è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¼‚å¸¸è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

  - **è°ƒç”¨æ—¶æœº**ï¼šåœ¨ä»»æ„è¯·æ±‚å¤„ç†é˜¶æ®µçš„è·Ÿå‡½æ•°ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œæˆ–ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ‰§è¡Œ```next(error)```æ—¶ï¼Œå°†è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

  - **æ³¨æ„äº‹é¡¹**ï¼šé‡å†™æ—¶æ— éœ€æ‰§è¡Œ```super```æ“ä½œï¼Œå½“æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å°†è§¦å‘**ServiceCore**ä¸­çš„[é”™è¯¯æ‹¦æˆªå™¨](/guide/web-service.html#é”™è¯¯æ‹¦æˆªå™¨)ã€‚

    ::: tip æç¤º
    æˆ‘ä»¬åœ¨æŒ‡å®š[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)é€»è¾‘æ—¶ï¼Œé€šå¸¸åº”ç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œå‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœã€‚

    å¦å¤–ï¼Œä¸ºäº†æ›´ç²¾ç¡®çš„æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­å¼‚å¸¸ï¼Œæˆ‘ä»¬åº”**æ ¹æ®é˜¶æ®µå†…å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥æŒ‡å®šæ­¤æ–¹æ³•ä¸º```Function```æˆ–```AsyncFunction```ã€‚**
    :::
  
  - **é»˜è®¤è¡Œä¸º**ï¼šæ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œå‘å®¢æˆ·ç«¯è¿”å›500çŠ¶æ€ç ã€‚

    ```javascript
    onError(error, req, res) {
      !this.isEnded && res.status(500).end();
    }
    ```

## å¤„ç†æµç¨‹

![Handlerå¤„ç†æµç¨‹](/images/Handlerå¤„ç†æµç¨‹.jpg)

## æµç¨‹æ§åˆ¶å‡½æ•°

**ServiceCore**è‡ªåŠ¨ä¸º**æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚**åˆ›å»ºä¸è¯·æ±‚è·¯å¾„å¯¹åº”çš„**Handlerå®ä¾‹**ï¼Œå¹¶è°ƒç”¨å…¶ç§æœ‰å®ä¾‹æ–¹æ³•```_onStart()```ä»¥å¯åŠ¨å¤„ç†æµç¨‹ã€‚

::: danger æ³¨æ„
Handlerçš„å®ä¾‹æ–¹æ³•```_onStart()```ä¸­å®ç°äº†å¤„ç†æµç¨‹æ§åˆ¶é€»è¾‘ã€‚**å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰Handleræ—¶ï¼Œä¸€å®šä¸è¦ä½¿ç”¨```_onStart```ä½œä¸ºå®ä¾‹æ–¹æ³•åã€‚**
:::

é€šå¸¸ï¼Œæˆ‘ä»¬ä»…åœ¨æŒ‡å®š[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)å’Œ[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)é˜¶æ®µç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œå…¶ä½™é˜¶æ®µä¸­ä½¿ç”¨```next```è¿›è¡Œæµç¨‹æ§åˆ¶ï¼š

- **æ‰§è¡Œ```next(data)```æ—¶**ï¼šè§¦å‘[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)ï¼Œ```data```å°†ä½œä¸ºå®ä¾‹æ–¹æ³•```onFinish()```å‚æ•°åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…¥å‚ã€‚

  ::: tip æç¤º
  **é»˜è®¤çš„[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)é€»è¾‘ä½¿æµç¨‹æ§åˆ¶å‡½æ•°æ”¯æŒå¤šç§è°ƒç”¨æ–¹å¼å‘å®¢æˆ·ç«¯è¿”å›è¯·æ±‚å¤„ç†ç»“æœï¼š**

  - **```next(message)```**ï¼š

    å½“**æµç¨‹æ§åˆ¶å‡½æ•°**æŒ‡å®šçš„```data```**ä¸ä¸º```Number```ç±»å‹ã€```null```å’Œ```undefined```æ—¶**ï¼Œè®¤ä¸ºæœŸæœ›å‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœæŠ¥æ–‡ã€‚
    
    æ­¤æ—¶ï¼Œå°†**å‘å®¢æˆ·ç«¯è¿”å›200çŠ¶æ€ç ï¼Œå¹¶å°†```data```ä½œä¸ºè¿”å›æŠ¥æ–‡ã€‚**

  - **```next(httpCode)```**ï¼š
  
    å½“**æµç¨‹æ§åˆ¶å‡½æ•°**æŒ‡å®šçš„```data```**ä¸º```Number```ç±»å‹æ—¶**ï¼Œè®¤ä¸ºæœŸæœ›å‘å®¢æˆ·ç«¯è¿”å›çŠ¶æ€ç ã€‚
    
    æ­¤æ—¶ï¼Œå°†**å‘å®¢æˆ·ç«¯è¿”å›```data```ä¸­æŒ‡å®šçš„çŠ¶æ€ç å’Œç©ºæŠ¥æ–‡ã€‚**

  - **```next()```ã€```next(null)```ã€```next(undefined)```**ï¼š
    
    > **ä»…åœ¨[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)é˜¶æ®µæ‰§è¡Œ```next()```æ—¶å‘½ä¸­æ­¤é€»è¾‘ï¼Œå…¶ä½™å¤„ç†é˜¶æ®µä¸­æ‰§è¡Œ```next()```å°†åˆ†å‘è‡³ä¸‹ä¸€å¤„ç†é˜¶æ®µã€‚**
    
    å½“**æµç¨‹æ§åˆ¶å‡½æ•°**æŒ‡å®šçš„```data```**ä¸º```null```æˆ–```undefined```æ—¶**ï¼Œè®¤ä¸ºæœŸæœ›å‘å®¢æˆ·ç«¯è¿”å›ç©ºæŠ¥æ–‡ã€‚

    æ­¤æ—¶ï¼Œå°†**å‘å®¢æˆ·ç«¯è¿”å›204çŠ¶æ€ç å’Œç©ºæŠ¥æ–‡ã€‚**

  **æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)é˜¶æ®µçš„é€»è¾‘ä»¥å®šåˆ¶æµç¨‹æ§åˆ¶å‡½æ•°å‘å®¢æˆ·ç«¯è¿”å›è¯·æ±‚å¤„ç†ç»“æœçš„æ–¹å¼ã€‚**
  :::

- **æ‰§è¡Œ```next(error)```æ—¶**ï¼šè§¦å‘[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ï¼Œ```error```å°†ä½œä¸ºå®ä¾‹æ–¹æ³•```onError()```å‚æ•°åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…¥å‚ã€‚

- **æ‰§è¡Œ```next()```ã€```next(null)```ã€```next(undefined)```æ—¶**ï¼šè¿›å…¥ä¸‹ä¸€å¤„ç†é˜¶æ®µã€‚

::: tip æç¤º
**Handlerçš„æµç¨‹æ§åˆ¶å‡½æ•°ä¸Expressçš„ä¸­é—´ä»¶åˆ†å‘å‡½æ•°æ‹¥æœ‰ä¸€è‡´çš„ä½¿ç”¨ä½“éªŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Handlerçš„ä¸­é—´ä»¶ç³»ç»Ÿç›´æ¥ä½¿ç”¨Expressçš„ä¸­é—´ä»¶ç”Ÿæ€ã€‚**

ä¸å¾—ä¸æçš„æ˜¯ï¼Œåœ¨**è‡ªå®šä¹‰Handler**æ—¶ï¼Œæˆ‘ä»¬**åº”æŒ‰ç…§Handlerå¤„ç†é˜¶æ®µå¯¹ä¸šåŠ¡é€»è¾‘è¿›è¡Œæ‹†åˆ†ä»¥å®ç°å„ä¸ªHOOKæ–¹æ³•ï¼Œå¹¶åœ¨æœŸæœ›é˜¶æ®µå¤„ç†ç»“æŸæ—¶ä½¿ç”¨```next()```åˆ†å‘å¤„ç†æµç¨‹ã€‚**

è™½ç„¶åœ¨å®ç°ä¸Šï¼Œ**Handler**ä½¿ç”¨**æ´‹è‘±åœˆæ¨¡å‹**ä¸²è”äº†æ¯ä¸ªè¯·æ±‚å¤„ç†é˜¶æ®µï¼Œç†è®ºä¸Šå¯ä»¥é€šè¿‡```await next()```è¿›è¡ŒäºŒæ¬¡ç©¿é€ã€‚
:::

## è®¾ç½®è¯·æ±‚è·¯å¾„

åœ¨[WebæœåŠ¡-è®¾ç½®è¯·æ±‚è·¯å¾„](/guide/web-service.html#è®¾ç½®è¯·æ±‚è·¯å¾„)ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•é€šè¿‡é‡å†™**Handler**çš„é™æ€æ–¹æ³•```getRoutePath()```ä»¥æŒ‡å®š**Handler**çš„è¯·æ±‚è·¯å¾„è§„åˆ™ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é‡ç‚¹è®¨è®ºæŒ‡å®š**è¯·æ±‚è·¯å¾„è§„åˆ™**æ—¶çš„æ³¨æ„äº‹é¡¹ï¼š

- **è¯·æ±‚è·¯å¾„è§„åˆ™å¿…é¡»ä¸ºéç©ºå­—ç¬¦ä¸²ã€‚**

  **ServiceCore**åœ¨æ‰§è¡Œ```bind()```æ—¶ï¼Œå°†å¯¹**Handler**ä¸­æŒ‡å®šçš„**è¯·æ±‚è·¯å¾„è§„åˆ™**è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸ºéå­—ç¬¦ä¸²å‹å€¼æˆ–ç©ºå­—ç¬¦ä¸²å°†è·³è¿‡å¯¹æ­¤**Handler**çš„æŒ‚è½½ã€‚

- **è¯·æ±‚è·¯å¾„è§„åˆ™**åº”å°½é‡ä½¿ç”¨```'/'```å¼€å¤´ã€‚

  **ServiceCore**åœ¨æ‰§è¡Œ```bind()```æ—¶ï¼Œè¿˜å°†å¯¹**Handler**ä¸­æŒ‡å®šçš„**è¯·æ±‚è·¯å¾„è§„åˆ™**è¿›è¡Œæ ¡æ­£ï¼Œå¦‚æœä¸ä»¥```'/'```å¼€å¤´æ—¶ï¼Œå°†è‡ªåŠ¨é™„åŠ ```'/'```ä½œä¸ºå‰ç¼€ã€‚

- **ä½¿ç”¨å‰ç¼€å‹è¯·æ±‚è·¯å¾„è§„åˆ™åœºæ™¯ä¸‹ï¼Œåœ¨ä¸šåŠ¡å±‚æ‰§è¡Œ```bind()```æ—¶ï¼Œåº”å°†æŒ‡å®šäº†æ›´é•¿è¯·æ±‚è·¯å¾„è§„åˆ™çš„Handleræ”¾ç½®äºç»‘å®šåˆ—è¡¨ä¸­è¾ƒå‰çš„ä½ç½®ã€‚**

  **ServiceCore**åŒ¹é…ä¸å®¢æˆ·ç«¯è¯·æ±‚å¯¹åº”çš„**Handler**æ—¶ï¼Œå°†æŒ‰ç…§æ‰§è¡Œ```bind()```æ—¶çš„æŒ‡å®šçš„**Handler**é¡ºåºä¾æ¬¡è¿›è¡Œã€‚
  
  ::: warning æ³¨æ„
  æ¯”å¦‚ï¼Œä¸šåŠ¡å±‚åœ¨æ‰§è¡Œ```bind()```æ—¶ä¾æ¬¡ç»‘å®šäº†ä¸¤ä¸ª**Handler**ï¼Œå…¶**è¯·æ±‚è·¯å¾„è§„åˆ™**åˆ†åˆ«ä¸º```'/api'```å’Œ```'/api/Test.do'```ã€‚

  æ­¤æ—¶å½“å®¢æˆ·ç«¯è¯·æ±‚è·¯å¾„ä¸º```/api/Test.do```æ—¶ï¼Œ**ServiceCore**å°†ä¼˜å…ˆåŒ¹é…åˆ°**è¯·æ±‚è·¯å¾„è§„åˆ™**ä¸º```/api```çš„**Handler**ç”¨äºæ­¤æ¬¡è¯·æ±‚å¤„ç†ã€‚

  å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨å‰ç¼€å‹**è¯·æ±‚è·¯å¾„è§„åˆ™**åœºæ™¯ä¸‹ï¼Œåº”åœ¨æ‰§è¡Œ```bind()```æ—¶å…³æ³¨ç»‘å®šåˆ—è¡¨ä¸­çš„**Handler**é¡ºåºã€‚
  :::

## åˆå§‹åŒ–å’Œææ„

**Handler**çš„åˆå§‹åŒ–å’Œææ„æ ‡å¿—ç€**Handler**ç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹å’Œç»“æŸï¼š

- å½“**ServiceCore**åˆ†å‘å®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥ä¸è¯·æ±‚è·¯å¾„åŒ¹é…çš„**Handler**æ—¶ï¼Œé¦–å…ˆå°†è§¦å‘[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)ã€‚
- åœ¨[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)è§¦å‘åï¼ˆ**éåˆå§‹åŒ–æ‰§è¡Œå®Œæˆå**ï¼‰ï¼Œå®¢æˆ·ç«¯è¯·æ±‚è¿”å›æ—¶å°†è§¦å‘[Handlerææ„](#handlerææ„)ã€‚

::: tip æç¤º
é€šå¸¸ï¼Œæˆ‘ä»¬ä»…åœ¨[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)å’Œ[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ä¸­æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ï¼Œå‘å®¢æˆ·ç«¯è¿”å›è¯·æ±‚å¤„ç†ç»“æœä»¥è§¦å‘[Handlerææ„](#handlerææ„)ã€‚

å½“ç„¶ä¹Ÿæœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚åœ¨**Handler**ä¸­ä½¿ç”¨**é™æ€èµ„æºä¸­é—´ä»¶```express.static```**ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚å‘½ä¸­é™æ€èµ„æºæ—¶å°†ç›´æ¥è¿”å›è¯¥èµ„æºï¼Œæ­¤æ—¶ä¹Ÿå°†è§¦å‘[Handlerææ„](#handlerææ„)ã€‚

æˆ‘ä»¬åº”åœ¨[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)ä¸[Handlerææ„](#handlerææ„)é˜¶æ®µæ‰§è¡Œ**ç›¸åçš„èµ„æºæ“ä½œ**ï¼Œä»¥ä½¿å†…å­˜å¾—åˆ°æœ‰æ•ˆé‡Šæ”¾ã€‚
:::

### Handleråˆå§‹åŒ–

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerçš„å®ä¾‹æ–¹æ³•```initHandler()```ä»¥æŒ‡å®šHandleråˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œçš„é€»è¾‘ã€‚**

å‡ºäºå¤ç”¨æ€§è€ƒè™‘ï¼Œæ¨èåœ¨**Handleråˆå§‹åŒ–**é˜¶æ®µæ‰§è¡Œä¸€äº›**ä¸ä¸šåŠ¡æ— å…³çš„é€šç”¨åˆå§‹åŒ–é€»è¾‘**ï¼Œæ¯”å¦‚ï¼š**åˆ›å»ºæ—¥å¿—è¾“å‡ºå™¨**ã€**è¯»å–å…¨å±€é…ç½®**ç­‰ï¼›**ä¸ä¸šåŠ¡ç›¸å…³çš„åˆå§‹åŒ–é€»è¾‘**æ¨èæ”¾å…¥[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)é˜¶æ®µä¸­ã€‚

::: tip æç¤º
é€šå¸¸ï¼Œæˆ‘ä»¬å°†**Handleråˆå§‹åŒ–**é˜¶æ®µä¸­åˆ›å»ºçš„èµ„æºæå‡ä¸º**å®ä¾‹å±æ€§**ï¼Œä»¥åœ¨å„ä¸ªè¯·æ±‚å¤„ç†é˜¶æ®µä¸­å…±äº«ï¼š

```javascript
initHandler(req, res, next) {
  // åˆ›å»ºåŸºç¡€è¾“å‡ºå™¨å¹¶æå‡ä¸ºå®ä¾‹å±æ€§
  this.logger = new Core.BaseLogger();
  // åˆ†å‘è‡³ä¸‹ä¸€å¤„ç†é˜¶æ®µ
  next();
}
```
:::

**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶å°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```initHandler```ç»´åº¦**ã€‚å³ï¼šå½“```initHandler```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®Handleråˆå§‹åŒ–é˜¶æ®µä¸­å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```initHandler```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**Handleråˆå§‹åŒ–**é€»è¾‘ä¸­åŒ…å«**å¼‚æ­¥ä»»åŠ¡**æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

å½“ç„¶ï¼Œä¸è¦å¿˜è®°åœ¨**Handleråˆå§‹åŒ–**é˜¶æ®µç»“æŸæ—¶ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)åˆ†å‘å¤„ç†æµç¨‹è‡³ä¸‹ä¸€é˜¶æ®µã€‚

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªåœ¨å¤„ç†è¯·æ±‚æ—¶æ‰“å°è¯·æ±‚å¤„ç†å¼€å§‹æ—¶é—´çš„Handlerã€‚**

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äº**æ¨¡æ‹Ÿè€—æ—¶åŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡**çš„```BaseHandler```ä½œä¸ºåŸºç±»ï¼š

```javascript
class BaseHandler extends Core.Handler {
  // å¼‚æ­¥è€—æ—¶ä»»åŠ¡
  asyncTask(duration = 0) {
    return new Promise((resolve) => {
      setTimeout(() => resolve(), duration);
    });
  }

  // åŒæ­¥è€—æ—¶ä»»åŠ¡
  syncTask(duration = 0) {
    const startDate = new Date();
    while (true) {
      if (((new Date()) - startDate) > duration) {
        break;
      }
    }
  }
}
```

æ¥ä¸‹æ¥ï¼ŒåŸºäº```BaseHandler```å®ç°åœ¨è¯·æ±‚å¤„ç†æ—¶æ‰“å°å¼€å§‹æ—¶é—´çš„**è‡ªå®šä¹‰Handler**ï¼š

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„Handleråˆå§‹åŒ–é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```initHandler```ï¼š**

```javascript
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  initHandler(req, res, next) {
    // è®°å½•è¯·æ±‚æ—¶é—´
    this.startDate = new Date();
    // åˆ›å»ºæ—¥å¿—è¾“å‡ºå™¨å¹¶æ‰“å°æ—¥å¿—
    this.logger = new Core.BaseLogger();
    this.logger.log(`è¯·æ±‚å¤„ç†å¼€å§‹æ—¶é—´:[${this.startDate.toLocaleString()}]`);
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    next();
  }
}
```

åŒæ ·ï¼Œ**å½“Handleråˆå§‹åŒ–é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```initHandler```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {6,12-13}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  async initHandler(req, res, next) {
    // è®°å½•è¯·æ±‚æ—¶é—´
    this.startDate = new Date();
    // åˆ›å»ºæ—¥å¿—è¾“å‡ºå™¨å¹¶æ‰“å°æ—¥å¿—
    this.logger = new Core.BaseLogger();
    this.logger.log(`è¯·æ±‚å¤„ç†å¼€å§‹æ—¶é—´:[${this.startDate.toLocaleString()}]`);
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    next();
  }
}
```

æœ€åï¼Œæˆ‘ä»¬å°†**è‡ªå®šä¹‰Handler**æŒ‚è½½è‡³**ServiceCore**å¹¶å¯åŠ¨æœåŠ¡ï¼š

```javascript
const serviceCore = new Core.ServiceCore();
serviceCore.bind([Handler]);
serviceCore.start();
```

**æœ€åçš„æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do -w 'res -> %{http_code}\n'```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- æœåŠ¡ç«¯æ§åˆ¶å°å°†äºæ”¶åˆ°è¯·æ±‚æ—¶æ‰“å°**è¯·æ±‚å¼€å§‹å¤„ç†æ—¶é—´**çš„ç›¸å…³æ—¥å¿—ã€‚

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**1000ms**æ”¶åˆ°**ServiceCore**è¿”å›çš„404çŠ¶æ€ç ã€‚

### Handlerææ„

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerçš„å®ä¾‹æ–¹æ³•```destroyHandler()```ä»¥æŒ‡å®šHandlerææ„é˜¶æ®µæ‰§è¡Œçš„é€»è¾‘ã€‚**

::: danger æ³¨æ„
**è¿›å…¥Handlerææ„é˜¶æ®µæ—¶ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å·²è¿”å›å¤„ç†ç»“æœã€‚**

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨**Handlerææ„**é˜¶æ®µä»…å…è®¸å¯¹**å®¢æˆ·ç«¯è¯·æ±‚å®ä¾‹**```req```å’Œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹**```res```å‘èµ·è¯»å–åŠ¨ä½œã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨**Handlerææ„**é˜¶æ®µé‡Šæ”¾å¯¹[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)é˜¶æ®µåˆ›å»ºèµ„æºçš„å¼•ç”¨ã€‚
:::

å½“ç„¶ï¼Œä¸è¦å¿˜è®°åœ¨**Handleråˆå§‹åŒ–**é˜¶æ®µç»“æŸæ—¶ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)åˆ†å‘å¤„ç†æµç¨‹è‡³ä¸‹ä¸€é˜¶æ®µã€‚

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```destroyHandler```ç»´åº¦**ã€‚å³ï¼šå½“```destroyHandler```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®Handlerææ„é˜¶æ®µä¸­å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```destroyHandler```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**Handlerææ„**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

**Handlerææ„**é˜¶æ®µæ ‡å¿—ç€**Handlerç”Ÿå‘½å‘¨æœŸ**çš„ç»ˆç»“ï¼Œå…¶ä¸­æ— æ³•ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)ã€‚

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®Œå–„Handleråˆå§‹åŒ–é˜¶æ®µä¸­çš„ğŸŒ°ï¼Œä½¿å…¶åœ¨è¯·æ±‚å¤„ç†ç»“æŸæ—¶æ‰§è¡Œä»»åŠ¡å¹¶æ‰“å°å¤„ç†è€—æ—¶ã€‚**

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„Handlerææ„é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```destroyHandler```ï¼š**

```javascript {17-25}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  initHandler(req, res, next) {
    // è®°å½•è¯·æ±‚æ—¶é—´
    this.startDate = new Date();
    // åˆ›å»ºæ—¥å¿—è¾“å‡ºå™¨å¹¶æ‰“å°æ—¥å¿—
    this.logger = new Core.BaseLogger();
    this.logger.log(`è¯·æ±‚å¤„ç†å¼€å§‹æ—¶é—´:[${this.startDate.toLocaleString()}]`);
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    next();
  }

  destroyHandler(req, res) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    // è®¡ç®—å¹¶æ‰“å°æ—¥å¿—
    const duration = (new Date()) - this.startDate;
    this.logger.log(`è¯·æ±‚å¤„ç†è€—æ—¶[${duration}]ms`);
    // å…³é—­æ—¥å¿—è¾“å‡ºå™¨
    this.logger.close();
  }
}
```

åŒæ ·ï¼Œ**å½“Handlerææ„é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```destroyHandler```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {17-25}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  async initHandler(req, res, next) {
    // è®°å½•è¯·æ±‚æ—¶é—´
    this.startDate = new Date();
    // åˆ›å»ºæ—¥å¿—è¾“å‡ºå™¨å¹¶æ‰“å°æ—¥å¿—
    this.logger = new Core.BaseLogger();
    this.logger.log(`è¯·æ±‚å¤„ç†å¼€å§‹æ—¶é—´:[${this.startDate.toLocaleString()}]`);
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    next();
  }

  async destroyHandler(req, res) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    // è®¡ç®—å¹¶æ‰“å°æ—¥å¿—
    const duration = (new Date()) - this.startDate;
    this.logger.log(`è¯·æ±‚å¤„ç†è€—æ—¶[${duration}]ms`);
    // å…³é—­æ—¥å¿—è¾“å‡ºå™¨
    this.logger.close();
  }
}
```

**æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do -w 'res -> %{http_code}\n'```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- æœåŠ¡ç«¯æ§åˆ¶å°å°†äºæ”¶åˆ°è¯·æ±‚æ—¶æ‰“å°**è¯·æ±‚å¼€å§‹å¤„ç†æ—¶é—´**çš„ç›¸å…³æ—¥å¿—ã€‚

- æœåŠ¡ç«¯æ§åˆ¶å°å°†äºæ”¶åˆ°è¯·æ±‚åçº¦**2000ms**æ‰“å°**è¯·æ±‚å¤„ç†æ—¶é•¿**çš„ç›¸å…³æ—¥å¿—ã€‚

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**1000ms**æ”¶åˆ°**ServiceCore**è¿”å›çš„404çŠ¶æ€ç ã€‚

## ä¸­é—´ä»¶ç³»ç»Ÿ

**Handlerä½¿ç”¨çš„ä¸­é—´ä»¶ç³»ç»Ÿå…¼å®¹Expressç”Ÿæ€ï¼Œä¸”æ”¯æŒåŠ¨æ€ä¸­é—´ä»¶**ã€‚

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerçš„å®ä¾‹æ–¹æ³•```getMiddlewares```ä»¥æŒ‡å®šå…¶åº”ç”¨äºå®¢æˆ·ç«¯è¯·æ±‚çš„ä¸­é—´ä»¶åˆ—è¡¨ã€‚**

::: tip æç¤º
åœ¨[Handleråˆå§‹åŒ–](#handleråˆå§‹åŒ–)é˜¶æ®µå®Œæˆåï¼Œ**Handler**å°†æ„å»ºå¹¶æ‰§è¡Œ**ä¸­é—´ä»¶åˆ—è¡¨**ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š**Handlerç»´åº¦æŒ‡å®šçš„ä¸­é—´ä»¶å°†ä»…ä½œç”¨äºåŒ¹é…Handlerè¯·æ±‚è·¯å¾„è§„åˆ™çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚**
:::

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```getMiddlewares```ç»´åº¦**ã€‚å³ï¼šå½“```getMiddlewares```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®æ„å»ºä¸­é—´ä»¶åˆ—è¡¨æ—¶å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```getMiddlewares```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**æ„å»ºä¸­é—´ä»¶åˆ—è¡¨**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

æ„å»º**ä¸­é—´ä»¶åˆ—è¡¨**æ—¶æ— éœ€ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ§åˆ¶å¤„ç†æµç¨‹ï¼Œä½¿ç”¨```return```å…³é”®å­—è¿”å›åº”ç”¨äºå®¢æˆ·ç«¯è¯·æ±‚å¤„ç†çš„**ä¸­é—´ä»¶åˆ—è¡¨**å³å¯ã€‚

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­åŠ¨æ€æŒ‡å®šä¸­é—´ä»¶åˆ—è¡¨çš„Handlerã€‚**

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äº**æ¨¡æ‹Ÿè€—æ—¶åŒæ­¥ã€å¼‚æ­¥ä»»åŠ¡å’Œåˆ›å»ºä¸­é—´ä»¶**çš„```BaseHandler```ä½œä¸ºåŸºç±»ï¼š

```javascript
class BaseHandler extends Core.Handler {
  // å¼‚æ­¥ä»»åŠ¡
  asyncTask(duration = 0) {
    return new Promise((resolve) => {
      setTimeout(() => resolve(), duration);
    });
  }

  // åŒæ­¥ä»»åŠ¡
  syncTask(duration = 0) {
    const startDate = new Date();
    while (true) {
      if (((new Date()) - startDate) > duration) {
        break;
      }
    }
  }

  // åˆ›å»ºä¸­é—´ä»¶
  createMiddleware(value) {
    // å°†åœ¨res.headerä¸­è‡ªåŠ¨è®°å½•åº”ç”¨äºè¯·æ±‚å¤„ç†çš„ä¸­é—´ä»¶
    return (req, res, next) => {
      const middlewareFieldKey = 'x-middlewares';
      const middlewareFieldValue = res.get(middlewareFieldKey);
      const middlewareList = middlewareFieldValue ? middlewareFieldValue.split(',') : [];
      middlewareList.push(`middleware_${value}`);
      res.set(middlewareFieldKey, middlewareList.join(','));
      next();
    }
  }
}
```

æ¥ä¸‹æ¥ï¼ŒåŸºäº```BaseHandler```å®ç°æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚å…¥å‚åŠ¨æ€æŒ‡å®šä¸­é—´ä»¶åˆ—è¡¨çš„**è‡ªå®šä¹‰Handler**ï¼š

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„æ„å»ºä¸­é—´ä»¶åˆ—è¡¨é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```getMiddlewares```ï¼š**

```javascript
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }
  
  getMiddlewares(req, res) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    // æ„å»ºä¸­é—´ä»¶åˆ—è¡¨
    const middlewares = [];
    const { count = 0 } = req.query;
    for (let i = 1; i < parseInt(count) + 1; i++) {
      middlewares.push(this.createMiddleware(i));
    }
    return middlewares;
  }
}
```

åŒæ ·ï¼Œ**å½“æ„å»ºä¸­é—´ä»¶åˆ—è¡¨é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```getMiddlewares```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {6-8}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }
  
  async getMiddlewares(req, res) {
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    // æ„å»ºä¸­é—´ä»¶åˆ—è¡¨
    const middlewares = [];
    const { count = 0 } = req.query;
    for (let i = 1; i < parseInt(count) + 1; i++) {
      middlewares.push(this.createMiddleware(i));
    }
    return middlewares;
  }
}
```

æœ€åï¼Œæˆ‘ä»¬å°†**è‡ªå®šä¹‰Handler**æŒ‚è½½è‡³**ServiceCore**å¹¶å¯åŠ¨æœåŠ¡ï¼š

```javascript
const serviceCore = new Core.ServiceCore();
serviceCore.bind([Handler]);
serviceCore.start();
```

**æœ€åçš„æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do\?count\=5 -D -```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**1000ms**æ‰“å°è¯·æ±‚å¤„ç†ç»“æœã€‚

- å®¢æˆ·ç«¯æ”¶åˆ°çš„è¯·æ±‚å¤„ç†ç»“æœä¸­```res.header['x-middlewares']```å†…**è®°å½•äº†5ä¸ªä¸­é—´ä»¶çš„ä¿¡æ¯**ã€‚

### ä¸­é—´ä»¶æ‹¦æˆª

**Handleræ„å»ºä¸­é—´ä»¶åˆ—è¡¨å®Œæˆåï¼Œå°†é€ä¸ªåˆ†å‘å…¶ä¸­çš„ä¸­é—´ä»¶ã€‚**

**æˆ‘ä»¬é€šè¿‡é‡å†™å®ä¾‹æ–¹æ³•```onInterceptMiddleware```ä»¥æ‹¦æˆªæ¯ä¸ªä¸­é—´ä»¶çš„åˆ†å‘ä»¥åŠ¨æ€æ§åˆ¶å…¶æ‰§è¡Œè¡Œä¸ºã€‚**

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```onInterceptMiddleware```ç»´åº¦**ã€‚å³ï¼šå½“```onInterceptMiddleware```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®ä¸­é—´ä»¶æ‹¦æˆªæ—¶å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```onInterceptMiddleware```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**ä¸­é—´ä»¶æ‹¦æˆª**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

**Handler**å°†è‡ªåŠ¨åŒ…è£…**å½“å‰åˆ†å‘çš„ä¸­é—´ä»¶**å’Œ**ä¸­é—´ä»¶æ‰§è¡Œå‡½æ•°**ä½œä¸º```onInterceptMiddleware```å‚æ•°åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå‚æ•°```middleware```ï¼š

- **```middleware.type```**ï¼šä¸­é—´ä»¶æœ¬ä½“å‡½æ•°ï¼Œç”¨äºè¿›è¡Œä¸­é—´ä»¶æ ‡è¯†æ ¡éªŒã€‚

- **```middleware.exec```**ï¼šä¸­é—´ä»¶æ‰§è¡Œå‡½æ•°ï¼Œç”¨äºå®é™…æ‰§è¡Œä¸­é—´ä»¶ï¼Œå…¶å‚æ•°åˆ—è¡¨ä¸º```(callBack)```ã€‚
  
  ::: tip æç¤º
  **```middleware.exec(callBack)```å®é™…ä¸Šæ˜¯```middleware.type(req, res, callBack)```çš„è¯­æ³•ç³–ï¼Œä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å¼‚å¸¸å°†é€šè¿‡```callBack```å›æŠ›ã€‚**

  **æˆ‘ä»¬å¯ä»¥é€šè¿‡```require('util').promisify```åŒ…è£…```middleware.exec```ï¼Œå¹¶ä½¿ç”¨```await```å…³é”®å­—è°ƒç”¨**ï¼Œä»¥ä¿è¯åœ¨```AsyncFuntion```ç±»å‹çš„```onInterceptMiddleware```ä¸­çš„é€»è¾‘ä¸€è‡´æ€§ã€‚
  :::

å½“ç„¶ï¼Œåœ¨å¯¹ä¸­é—´ä»¶è¿›è¡Œæ‹¦æˆªå¤„ç†åï¼Œä¸è¦å¿˜è®°ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)åˆ†å‘å¤„ç†æµç¨‹è‡³ä¸‹ä¸€é˜¶æ®µã€‚

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®Œå–„æ„å»ºä¸­é—´ä»¶åˆ—è¡¨æ—¶çš„ğŸŒ°ï¼Œä»¥50%çš„æ¦‚ç‡éšæœºæ‰§è¡Œä¸­é—´ä»¶åˆ—è¡¨ä¸­çš„ä¸­é—´ä»¶ã€‚**

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„ä¸­é—´ä»¶æ‹¦æˆªé€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```onInterceptMiddleware```ï¼š**

```javascript {18-25}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }
  
  getMiddlewares(req, res) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    // æ„å»ºä¸­é—´ä»¶åˆ—è¡¨
    const middlewares = [];
    const { count = 0 } = req.query;
    for (let i = 1; i < parseInt(count) + 1; i++) {
      middlewares.push(this.createMiddleware(i));
    }
    return middlewares;
  }

  onInterceptMiddleware(middleware, req, res, next) {
    // æ¯ä¸ªä¸­é—´ä»¶éƒ½æ‰§è¡Œ500msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(500);
    // è®¡ç®—æ¦‚ç‡å¹¶åº”ç”¨è‡³æ‰§è¡Œé“¾è·¯
    const { exec } = middleware;
    const canExec = Math.random() >= 0.5;
    canExec ? exec((result) => next(result)) : next();
  }
}
```

åŒæ ·ï¼Œ**å½“æ„ä¸­é—´ä»¶æ‹¦æˆªé€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```onInterceptMiddleware```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {20-29}
const { promisify } = require('util');

class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  async getMiddlewares(req, res) {
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    // æ„å»ºä¸­é—´ä»¶åˆ—è¡¨
    const middlewares = [];
    const { count = 0 } = req.query;
    for (let i = 1; i < parseInt(count) + 1; i++) {
      middlewares.push(this.createMiddleware(i));
    }
    return middlewares;
  }

  async onInterceptMiddleware(middleware, req, res, next) {
    // æ¯ä¸ªä¸­é—´ä»¶éƒ½æ‰§è¡Œ500msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(500);
    // è®¡ç®—æ¦‚ç‡å¹¶åº”ç”¨è‡³æ‰§è¡Œé“¾è·¯
    const { exec } = middleware;
    const canExec = Math.random() >= 0.5;
    canExec
      ? next(await promisify(exec)())
      : next();
  }
}
```

**æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do\?count\=5 -D -```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**3500ms**æ‰“å°è¯·æ±‚å¤„ç†ç»“æœã€‚

- å®¢æˆ·ç«¯æ”¶åˆ°çš„è¯·æ±‚å¤„ç†ç»“æœä¸­```res.header['x-middlewares']```å†…**éšæœºè®°å½•äº†0-5ä¸ªä¸­é—´ä»¶çš„ä¿¡æ¯**ã€‚

## è¯·æ±‚é¢„å¤„ç†

**Handler**ç»´åº¦çš„**ä¸­é—´ä»¶åˆ—è¡¨**å†…æœ€åä¸€ä¸ªä¸­é—´ä»¶çš„æ‹¦æˆªé€»è¾‘æ‰§è¡Œå®Œæˆåï¼Œå°†è¿›å…¥**è¯·æ±‚é¢„å¤„ç†**é˜¶æ®µã€‚

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerçš„å®ä¾‹æ–¹æ³•```preHandler()```ä»¥æŒ‡å®šè¯·æ±‚é¢„å¤„ç†é˜¶æ®µæ‰§è¡Œçš„é€»è¾‘ã€‚**

::: tip æç¤º
**é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨è¯·æ±‚é¢„å¤„ç†é˜¶æ®µæ‰§è¡Œå®é™…ä¸šåŠ¡å¤„ç†å‰çš„å‡†å¤‡åŠ¨ä½œã€‚**

æ¯”å¦‚ï¼Œåœ¨å®ç°æ”¯æŒå®¢æˆ·ç«¯ä½¿ç”¨å¤šç§è¯·æ±‚æ–¹å¼çš„**è‡ªå®šä¹‰Handler**æ—¶ï¼Œå¯ä»¥åœ¨**è¯·æ±‚é¢„å¤„ç†**é˜¶æ®µå¯¹ä¸åŒè¯·æ±‚æ–¹å¼å¸¦å…¥çš„å‚æ•°è¿›è¡Œå½’å¹¶ç»Ÿä¸€ã€‚

æˆ–æ˜¯**æå‰åˆ›å»ºè¯·æ±‚å¤„ç†æ‰€éœ€çš„åŸºç¡€èµ„æº**ã€‚

> **æˆ‘ä»¬é€šå¸¸åœ¨[è¯·æ±‚åå¤„ç†](#è¯·æ±‚åå¤„ç†)é˜¶æ®µå¯¹è¯·æ±‚å‚æ•°è¿›è¡Œæœ‰æ•ˆæ€§æ ¡éªŒå¹¶é©³å›å‚æ•°æ— æ•ˆçš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚å› æ­¤ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œæˆ‘ä»¬åº”åœ¨è¯·æ±‚é¢„å¤„ç†é˜¶æ®µåˆ›å»ºä¸å®¢æˆ·ç«¯è¯·æ±‚ç±»å‹æ— å…³çš„åŸºç¡€èµ„æºã€‚**

:::

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```preHandler```ç»´åº¦**ã€‚å³ï¼šå½“```preHandler```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®è¯·æ±‚é¢„å¤„ç†ä¸­å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```preHandler```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**è¯·æ±‚é¢„å¤„ç†**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

å½“ç„¶ï¼Œä¸è¦å¿˜è®°åœ¨**è¯·æ±‚é¢„å¤„ç†**é˜¶æ®µç»“æŸæ—¶ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)åˆ†å‘å¤„ç†æµç¨‹è‡³ä¸‹ä¸€é˜¶æ®µã€‚

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªåœ¨é¢„å¤„ç†é˜¶æ®µå½’å¹¶è¯·æ±‚å‚æ•°å¹¶å‘å®¢æˆ·ç«¯è¿”å›çš„Handlerã€‚**

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äº**æ¨¡æ‹Ÿè€—æ—¶åŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡**çš„```BaseHandler```ä½œä¸ºåŸºç±»ï¼š

```javascript
class BaseHandler extends Core.Handler {
  // å¼‚æ­¥è€—æ—¶ä»»åŠ¡
  asyncTask(duration = 0) {
    return new Promise((resolve) => {
      setTimeout(() => resolve(), duration);
    });
  }

  // åŒæ­¥è€—æ—¶ä»»åŠ¡
  syncTask(duration = 0) {
    const startDate = new Date();
    while (true) {
      if (((new Date()) - startDate) > duration) {
        break;
      }
    }
  }
}
```

æ¥ä¸‹æ¥ï¼ŒåŸºäº```BaseHandler```å®ç°è‡ªåŠ¨å½’å¹¶**GETæ–¹å¼**å’Œ**POSTæ–¹å¼**ä¸­å®¢æˆ·ç«¯é™„åŠ è‡³```query```å’Œ```body```ä¸­å‚æ•°çš„**è‡ªå®šä¹‰Handler**ï¼š

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„è¯·æ±‚é¢„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```preHandler```ï¼š**

```javascript
const bodyParser = require('body-parser');
const jsonParserMiddleware = bodyParser.json({ limit: 2 * 1024 * 1024 });
const qsParserMiddleware = bodyParser.urlencoded({ limit: 2 * 1024 * 1024, extended: true });

class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  getMiddlewares() {
    // æŒ‚è½½è§£æHTTP BODYçš„ä¸­é—´ä»¶
    return [jsonParserMiddleware, qsParserMiddleware];
  }

  preHandler(req, res, next) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    // åˆå¹¶queryå’Œbody
    const body = req.body;
    const query = req.query;
    req.requestParams = Object.assign({}, body, query);
    // å‘å®¢æˆ·ç«¯è¿”å›
    next(req.requestParams);
  }
}
```

åŒæ ·ï¼Œ**å½“è¯·æ±‚é¢„å¤„ç†é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```preHandler```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {15-17}
const bodyParser = require('body-parser');
const jsonParserMiddleware = bodyParser.json({ limit: 2 * 1024 * 1024 });
const qsParserMiddleware = bodyParser.urlencoded({ limit: 2 * 1024 * 1024, extended: true });

class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  getMiddlewares() {
    // æŒ‚è½½è§£æHTTP BODYçš„ä¸­é—´ä»¶
    return [jsonParserMiddleware, qsParserMiddleware];
  }

  async preHandler(req, res, next) {
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    // åˆå¹¶queryå’Œbody
    const body = req.body;
    const query = req.query;
    req.requestParams = Object.assign({}, body, query);
    // å‘å®¢æˆ·ç«¯è¿”å›
    next(req.requestParams);
  }
}
```

æœ€åï¼Œæˆ‘ä»¬å°†**è‡ªå®šä¹‰Handler**æŒ‚è½½è‡³**ServiceCore**å¹¶å¯åŠ¨æœåŠ¡ï¼š

```javascript
const serviceCore = new Core.ServiceCore();
serviceCore.bind([Handler]);
serviceCore.start();
```

**æœ€åçš„æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do\?queryKey1\=queryValue1\&queryKey2\=queryValue2 -d 'bodyKey1=bodyValue1&bodyKey2=bodyValue2'```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**1000ms**æ‰“å°è¯·æ±‚å¤„ç†ç»“æœã€‚

- å®¢æˆ·ç«¯æ”¶åˆ°çš„è¯·æ±‚å¤„ç†ç»“æœä¸­å°†**åŒ…å«```query```å’Œ```body```ä¸­é™„å¸¦çš„å‚æ•°**ã€‚

## è¯·æ±‚åå¤„ç†

åœ¨[è¯·æ±‚é¢„å¤„ç†](#è¯·æ±‚é¢„å¤„ç†)é˜¶æ®µä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)åˆ†å‘è‡³ä¸‹ä¸€å¤„ç†é˜¶æ®µæ—¶ï¼Œ**Handler**å°†å°è¯•è°ƒç”¨**ä¸å®¢æˆ·ç«¯è¯·æ±‚æ–¹å¼åŒ¹é…çš„å®ä¾‹æ–¹æ³•**è¿›å…¥**è¯·æ±‚åå¤„ç†**é˜¶æ®µã€‚

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerä¸­ä¸è¯·æ±‚æ–¹å¼å¯¹åº”çš„å®ä¾‹æ–¹æ³•ä»¥æŒ‡å®šå…¶è¯·æ±‚åå¤„ç†é€»è¾‘**ã€‚æ¯”å¦‚ï¼Œå®ç°å®ä¾‹æ–¹æ³•```postHandler```å°†æŒ‡å®šå®¢æˆ·ç«¯POSTè¯·æ±‚å¯¹åº”çš„åå¤„ç†é€»è¾‘ã€‚

::: tip æç¤º
**åœ¨è¿›å…¥è¯·æ±‚åå¤„ç†é˜¶æ®µæ—¶ï¼Œå¦‚æœHandlerä¸­æ²¡æœ‰å®ç°ä¸è¯·æ±‚æ–¹å¼å¯¹åº”çš„å®ä¾‹æ–¹æ³•ï¼Œé»˜è®¤ä½¿ç”¨```defaultHandler```ä½œä¸ºåå¤„ç†é€»è¾‘ã€‚**

é»˜è®¤çš„```defaultHandler```é€»è¾‘ä¸­ï¼Œå°†ç›´æ¥ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ‰§è¡Œ```next(404)```å‘å®¢æˆ·ç«¯è¿”å›404çŠ¶æ€ç ã€‚
:::

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨```[METHOD]Handler```ç»´åº¦**ã€‚å³ï¼š**å…¨éƒ¨è¯·æ±‚æ–¹å¼å¯¹åº”çš„å®ä¾‹æ–¹æ³•**å’Œ```defaultHandler```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®è¯·æ±‚åå¤„ç†ä¸­å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```[METHOD]Handler```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**è¯·æ±‚åå¤„ç†**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

> **é€šå¸¸ï¼Œåœ¨è¯·æ±‚åå¤„ç†é˜¶æ®µé¦–å…ˆåº”å¯¹å®¢æˆ·ç«¯é™„å¸¦çš„å‚æ•°è¿›è¡Œæœ‰æ•ˆæ€§åˆ¤æ–­ï¼Œé©³å›å‚æ•°æ— æ•ˆçš„å®¢æˆ·ç«¯è¯·æ±‚ï¼›åœ¨è¯·æ±‚å‚æ•°æœ‰æ•ˆæ—¶ï¼Œè§¦å‘å®é™…çš„ä¸šåŠ¡å¤„ç†ã€‚**

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯·æ±‚åå¤„ç†é˜¶æ®µä¸ºè¯·æ±‚å¤„ç†é“¾è·¯çš„æœ«ç«¯èŠ‚ç‚¹ï¼Œé€šå¸¸åº”ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)å‘å®¢æˆ·ç«¯å‘èµ·åº”ç­”åŠ¨ä½œ**ã€‚å¦å¤–ï¼Œåœ¨**è¯·æ±‚åå¤„ç†**é˜¶æ®µæ‰§è¡Œ```next()```æ—¶ä¸ä¼šç»§ç»­åˆ†å‘å¤„ç†æµç¨‹è‡³ä¸‹ä¸€é˜¶æ®µï¼Œè€Œæ˜¯è¿›å…¥[ç»Ÿä¸€å®Œæˆå¤„ç†](#ç»Ÿä¸€å®Œæˆå¤„ç†)ã€‚

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªæ”¯æŒå®¢æˆ·ç«¯é€šè¿‡POSTè¯·æ±‚è¯»å–æœ¬åœ°æŒ‡å®šç›®å½•çš„Handlerã€‚**

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„è¯·æ±‚åå¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```postHandler```ï¼š**

```javascript
const fs = require('fs');

class Handler extends Core.Handler {
  static getRoutePath() {
    return '/Test.do';
  }

  postHandler(req, res, next) {
    const { path } = req.query;
    try {
      // åŒæ­¥è¯»å–ç›®å½•å†…å®¹å¹¶å‘å®¢æˆ·ç«¯è¿”å›ç»“æœ
      const result = fs.readdirSync(path);
      next(result);
    } catch (error) {
      // æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å‘å®¢æˆ·ç«¯è¿”å›å¼‚å¸¸ä¿¡æ¯
      next(error.message);
    }
  }
}
```

åŒæ ·ï¼Œ**å½“è¯·æ±‚åå¤„ç†é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```postHandler```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {9-17}
const fs = require('fs');
const { promisify } = require('util');

class Handler extends Core.Handler {
  static getRoutePath() {
    return '/Test.do';
  }

  async postHandler(req, res, next) {
    const { path } = req.query;
    // å¼‚æ­¥è¯»å–ç›®å½•å†…å®¹å¹¶å‘å®¢æˆ·ç«¯è¿”å›ç»“æœ
    const result = await promisify(fs.readdir)(path).catch((error) => {
      // æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å‘å®¢æˆ·ç«¯è¿”å›å¼‚å¸¸ä¿¡æ¯
      next(error.message);
    });
    result && next(result);
  }
}
```

æœ€åï¼Œæˆ‘ä»¬å°†**è‡ªå®šä¹‰Handler**æŒ‚è½½è‡³**ServiceCore**å¹¶å¯åŠ¨æœåŠ¡ï¼š

```javascript
const serviceCore = new Core.ServiceCore();
serviceCore.bind([Handler]);
serviceCore.start();
```

**æœ€åçš„æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do\?path\=[æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„]```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- å½“æŒ‡å®šçš„**æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„**å­˜åœ¨æ—¶ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„å¤„ç†ç»“æœä¸º**æœ¬åœ°ç›®å½•ä¸­çš„å†…å®¹**ã€‚

- å½“æœªæŒ‡å®š**æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„**æˆ–**æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„**ä¸å­˜åœ¨æ—¶ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„å¤„ç†ç»“æœä¸º**å¼‚å¸¸åŸå› **ã€‚

::: warning æ³¨æ„
**æ ·ä¾‹ä»£ç ä¸­ä½¿ç”¨çš„å¼‚å¸¸å¤„ç†æ–¹å¼ä¸æ¨èåœ¨å®é™…ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨**ã€‚å¯¹äºå¦‚ä½•ä¼˜é›…çš„å¤„ç†å¼‚å¸¸ï¼Œæˆ‘ä»¬å°†åœ¨[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ä¸­è¿›è¡Œè¯¦ç»†è®¨è®ºã€‚
:::

## ç»Ÿä¸€å®Œæˆå¤„ç†

åœ¨**ä»»æ„è¯·æ±‚å¤„ç†é˜¶æ®µ**ä¸­ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ‰§è¡Œ```next(data)```æ—¶å°†è§¦å‘**ç»Ÿä¸€å®Œæˆå¤„ç†**ã€‚

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerçš„å®ä¾‹æ–¹æ³•```onFinish()```ä»¥æŒ‡å®šç»Ÿä¸€å®Œæˆå¤„ç†é˜¶æ®µæ‰§è¡Œçš„é€»è¾‘ã€‚**

::: tip è¯´æ˜
**æˆ‘ä»¬é€šå¸¸åœ¨ç»Ÿä¸€å®Œæˆå¤„ç†é˜¶æ®µå®Œæˆå¯¹å®¢æˆ·ç«¯è¿”å›å†…å®¹çš„ç»Ÿä¸€ç»“æ„ç»„è£…ï¼Œå¹¶æ“ä½œå®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```å‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœã€‚**

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›´æ¥æ“ä½œ**å®¢æˆ·ç«¯è¿”å›å®ä¾‹**```res```å‘èµ·è¿”å›åŠ¨ä½œå°†è·³è¿‡**ç»Ÿä¸€å®Œæˆå¤„ç†**é˜¶æ®µç›´æ¥è§¦å‘[Handlerææ„](#handlerææ„)ã€‚

å› æ­¤ï¼Œ**æˆ‘ä»¬åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æœŸæœ›å‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœæ—¶åº”ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œå®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```**ã€‚
:::

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```onFinish```ç»´åº¦**ã€‚å³ï¼šå½“```onFinish```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è‡ªåŠ¨è¿›å…¥[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®è¯·æ±‚é¢„å¤„ç†ä¸­å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```onFinish```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**ç»Ÿä¸€å®Œæˆå¤„ç†**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®Œå–„è¯·æ±‚åå¤„ç†ä¸­çš„ğŸŒ°ï¼Œä¸ºå…¶å‘å®¢æˆ·ç«¯çš„è¿”å›å†…å®¹æ·»åŠ ç»Ÿä¸€ç»“æ„ã€‚**

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äº**æ¨¡æ‹Ÿè€—æ—¶åŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡**çš„```BaseHandler```ä½œä¸ºåŸºç±»ï¼š

```javascript
class BaseHandler extends Core.Handler {
  // å¼‚æ­¥è€—æ—¶ä»»åŠ¡
  asyncTask(duration = 0) {
    return new Promise((resolve) => {
      setTimeout(() => resolve(), duration);
    });
  }

  // åŒæ­¥è€—æ—¶ä»»åŠ¡
  syncTask(duration = 0) {
    const startDate = new Date();
    while (true) {
      if (((new Date()) - startDate) > duration) {
        break;
      }
    }
  }
}
```

::: tip æç¤º
**é€šå¸¸ï¼Œæˆ‘ä»¬ä¸éœ€è¦å®Œå…¨é‡å†™```onFinish```ä¸­åŒ…å«çš„é€»è¾‘ï¼Œè€Œæ˜¯ä½¿ç”¨```super.onFinish()```å¤ç”¨é»˜è®¤çš„ç»Ÿä¸€å®Œæˆå¤„ç†é€»è¾‘ã€‚**

å¯¹äº**ç»Ÿä¸€å®Œæˆå¤„ç†**é»˜è®¤æ”¯æŒçš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)ã€‚
:::

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†**è‡ªå®šä¹‰Handler**ç»§æ‰¿çš„åŸºç±»å˜æ›´ä¸º```BaseHandler```ï¼Œå¹¶åœ¨**ç»Ÿä¸€å®Œæˆå¤„ç†**ä¸­å®ŒæˆæŠ¥æ–‡ç»“æ„åŒ…è£…ï¼š

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„è¯·æ±‚é¢„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```onFinish```ï¼š**

```javascript {1,18-24}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  postHandler(req, res, next) {
    const { path } = req.query;
    try {
      // åŒæ­¥è¯»å–ç›®å½•å†…å®¹å¹¶å‘å®¢æˆ·ç«¯è¿”å›ç»“æœ
      const result = fs.readdirSync(path);
      next(result);
    } catch (error) {
      // æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸æ—¶å‘å®¢æˆ·ç«¯è¿”å›å¼‚å¸¸ä¿¡æ¯
      next(error.message);
    }
  }

  onFinish(data, req, res) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    // æ„é€ æŠ¥æ–‡ç»“æ„å¹¶æ‰§è¡ŒåŸå§‹çš„onFinish()æ–¹æ³•å‘å®¢æˆ·ç«¯è¿”å›
    const backMessage = { code: 0, data };
    super.onFinish(backMessage, req, res);
  }
}
```

åŒæ ·ï¼Œ**å½“è¯·æ±‚åå¤„ç†é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```onFinish```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {14-16}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  async postHandler(req, res, next) {
    const { path } = req.query;
    const result = await promisify(fs.readdir)(path).catch((error) => {
      next(error.message);
    });
    result && next(result);
  }

  async onFinish(data, req, res) {
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    // æ„é€ æŠ¥æ–‡ç»“æ„å¹¶æ‰§è¡ŒåŸå§‹çš„onFinish()æ–¹æ³•å‘å®¢æˆ·ç«¯è¿”å›
    const backMessage = { code: 0, data };
    super.onFinish(backMessage, req, res);
  }
}
```

**æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do\?path\=[æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„]```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**1000ms**æ‰“å°è¯·æ±‚å¤„ç†ç»“æœï¼Œä¸”å¤„ç†ç»“æœæ‹¥æœ‰ç»Ÿä¸€çš„ç»“æ„```{ code: 0, data: [å¤„ç†ç»“æœ] }```ã€‚

- å½“æŒ‡å®šçš„**æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„**å­˜åœ¨æ—¶ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„å¤„ç†ç»“æœä¸º**æœ¬åœ°ç›®å½•ä¸­çš„å†…å®¹**ã€‚

- å½“æœªæŒ‡å®š**æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„**æˆ–**æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„**ä¸å­˜åœ¨æ—¶ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°çš„å¤„ç†ç»“æœä¸º**å¼‚å¸¸åŸå› **ã€‚

::: warning æ³¨æ„
**æ ·ä¾‹ä»£ç ä¸­ä½¿ç”¨çš„å¼‚å¸¸å¤„ç†æ–¹å¼ä¸æ¨èåœ¨å®é™…ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨**ã€‚å¯¹äºå¦‚ä½•ä¼˜é›…çš„å¤„ç†å¼‚å¸¸ï¼Œæˆ‘ä»¬å°†åœ¨[ç»Ÿä¸€é”™è¯¯å¤„ç†](#ç»Ÿä¸€é”™è¯¯å¤„ç†)ä¸­è¿›è¡Œè¯¦ç»†è®¨è®ºã€‚
:::

## ç»Ÿä¸€é”™è¯¯å¤„ç†

**ä»»æ„è¯·æ±‚å¤„ç†é˜¶æ®µ**çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶ï¼Œ**Handler**å°†è‡ªåŠ¨å¼•å¯¼å¤„ç†æµç¨‹è¿›å…¥**ç»Ÿä¸€å®Œæˆå¤„ç†**é˜¶æ®µã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨**è¯·æ±‚å¤„ç†ä»»æ„é˜¶æ®µ**ä¸­ä½¿ç”¨[æµç¨‹æ§åˆ¶å‡½æ•°](#æµç¨‹æ§åˆ¶å‡½æ•°)æ‰§è¡Œ```next(error)```æ‰‹åŠ¨è§¦å‘**ç»Ÿä¸€å®Œæˆå¤„ç†**ã€‚

**æˆ‘ä»¬é€šè¿‡é‡å†™Handlerçš„å®ä¾‹æ–¹æ³•```onError```ä»¥æŒ‡å®šç»Ÿä¸€å®Œæˆå¤„ç†é˜¶æ®µæ‰§è¡Œçš„é€»è¾‘ã€‚**

::: tip è¯´æ˜
**æˆ‘ä»¬é€šå¸¸åœ¨ç»Ÿä¸€é”™è¯¯å¤„ç†é˜¶æ®µå¤„ç†å¼‚å¸¸åï¼Œç›´æ¥æ“ä½œå®¢æˆ·ç«¯è¿”å›å®ä¾‹```res```å‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœã€‚**
:::

åŒæ ·ï¼Œ**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·å¥—ä»¶ä¹Ÿå°†è‡ªåŠ¨ä½œç”¨åœ¨å®ä¾‹æ–¹æ³•```onError```ç»´åº¦**ã€‚ä¸å…¶ä»–å¤„ç†é˜¶æ®µä¸åŒçš„æ˜¯ï¼Œ**å½“```onError```æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†æœªè¢«æ•è·çš„å¼‚å¸¸æ—¶å°†è¿›å…¥ServiceCoreçš„[é”™è¯¯æ‹¦æˆªå™¨](/guide/web-service.html#é”™è¯¯æ‹¦æˆªå™¨)ã€‚**

å› æ­¤ï¼Œæˆ‘ä»¬åº”**æ ¹æ®è¯·æ±‚é¢„å¤„ç†ä¸­å®é™…é€»è¾‘çš„åŒæ­¥æˆ–å¼‚æ­¥ï¼Œé€‰æ‹©ä½¿ç”¨```Function```æˆ–```AsyncFunction```ç±»å‹çš„```onFinish```ã€‚**

::: warning æ³¨æ„
**Handlerå†…ç½®çš„å¼‚å¸¸æ•è·æœºåˆ¶ä»…åœ¨è¯·æ±‚å¤„ç†èŠ‚ç‚¹çš„æ ¹å‡½æ•°ä¸­äº§ç”Ÿæœªè¢«æ•è·çš„å¼‚å¸¸æ—¶æ‰äº§ç”Ÿæ•ˆåŠ›ã€‚**

å› æ­¤ï¼Œå½“**ç»Ÿä¸€é”™è¯¯å¤„ç†**é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ä½¿ç”¨```async/await```å’Œ```Promise```å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œä»¥ä¿è¯å¼‚å¸¸å¯ä»¥æ­£å¸¸æŠ›å‡ºã€‚**
:::

---

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ›´ä¼˜é›…çš„å¼‚å¸¸å¤„ç†æ–¹æ¡ˆæ¥å®Œå–„è¯·æ±‚åå¤„ç†ä¸­çš„ğŸŒ°ã€‚**

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äº**æ¨¡æ‹Ÿè€—æ—¶åŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡**çš„```BaseHandler```ä½œä¸ºåŸºç±»ï¼š

```javascript
class BaseHandler extends Core.Handler {
  // å¼‚æ­¥è€—æ—¶ä»»åŠ¡
  asyncTask(duration = 0) {
    return new Promise((resolve) => {
      setTimeout(() => resolve(), duration);
    });
  }

  // åŒæ­¥è€—æ—¶ä»»åŠ¡
  syncTask(duration = 0) {
    const startDate = new Date();
    while (true) {
      if (((new Date()) - startDate) > duration) {
        break;
      }
    }
  }
}
```
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†**è‡ªå®šä¹‰Handler**ç»§æ‰¿çš„åŸºç±»å˜æ›´ä¸º```BaseHandler```ï¼Œåˆ é™¤**Handleråå¤„ç†**ä¸­å¼‚å¸¸å¤„ç†ç›¸å…³çš„ä»£ç ï¼Œå¹¶åœ¨**ç»Ÿä¸€é”™è¯¯å¤„ç†**ä¸­æ”¶å£å¼‚å¸¸å¤„ç†ï¼š

**å¯¹äºåªåŒ…å«åŒæ­¥è¡Œä¸ºçš„è¯·æ±‚é¢„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬ä½¿ç”¨```Function```ç±»å‹çš„```onError```ï¼š**

```javascript {1,6-11,13-18}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  postHandler(req, res, next) {
    const { path } = req.query;
    // åŒæ­¥è¯»å–ç›®å½•å†…å®¹å¹¶å‘å®¢æˆ·ç«¯è¿”å›ç»“æœ
    const result = fs.readdirSync(path);
    next(result);
  }

  onError(error, req, res) {
    // æ‰§è¡Œ1000msçš„åŒæ­¥ä»»åŠ¡
    this.syncTask(1000);
    // å‘å®¢æˆ·ç«¯è¿”å›å¼‚å¸¸ä¿¡æ¯
    res.status(500).send(error.message);
  }
}
```

åŒæ ·ï¼Œ**å½“è¯·æ±‚åå¤„ç†é€»è¾‘ä¸­åŒ…å«å¼‚æ­¥è¡Œä¸ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨```AsyncFunction```ç±»å‹çš„```onError```ï¼Œå¹¶é€šè¿‡```await```å…³é”®å­—æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡**ï¼š

```javascript {1,6-10,12-17}
class Handler extends BaseHandler {
  static getRoutePath() {
    return '/Test.do';
  }

  async postHandler(req, res, next) {
    const { path } = req.query;
    const result = await promisify(fs.readdir)(path);
    next(result);
  }

  async onError(error, req, res) {
    // æ‰§è¡Œ1000msçš„å¼‚æ­¥ä»»åŠ¡
    await this.asyncTask(1000);
    // å‘å®¢æˆ·ç«¯è¿”å›å¼‚å¸¸ä¿¡æ¯
    res.status(500).send(error.message);
  }
}
```

**æœ€åï¼Œæˆ‘ä»¬æ‰“å¼€æ§åˆ¶å°ï¼Œä½¿ç”¨```curl http://localhost:3000/Test.do\?path\=[ä¸å­˜åœ¨çš„æœ¬åœ°ç›®å½•ç»å¯¹è·¯å¾„]```æ£€æŸ¥å®ç°æ•ˆæœï¼š**

- å®¢æˆ·ç«¯æ§åˆ¶å°å°†äºè¯·æ±‚å‘èµ·åçº¦**1000ms**æ‰“å°è¯·æ±‚å¤„ç†ç»“æœï¼Œå¤„ç†ç»“æœä¸º**å¼‚å¸¸åŸå› **ã€‚
