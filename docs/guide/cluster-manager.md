# å¤šè¿›ç¨‹æ¶æ„

é€šå¸¸ï¼Œæˆ‘ä»¬ä½¿ç”¨**Master/Workerè¿›ç¨‹æ¨¡å‹**ä½¿åº”ç”¨ç¨‹åºå¯ä»¥æœ€å¤§åŒ–ä½¿ç”¨CPUèµ„æºï¼š

- **Masterè¿›ç¨‹**ï¼šåè°ƒè¿›ç¨‹èµ„æºï¼Œæ¯”å¦‚ï¼šåˆ›å»º/é‡å¯**Workerè¿›ç¨‹**ã€å…¨å±€çŠ¶æ€/è¡Œä¸ºç»´æŠ¤ç­‰ã€‚

- **Workerè¿›ç¨‹**ï¼šå¤„ç†å®é™…ä¸šåŠ¡ã€‚

åœ¨å¤šè¿›ç¨‹æ¶æ„çš„åº”ç”¨ç¨‹åºä¸­ï¼Œ**Masterè¿›ç¨‹**ä¸­æ‰§è¡Œçš„æ“ä½œå…·æœ‰åº”ç”¨ç¨‹åºçº§åˆ«çš„å”¯ä¸€æ€§ï¼›è€Œä¸åŒçš„è¿›ç¨‹æ‹¥æœ‰å®Œå…¨ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹å†…çš„çŠ¶æ€å®Œå…¨éš”ç¦»ã€‚å› æ­¤ï¼Œå¯¹äºåœ¨å¤šä¸ª**Workerè¿›ç¨‹**ä¸­å…±äº«çš„çŠ¶æ€çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Corejsæä¾›çš„[å…¨å±€å¯¹è±¡](#å…¨å±€å¯¹è±¡)å®ç°ã€‚

::: warning æ³¨æ„
åœ¨å¤š**Workerè¿›ç¨‹**çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯ä¸ª**Workerè¿›ç¨‹**éœ€è¦ä¸¥æ ¼ä¿è¯æ— çŠ¶æ€è®¾è®¡ï¼Œå¦åˆ™å¯èƒ½äº§ç”Ÿå¥‡æ€ªçš„é—®é¢˜ã€‚
:::

---

Corejså¼•å…¥äº†[ClusterCore](#clustercore)å’Œ[AppMain](#appmain)ä»¥å®ç°åº”ç”¨ç¨‹åºçš„å¤šè¿›ç¨‹æ¶æ„ã€‚å…¶ä¸­ï¼š

- **ClusterCore**ï¼šæ˜¯å¤šè¿›ç¨‹æ¶æ„çš„æ ¸å¿ƒï¼Œå…¶ä¸­åŒ…å«è¿›ç¨‹ç®¡ç†ã€é€šè®¯ç›¸å…³çš„APIã€‚

- **AppMain**ï¼šå®ç°åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µï¼Œå°†è¢«**ClusterCore**åŠ è½½å’Œè°ƒç”¨ã€‚

::: tip æç¤º
é€šå¸¸ï¼Œæˆ‘ä»¬åº”å°†åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘å…¨éƒ¨è£…å…¥**AppMain**ï¼Œåœ¨**AppMain**å¤–éƒ¨åªéœ€è¦ï¼š

1. æ‰§è¡Œ```Core.ClusterCore.init()```æŒ‡å®šåº”ç”¨ç¨‹åºä½¿ç”¨çš„**AppMain**ã€‚

2. æ‰§è¡Œ```Core.ClusterCore.start()```å¯åŠ¨**ClusterCore**ã€‚

**ClusterCore**å°†åœ¨æ°å½“çš„æ—¶é—´ç‚¹è‡ªåŠ¨è°ƒç”¨**AppMain**ä¸­å¯¹åº”ç”Ÿå‘½å‘¨æœŸä»¥é©±åŠ¨åº”ç”¨ç¨‹åºè¿è¡Œã€‚
:::

## å¤šè¿›ç¨‹æ¨¡å‹

[å¤šè¿›ç¨‹æ¨¡å‹](./test.png)

## AppMain

**AppMain**æŠ½è±¡äº†**åº”ç”¨æ¨¡å‹**å’Œ**è¿›ç¨‹æ¨¡å‹**ï¼Œè¦†ç›–äº†åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µï¼š

- [```onProcessDidInit(processId, launchParams)```](#onprocessdidinit-processid-launchparams)ï¼š**Master/Workerè¿›ç¨‹**å®Œæˆåˆå§‹åŒ–æ—¶è§¦å‘ã€‚

- [```onWorkerProcessDidExit(exitedProcessId, exitedDetail, reboot)```](#onworkerprocessdidexit-exitedprocessid-exiteddetail-reboot)ï¼š**Masterè¿›ç¨‹**æ•è·åˆ°**Workerè¿›ç¨‹**é€€å‡ºæ—¶è§¦å‘ã€‚

- [```onProcessWillReceiveMessage(fromProcessId, data, next)```](#onprocesswillreceivemessage-fromprocessid-data-next)ï¼š**Master/Workerè¿›ç¨‹**æ¥æ”¶åˆ°è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯æ—¶è§¦å‘ã€‚

- [```onProcessDidReceiveMessage(fromProcessId, data)```](#onprocessdidreceivemessage-fromprocessid-data)ï¼š**Master/Workerè¿›ç¨‹**å†³å®šå¤„ç†è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯æ—¶è§¦å‘ã€‚

- [```onProcessDidDiscardMessage(fromProcessId, data)```](#onprocessdiddiscardmessage-fromprocessid-data)ï¼š**Master/Workerè¿›ç¨‹**å†³å®šä¸¢å¼ƒè¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯æ—¶è§¦å‘ã€‚

- [```onProcessTraceMessageTimeout(toProcessId, data)```](#onprocesstracemessagetimeout-toprocessid-data)ï¼š**Master/Workerè¿›ç¨‹**ä¸­éœ€è¦åº”ç­”çš„è¿›ç¨‹é—´é€šä¿¡è¶…æ—¶æœªæ¥æ”¶åˆ°åº”ç­”æ¶ˆæ¯æ—¶è§¦å‘ã€‚

::: tip æç¤º
æˆ‘ä»¬åœ¨å®ç°**AppMain**æ—¶ï¼Œéœ€è¦ç»§æ‰¿è‡ª```Core.AppMain```ã€‚
:::

### å®ä¾‹å±æ€§

[ClusterCore](#clustercore)æ‰§è¡Œåˆå§‹åŒ–æ—¶å°†è‡ªåŠ¨åˆ›å»º**AppMain**å®ä¾‹ã€‚å› æ­¤ï¼Œåœ¨åº”ç”¨ç¨‹åºçš„ä»»æ„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨```this```è®¿é—®**AppMain**çš„å®ä¾‹å±æ€§ï¼š

- ```processId```ï¼šå½“å‰è¿›ç¨‹çš„IDã€‚

  ::: tip è¯´æ˜
  **Masterè¿›ç¨‹**å’Œ**Workerè¿›ç¨‹**ä¸­çš„```processId```æœ‰ä¸åŒçš„æ„æˆè§„åˆ™ï¼š

  - **Masterè¿›ç¨‹**ä¸­ï¼Œè¿›ç¨‹IDä¸º```'M'```ã€‚

  - **Workerè¿›ç¨‹**ä¸­ï¼Œè¿›ç¨‹IDä¸º```'W:<%è¿›ç¨‹åç§»%>'```ã€‚
  
  **è¿›ç¨‹åç§»**æ˜¯ä¸€ä¸ª```>= 1```çš„æ•´æ•°ï¼Œåæ˜ äº†**Masterè¿›ç¨‹**åˆ›å»º**Workerè¿›ç¨‹**çš„æ—¶åºã€‚
  :::

- ```clusterCore```ï¼šåˆ›å»ºå¹¶åŠ è½½**AppMain**çš„[ClusterCore](#clustercore)å®ä¾‹ã€‚

- ```launchParams```ï¼šè¿›ç¨‹çš„åˆå§‹åŒ–å‚æ•°ï¼Œå³**Masterè¿›ç¨‹**ä¸­çš„```process.argv```ã€‚

::: danger æ³¨æ„
**AppMainçš„å®ä¾‹å±æ€§å°†åœ¨```onProcessDidInit()```çš„é»˜è®¤è¡Œä¸ºä¸­è¢«è®¾ç½®ã€‚**

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨é‡å†™```onProcessDidInit()```æ—¶å¿…é¡»æ‰§è¡Œ```super```æ“ä½œï¼Œä»¥ä¿è¯**AppMain**ä¸­å®ä¾‹å±æ€§çš„æ­£ç¡®æ€§ã€‚
:::

### è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ

æˆ‘ä»¬å¯ä»¥åœ¨**AppMain**ä¸­æŒ‡å®šåº”ç”¨ç¨‹åºåœ¨è¿›ç¨‹ç»´åº¦ç”Ÿå‘½å‘¨æœŸä¸­çš„è¡Œä¸ºï¼š

- **Masterè¿›ç¨‹**ã€**Workerè¿›ç¨‹**åˆå§‹åŒ–å®Œæˆæ—¶ã€‚

- **Masterè¿›ç¨‹**æ£€æµ‹åˆ°æœ‰**Workerè¿›ç¨‹**é€€å‡ºæ—¶ã€‚

::: tip æç¤º
å¯¹äº**Masterè¿›ç¨‹**çš„é€€å‡ºäº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥**Masterè¿›ç¨‹**çš„ä¸šåŠ¡å±‚ä¸­ä½¿ç”¨```process.on()```ã€‚
:::

---

#### ```onProcessDidInit(processId, launchParams)```

##### å‚æ•°åˆ—è¡¨

- ```processId```ï¼šåˆå§‹åŒ–å®Œæˆçš„è¿›ç¨‹IDã€‚

- ```launchParams```ï¼šè¿›ç¨‹çš„åˆå§‹åŒ–å‚æ•°ï¼Œå³**Masterè¿›ç¨‹**ä¸­çš„```process.argv```ã€‚

##### ä½¿ç”¨åœºæ™¯

**Masterè¿›ç¨‹**ã€**Workerè¿›ç¨‹**åˆå§‹åŒ–å®Œæˆæ—¶å°†è§¦å‘æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ­¤æ–¹æ³•ä¸­æ ¹æ®```processId```åˆ¤æ–­å½“å‰çš„è¿›ç¨‹ç¯å¢ƒæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼š

- å½“å‰æ˜¯**Masterè¿›ç¨‹**æ—¶ï¼Œä½¿ç”¨```Core.ClusterCore.fork()```åˆ›å»º**Workerè¿›ç¨‹**ï¼Œæˆ–æ‰§è¡Œä¸€äº›åœ¨æœŸæœ›åœ¨åº”ç”¨ç¨‹åºç»´åº¦ä¿è¯å”¯ä¸€æ€§çš„æ“ä½œã€‚

- å½“å‰æ˜¯**Workerè¿›ç¨‹**æ—¶ï¼Œæ‰§è¡Œå®é™…ä¸šåŠ¡ï¼Œæ¯”å¦‚ï¼šå¯åŠ¨**ServiceCore**ç­‰ã€‚

::: tip æç¤º
åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¦‚æœéœ€è¦åœ¨å¤šä¸ªåº”ç”¨ç¨‹åºé—´åŒæ­¥æˆ–å…±äº«æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼åè°ƒå·¥å…·ï¼Œæ¯”å¦‚ï¼š```ZooKeeper```ã€```Redis```ç­‰ã€‚
:::

---

#### ```onWorkerProcessDidExit(exitedProcessId, exitedDetail, reboot)```

##### å‚æ•°åˆ—è¡¨

- ```exitedProcessId```ï¼šå·²é€€å‡ºçš„è¿›ç¨‹IDã€‚

- ```exitedDetail```ï¼šè¿›ç¨‹é€€å‡ºè¯¦æƒ…ï¼Œç»“æ„ä¸º```{ code, signal }```ã€‚

- ```reboot```ï¼šé‡æ–°æ‹‰èµ·**Workerè¿›ç¨‹**çš„å‡½æ•°ã€‚ä½¿ç”¨```reboot()```é‡æ–°æ‹‰èµ·çš„è¿›ç¨‹å°†ä½¿ç”¨```exitedProcessId```ä½œä¸ºè¿›ç¨‹IDã€‚

##### ä½¿ç”¨åœºæ™¯

**Masterè¿›ç¨‹**æ£€æµ‹åˆ°è¿›ç¨‹ç»„ä¸­æœ‰**Workerè¿›ç¨‹**é€€å‡ºæ—¶å°†è§¦å‘æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚æˆ‘ä»¬åœ¨æ­¤æ–¹æ³•ä¸­æœ‰ä¸¤ç§é‡æ–°æ‹‰èµ·**Workerè¿›ç¨‹**çš„æ–¹å¼ï¼š

- ä½¿ç”¨```reboot()```ï¼šæ–°çš„**Workerè¿›ç¨‹**å°†å¤ç”¨é€€å‡ºè¿›ç¨‹çš„```processId```ã€‚

- ä½¿ç”¨```Core.ClusterCore.fork()```ï¼šæ–°çš„**Workerè¿›ç¨‹**å°†ä½¿ç”¨è¿›ç¨‹ç»„å†…çš„è¿›ç¨‹åç§»åˆ›å»º```processId```ã€‚

---

#### å®ç°åŸç†

åœ¨**Masterè¿›ç¨‹**ä¸­ï¼Œæ‰§è¡Œ```Core.ClusterCore.start()```å°†è§¦å‘**Masterè¿›ç¨‹**çš„åˆå§‹åŒ–åŠ¨ä½œï¼š

1. é¦–å…ˆï¼Œä½¿ç”¨nodejsåŸç”Ÿæ¨¡å—```cluster```ç›‘å¬**Workerè¿›ç¨‹**çš„é€€å‡ºæ¶ˆæ¯ï¼Œåœ¨**Workerè¿›ç¨‹**é€€å‡ºæ—¶è°ƒç”¨```onWorkerProcessDidExit()```é€šçŸ¥ä¸šåŠ¡å±‚ã€‚

2. æ¥ä¸‹æ¥ï¼Œä½¿ç”¨åŒæ ·æ–¹å¼ç›‘å¬**Workerè¿›ç¨‹**çš„é€šä¿¡æ¶ˆæ¯ã€‚

3. æœ€åï¼Œè°ƒç”¨```onProcessDidInit()```é€šçŸ¥ä¸šåŠ¡å±‚**Masterè¿›ç¨‹**å·²åˆå§‹åŒ–å®Œæˆã€‚

---

åœ¨**Workerè¿›ç¨‹**ä¸­æ‰§è¡Œ```Core.ClusterCore.start()```æ—¶ï¼Œå°†è§¦å‘**Workerè¿›ç¨‹**çš„åˆå§‹åŒ–åŠ¨ä½œï¼š

1. é¦–å…ˆï¼Œä½¿ç”¨```process.on()```ç›‘å¬æ¥è‡ª**Masterè¿›ç¨‹**çš„é€šä¿¡æ¶ˆæ¯ã€‚

2. æ¥ä¸‹æ¥ï¼Œå‘**Masterè¿›ç¨‹**å‘èµ·[TraceIPC](#traceipc)ä»¥è·å–è¿›ç¨‹çš„åˆå§‹åŒ–ä¿¡æ¯ã€‚

3. æœ€åï¼Œåœ¨æ”¶åˆ°**Masterè¿›ç¨‹**åº”ç­”çš„åˆå§‹åŒ–ä¿¡æ¯æ—¶è°ƒç”¨```onProcessDidInit()```é€šçŸ¥ä¸šåŠ¡å±‚**Workerè¿›ç¨‹**å·²åˆå§‹åŒ–å®Œæˆã€‚

## ClusterCore

åœ¨è®¾è®¡ä¸Šï¼Œ**ClusterCore**æ˜¯è¿›ç¨‹çº§åˆ«çš„å•ä¾‹ï¼Œåœ¨å®ä¾‹åŒ–æ—¶å°†è‡ªåŠ¨æ ¹æ®å½“å‰è¿è¡Œè¿›ç¨‹çš„ç±»å‹åŠ è½½å¯¹åº”çš„APIã€‚å³ä½¿åœ¨ä¸åŒçš„è¿›ç¨‹ç¯å¢ƒä¸­ï¼Œç›¸åŒçš„APIåœ¨ä½¿ç”¨ä½“éªŒä¸Šå®Œå…¨ç›¸åŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨**ClusterCore**æ—¶é€šå¸¸æ— éœ€å…³æ³¨è¿›ç¨‹ç±»å‹ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿è¡Œåœ¨**Masterè¿›ç¨‹**ä¸­çš„**ClusterCore**æ‹¥æœ‰**åˆ›å»ºWorkerè¿›ç¨‹**å’Œ**å…³é—­åº”ç”¨ç¨‹åº**çš„èƒ½åŠ›ã€‚å³è¿è¡Œåœ¨**Workerè¿›ç¨‹**ä¸­çš„**ClusterCore**æ— æ³•è°ƒç”¨ä»¥ä¸‹APIï¼š

- ```fork(workerNum)```ï¼šåˆ›å»ºæŒ‡å®šæ•°é‡çš„**Workerè¿›ç¨‹**ã€‚

- ```shutdown([exitCode])```ï¼šå…³é—­è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰**Masterè¿›ç¨‹**å’Œ**Workerè¿›ç¨‹**ã€‚

---

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œ**ClusterCore**å°†è‡ªåŠ¨è°ƒç”¨**AppMain**ä¸­å¯¹åº”ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥é©±åŠ¨åº”ç”¨ç¨‹åºçš„è¿è¡Œã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨**ClusterCore**å‰éœ€è¦æŒ‡å®š**AppMain**è¿›è¡Œåˆå§‹åŒ–ã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨**ClusterCore**å’Œ**AppMain**çš„æ ‡å‡†æ ·ä¾‹ï¼š

```javascript
const Core = require('node-corejs');

/**
 * å®ç°AppMain
 */
class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    // é‡å†™æ—¶å¿…é¡»æ‰§è¡Œsuperæ“ä½œ
    super.onProcessDidInit(processId, launchParams);

    // åœ¨Masterè¿›ç¨‹åˆå§‹åŒ–å®Œæˆå - åˆ›å»º4ä¸ªWorkerè¿›ç¨‹
    if (processId === 'M') {
      console.log(`Masterè¿›ç¨‹åˆå§‹åŒ–å®Œæˆ`);
      Core.ClusterCore.fork(4);
    }
    // åœ¨Workerè¿›ç¨‹åˆå§‹åŒ–å®Œæˆå - æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    else {
      console.log(`Workerè¿›ç¨‹åˆå§‹åŒ–å®Œæˆ -> ${processId}`);
      // æ¨¡æ‹Ÿworkerè¿›ç¨‹é€€å‡ºè§¦å‘é‡å¯
      setTimeout(() => { process.exit() }, 1500);
    }
  }

  /**
   * Workerè¿›ç¨‹é€€å‡º
   * @override
   */
  onWorkerProcessDidExit(exitedProcessId, exitedDetail, reboot) {
    // åœ¨workerè¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
    reboot();
  }
}

// åˆå§‹åŒ–å¹¶å¯åŠ¨ClusterCore
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

## è¿›ç¨‹é—´é€šä¿¡

è¿›ç¨‹é—´é€šä¿¡æœ‰ä¸¤ç§åœºæ™¯ï¼š

1. **å‘é€æ–¹**å‘**æ¥æ”¶æ–¹**å•å‘å‘é€æ¶ˆæ¯ï¼Œæ— éœ€å…³æ³¨**æ¥æ”¶æ–¹**çš„åº”ç­”æƒ…å†µï¼Œå³å‘èµ·[IPC](#ipc)ã€‚

2. **å‘é€æ–¹**å‘**æ¥æ”¶æ–¹**å‘é€æ¶ˆæ¯åï¼Œéœ€è¦æ¥æ”¶åˆ°**æ¥æ”¶æ–¹**çš„åº”ç­”æ¶ˆæ¯åæ‰è®¤ä¸ºé€šä¿¡å®Œæˆï¼Œå³å‘èµ·[TraceIPC](#traceipc)ã€‚

### APIè®¾è®¡

**ClusterCore**æä¾›äº†åœ¨è¿›ç¨‹ç»„ä¸­çš„ä»»æ„è¿›ç¨‹é—´å‘èµ·[IPC](#ipc)å’Œ[TraceIPC](#traceipc)çš„APIï¼š

- [```sendData(processId, data[, callBack])```](#senddata-processid-data-callback)ï¼šç”¨äºå‘èµ·[IPC](#ipc)ã€‚

- [```sendDataWithTraceCallBack(processId, data, options[, callBack])```](#senddatawithtracecallback-processid-data-options-callback)ï¼šç”¨äºå‘èµ·[TraceIPC](#traceipc)ã€‚

::: danger æ³¨æ„
**ClusterCoreå°†æ‹’ç»åœ¨ç›¸åŒçš„è¿›ç¨‹é—´å‘èµ·çš„é€šä¿¡åŠ¨ä½œã€‚**
:::

---

#### ```sendData(processId, data[, callBack])```

##### ä½¿ç”¨åœºæ™¯

ç”¨äº**å‘é€æ–¹**å‘**æ¥æ”¶æ–¹**å‘é€å•å‘çš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ï¼Œå³å‘èµ·[IPC](#ipc)ã€‚

##### å‚æ•°åˆ—è¡¨

- ```processId```ï¼š**æ¥æ”¶æ–¹**çš„è¿›ç¨‹IDï¼Œå¿…å¡«é¡¹ã€‚
  
  ::: tip æç¤º
  æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```Core.ClusterCore.getAllProcessIds()```è·å–è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹IDã€‚
  :::

- ```data```ï¼š**å‘é€æ–¹**å‘**æ¥æ”¶æ–¹**å‘é€çš„è‡ªå®šä¹‰æ•°æ®ï¼Œå¿…å¡«é¡¹ã€‚æˆ‘ä»¬å°†åœ¨[æ¶ˆæ¯ç»“æ„](#æ¶ˆæ¯ç»“æ„)ä¸€èŠ‚ä¸­è®¨è®ºå…·ä½“ç»†èŠ‚ã€‚

- ```callBack```ï¼šå‘èµ·è¿›ç¨‹é—´é€šä¿¡åŠ¨ä½œçš„æ‰§è¡Œç»“æœï¼Œéå¿…å¡«é¡¹ã€‚æ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ï¼Œå…¶å‚æ•°åˆ—è¡¨ä¸º```(error)```ã€‚
  
  ::: tip æç¤º
  æˆ‘ä»¬å¯ä»¥æ ¹æ®```callBack```å›è°ƒçš„```error```åˆ¤æ–­è¿›ç¨‹é—´é€šä¿¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼š

  - å½“æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œ```error```çš„å€¼ä¸º```null```ã€‚
  - å½“æ‰§è¡Œå¤±è´¥æ—¶ï¼Œ```error```çš„å€¼ä¸ºé€šä¿¡å¤±è´¥çš„åŸå› ã€‚
  :::

---

#### ```sendDataWithTraceCallBack(processId, data, options[, callBack])```

##### ä½¿ç”¨åœºæ™¯

**å‘é€æ–¹**å‘**æ¥æ”¶æ–¹**å‘é€éœ€è¦åº”ç­”çš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ï¼Œå³å‘èµ·[TraceIPC](#traceipc)ã€‚

##### å‚æ•°åˆ—è¡¨

- ```processId```ï¼š**æ¥æ”¶æ–¹**çš„è¿›ç¨‹IDï¼Œå¿…å¡«é¡¹ã€‚

  ::: tip æç¤º
  æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```Core.ClusterCore.getAllProcessIds()```è·å–è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹IDã€‚
  :::

- ```data```ï¼š**å‘é€æ–¹**å‘**æ¥æ”¶æ–¹**å‘é€çš„è‡ªå®šä¹‰æ•°æ®ï¼Œå¿…å¡«é¡¹ã€‚æˆ‘ä»¬å°†åœ¨[æ¶ˆæ¯ç»“æ„](#æ¶ˆæ¯ç»“æ„)ä¸€èŠ‚ä¸­è®¨è®ºå…·ä½“ç»†èŠ‚ã€‚

- ```options```ï¼šè¿›ç¨‹é—´é€šä¿¡çš„é…ç½®é¡¹ï¼Œå¿…å¡«é¡¹ï¼Œæ”¯æŒä½¿ç”¨```Object```æˆ–```Function```ç±»å‹çš„é…ç½®é¡¹ã€‚
  
  ::: tip æç¤º
  **å½“æˆ‘ä»¬ä½¿ç”¨```Object```ç±»å‹çš„```options```æ—¶ï¼Œå…¶ç»“æ„ä¸º```{ timeout, traceCallBack }```ï¼š**

  - ```timeout```ï¼šåˆ¤å®šåº”ç­”è¶…æ—¶çš„æ¯«ç§’æ•°ï¼Œé»˜è®¤ä¸º```10000```ã€‚

    > åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ”¶åˆ°æ¥è‡ª**æ¥æ”¶æ–¹**åº”ç­”æ¶ˆæ¯æ—¶ï¼Œå°†è§¦å‘**AppMain**ä¸­çš„```onProcessTraceMessageTimeout()```è¿›è¡Œæ¶ˆæ¯è¶…æ—¶å¤„ç†ã€‚

  - ```traceCallBack```ï¼š**å‘é€æ–¹**æ”¶åˆ°åº”ç­”æ¶ˆæ¯æ—¶æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œå¿…å¡«é¡¹ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(resData, next)```ã€‚

    > æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```next()```ä½¿åº”ç­”æ¶ˆæ¯è¿›å…¥**AppMain**ä¸­çš„```onProcessDidReceiveMessage()```ç»§ç»­å¤„ç†ã€‚
  
  **å½“ä½¿ç”¨```Function```ç±»å‹çš„```options```æ—¶ï¼Œå°†ç›´æ¥åº”ç”¨äº```traceCallBack```ï¼Œä¸”æ­¤æ—¶```timeout```ä¸º```10000```ã€‚**
  :::

- ```callBack```ï¼šè¿›ç¨‹é—´é€šä¿¡çš„æ‰§è¡Œç»“æœï¼Œéå¿…å¡«é¡¹ã€‚æ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ï¼Œå…¶å‚æ•°åˆ—è¡¨ä¸º```(error)```ã€‚

  ::: tip æç¤º
  æˆ‘ä»¬å¯ä»¥æ ¹æ®```callBack```å›è°ƒçš„```error```åˆ¤æ–­è¿›ç¨‹é—´é€šä¿¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼š

  - å½“æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œ```error```çš„å€¼ä¸º```null```ã€‚
  - å½“æ‰§è¡Œå¤±è´¥æ—¶ï¼Œ```error```çš„å€¼ä¸ºé€šä¿¡å¤±è´¥çš„åŸå› ã€‚
  :::

### æ¶ˆæ¯ç»“æ„

è¿›ç¨‹é—´é€šä¿¡ä¼ è¾“çš„æ¶ˆæ¯å°†è¢«**ClusterCore**åŒ…è£…ä¸ºç”±å…ƒæ•°æ®```meta```å’Œè‡ªå®šä¹‰æ•°æ®```data```æ„æˆçš„```Object```ã€‚

å…ƒæ•°æ®```meta```ä¸­å­˜å‚¨äº†æ¶ˆæ¯çš„åŸºæœ¬ä¿¡æ¯ï¼Œé€šå¸¸ä¸è¢«ä¸šåŠ¡å±‚æ„ŸçŸ¥ï¼š

- ```traceId```ï¼šæ¶ˆæ¯çš„é“¾è·¯è¿½è¸ªIDã€‚

- ```toProcessId```ï¼š**æ¥æ”¶æ–¹**çš„è¿›ç¨‹IDã€‚

- ```fromProcessId```ï¼š**å‘é€æ–¹**çš„è¿›ç¨‹IDã€‚

- ```isRes```ï¼šæ˜¯å¦ä¸º[TraceIPC](#traceipc)çš„åº”ç­”æ¶ˆæ¯ã€‚

- ```isTransitRes```ï¼šæ˜¯å¦ä¸ºè½¬å‘ç»“æœçš„åº”ç­”æ¶ˆæ¯ã€‚

- ```transitTraceId```ï¼šè½¬å‘ç»“æœæ¶ˆæ¯çš„é“¾è·¯è¿½è¸ªIDã€‚

---

è‡ªå®šä¹‰æ•°æ®```data```ç”±ä¸šåŠ¡å±‚å®šä¹‰ï¼Œä¸»è¦ç”¨äºå­˜å‚¨ä¸šåŠ¡åŠŸèƒ½æ‰€éœ€çš„ä¿¡æ¯ï¼Œé€šå¸¸åŒ…æ‹¬**è§¦å‘åŠ¨ä½œ**å’Œ**é™„å±æ•°æ®**ã€‚

æˆ‘ä»¬åœ¨è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡æ—¶ï¼Œå¿…é¡»åœ¨è‡ªå®šä¹‰æ•°æ®ä¸­æŒ‡å®šæ¶ˆæ¯çš„**è§¦å‘åŠ¨ä½œ**ï¼Œå³```action```ã€‚å¦å¤–ï¼Œæ¨èä½¿ç”¨```payload```ä½œä¸º**é™„å±æ•°æ®**çš„é”®åã€‚

é€šå¸¸ï¼Œè¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯çš„å…ƒæ•°æ®ä¸å‘ä¸šåŠ¡å±‚æš´éœ²ã€‚åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ï¼Œ**ClusterCore**ä»…å‘ä¸šåŠ¡å±‚æŠ›å‡ºè‡ªå®šä¹‰æ•°æ®```data```ï¼š

- ```onProcessWillReceiveMessage()```ä¸­è¿›ç¨‹æ”¶åˆ°çš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ã€‚

- ```onProcessDidReceiveMessage()```ä¸­è¿›ç¨‹å†³å®šå¤„ç†çš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ã€‚

- ```onProcessDidDiscardMessage()```ä¸­è¿›ç¨‹å†³å®šä¸¢å¼ƒçš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ã€‚

- ```onProcessTraceMessageTimeout()```ä¸­è¶…æ—¶æœªè¢«åº”ç­”çš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ã€‚

- ```sendDataWithTraceCallBack()```ä¸­è§¦å‘```traceCallBack()```æ—¶æ”¶åˆ°çš„åº”ç­”æ¶ˆæ¯ã€‚

---

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```data.getOriginData()```åœ¨ä¸šåŠ¡å±‚ä¸­å–å¾—æ¶ˆæ¯çš„åŸå§‹ç»“æ„ä»¥è®¿é—®å…ƒæ•°æ®ï¼Œå³åŒ…å«```meta```å’Œ```data```çš„```Object```ã€‚

::: tip è¯´æ˜
åœ¨å®ç°åŸç†ä¸Šï¼Œ**ClusterCore**æ¥æ”¶åˆ°è¿›ç¨‹é—´é€šä¿¡çš„æ¶ˆæ¯æ—¶ï¼Œå°†å¯¹æ¶ˆæ¯ç»“æ„çš„åŸå§‹çŠ¶æ€è¿›è¡ŒDeep Copyç”Ÿæˆå¿«ç…§ï¼Œä¸šåŠ¡å±‚æ‰§è¡Œ```getOriginData()```æ—¶å°†å–å¾—æ­¤å¿«ç…§ã€‚

å› æ­¤ï¼Œåœ¨ä¸šåŠ¡å±‚ä¸­ä¿®æ”¹è‡ªå®šä¹‰æ•°æ®```data```å¹¶ä¸ä¼šå½±å“æ¶ˆæ¯çš„åŸå§‹ç»“æ„ã€‚
:::

å¦å¤–ï¼Œä¸šåŠ¡å±‚ä¸­çš„è‡ªå®šä¹‰æ•°æ®```data```å¯ä»¥ä½¿ç”¨```getTraceDetail()```è·å–æ¶ˆæ¯çš„é“¾è·¯è¿½è¸ªä¿¡æ¯ï¼Œç”¨äºåº”ç­”[TraceIPC](#traceipc)ã€‚

æ‰§è¡Œ```data.getTraceDetail()```å°†å¾—åˆ°ç»“æ„ä¸º```{ traceId, responsive, resTrace }```çš„```Object```ï¼Œå…¶ä¸­ï¼š

- ```traceId```ï¼šæ¶ˆæ¯çš„é“¾è·¯è¿½è¸ªIDã€‚

- ```responsive```ï¼šæ¶ˆæ¯æ˜¯å¦å¯åº”ç­”ã€‚

- ```resTrace```ï¼šæ¶ˆæ¯çš„å¿«æ·åº”ç­”æ–¹æ³•ï¼Œå…¶å‚æ•°åˆ—è¡¨ä¸º```(data[, callBack])```ã€‚

---

::: danger æ³¨æ„
åœ¨è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä»…éœ€æŒ‡å®šæ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®ï¼Œå³```data```ã€‚

ä¸ºé¿å…nodejsåœ¨è¿›ç¨‹é—´é€šä¿¡è¿‡ç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œçš„åºåˆ—åŒ–å¯¹æ¶ˆæ¯çš„å®Œæ•´æ€§äº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬åº”ä½¿ç”¨åŸºæœ¬ç±»å‹ç»„æˆ```data```ï¼š

- ```Array```
- ```Object```
- ```Number```
- ```String```
- ```Boolean```
:::

### IPC

å¯¹äºæ— éœ€å…³æ³¨**æ¥æ”¶æ–¹**åº”ç­”çš„å•å‘è¿›ç¨‹é—´é€šä¿¡ï¼Œä½¿ç”¨```sendData()```ç›´æ¥å‘ç›®æ ‡è¿›ç¨‹å‘é€æ¶ˆæ¯å³å¯ã€‚

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå•å‘è¿›ç¨‹é—´é€šä¿¡çš„ğŸŒ°ï¼š

```javascript
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // Masterè¿›ç¨‹ - åˆ›å»ºä¸¤ä¸ªWorkerè¿›ç¨‹
    if (processId === 'M') {
      Core.ClusterCore.fork(2);
    }
    // Workerè¿›ç¨‹ - åœ¨ä¸¤ä¸ªWorkerè¿›ç¨‹é—´è¿›è¡Œé€šä¿¡
    else {
      Core.ClusterCore.getAllProcessIds((err, processIds) => {
        if (err || processIds.length !== 3) {
          return;
        }
        const toProcessId = processIds[1];
        const fromProcessId = processIds[2];
        this.processId === fromProcessId && Core.ClusterCore.sendData(toProcessId, {
          // è®¾ç½®æ¶ˆæ¯çš„è§¦å‘åŠ¨ä½œ
          action: 'TEST_IPC_ACTION',
          // è®¾ç½®æ¶ˆæ¯çš„é™„å±æ•°æ®
          payload: { value: 'è¿™æ˜¯ä¸€ä¸ªğŸŒ°' }
        });
      });
    }
  }

  /**
   * è¿›ç¨‹ç¡®è®¤å¤„ç†è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯
   * @override
   */
  onProcessDidReceiveMessage(fromProcessId, data) {
    console.log(`è¿›ç¨‹[${this.processId}]å¤„ç†æ¥è‡ªè¿›ç¨‹[${fromProcessId}]çš„æ¶ˆæ¯:[${JSON.stringify(data)}]`);
  }
}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

### TraceIPC

å¯¹äºéœ€è¦**æ¥æ”¶æ–¹**åº”ç­”çš„åŒå‘çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦**å‘é€æ–¹**å’Œ**æ¥æ”¶æ–¹**è¿›è¡Œåä½œï¼š

- åœ¨**å‘é€æ–¹**[å‘èµ·TraceIPC](#å‘èµ·traceipc)ã€‚
- åœ¨**æ¥æ”¶æ–¹**[åº”ç­”TraceIPC](#åº”ç­”traceipc)ã€‚

#### å‘èµ·TraceIPC

---

**å‘é€æ–¹**ä½¿ç”¨```sendDataWithTraceCallBack()```å‘ç›®æ ‡è¿›ç¨‹å‘èµ·**TraceIPC**ã€‚

**ClusterCore**å°†åœ¨**å‘é€æ–¹**å‘èµ·**TraceIPC**æ—¶æ‰§è¡Œä¸‰ä¸ªæ“ä½œï¼š

1. ç”Ÿæˆ```traceId```å¡«å……è‡³å…ƒæ•°æ®```meta```ä¸­ä»¥è¿½è¸ª**TraceIPC**é“¾è·¯ã€‚

2. ä½¿ç”¨æ­¥éª¤â‘ ä¸­ç”Ÿæˆçš„```traceId```åœ¨å½“å‰è¿›ç¨‹ä¸­æ³¨å†Œæ­¤æ¬¡**TraceIPC**çš„è¿½è¸ªä¿¡æ¯ã€‚

   > å³ï¼šæ¶ˆæ¯**æ¥æ”¶æ–¹**çš„è¿›ç¨‹IDå’Œæ”¶åˆ°åº”ç­”æ¶ˆæ¯æ—¶æ‰§è¡Œçš„å›è°ƒå‡½æ•°```traceCallBack```ã€‚

3. å½“æ¥æ”¶åˆ°çš„æ¶ˆæ¯å…ƒæ•°æ®ä¸­åŒ…å«å·²è¢«æ³¨å†Œçš„```traceId```ä¸”æ¥æºæ–¹ä¸æ³¨å†Œä¿¡æ¯åŒ¹é…æ—¶ï¼Œè®¤ä¸ºæ­¤æ¶ˆæ¯ä¸º**TraceIPC**çš„åº”ç­”æ¶ˆæ¯ã€‚

   > æ­¤æ—¶å°†åˆ†å‘æ¶ˆæ¯è¿›å…¥ä¸```traceId```å¯¹åº”çš„```traceCallBack```å¹¶æ³¨é”€å…¶æ³¨å†ŒçŠ¶æ€ã€‚

::: tip æç¤º
æˆ‘ä»¬å¯ä»¥åœ¨å‘èµ·**TraceIPC**æ—¶æŒ‡å®šåˆ¤å®šåº”ç­”è¶…æ—¶çš„æ—¶é—´ï¼Œå½“**å‘é€æ–¹**åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ”¶åˆ°æ¥è‡ª**æ¥æ”¶æ–¹**çš„åº”ç­”æ¶ˆæ¯æ—¶ï¼Œå°†è‡ªåŠ¨æ³¨é”€æ­¤æ¬¡**TraceIPC**ä½¿ç”¨çš„```traceId```å¯¹åº”çš„æ³¨å†Œä¿¡æ¯å¹¶è§¦å‘**AppMain**ä¸­çš„```onProcessTraceMessageTimeout()```ä»¥å¯¹è¶…æ—¶æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚

å¦å¤–ï¼Œåœ¨**TraceIPC**è¶…æ—¶åï¼Œå¦‚æœæ”¶åˆ°äº†åº”ç­”æ¶ˆæ¯å°†ç›´æ¥è§¦å‘**AppMain**ä¸­çš„```onProcessDidDiscardMessage()```è¿›è¡Œèˆå¼ƒå¤„ç†ã€‚
:::

å¯¹äº```traceId```çš„ç»“æ„ï¼š

- ç”±24ä½å­—ç¬¦ç»„æˆã€‚
- å‰12ä½ä¸ºå½“å‰æ—¶é—´æˆ³çš„16è¿›åˆ¶è¡¨ç¤ºï¼Œä½æ•°ä¸è¶³å¡«å……```0```ã€‚
- ç¬¬13-16ä½ä¸ºå½“å‰è¿›ç¨‹PIDçš„16è¿›åˆ¶è¡¨ç¤ºï¼Œä½æ•°ä¸è¶³å¡«å……```0```ã€‚
- ç¬¬16-24ä½ä¸ºéšæœºæ•°ï¼Œä½æ•°ä¸è¶³å¡«å……```0```ã€‚

**ClusterCore**æ¯æ¬¡ç”Ÿæˆ```traceId```æ—¶ï¼Œå°†ä¸å½“å‰è¿›ç¨‹ä¸­å·²æ³¨å†Œçš„```traceId```è¿›è¡Œå†²çªæ£€éªŒï¼Œä»¥ä¿è¯å…¶è¿›ç¨‹çº§åˆ«çš„å”¯ä¸€æ€§ã€‚

#### åº”ç­”TraceIPC

---

**æ¥æ”¶æ–¹**åº”ç­”**TraceIPC**æ—¶éœ€è¦è¿›è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š

1. æ‰§è¡Œ```getTraceDetail()```å–å¾—æ¶ˆæ¯çš„é“¾è·¯è¿½è¸ªä¿¡æ¯ã€‚

2. ä½¿ç”¨é“¾è·¯è¿½è¸ªä¿¡æ¯ä¸­æä¾›çš„```resTrace()```å‘å‘é€åº”ç­”æ¶ˆæ¯ã€‚

::: tip æç¤º
é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨**æ¥æ”¶æ–¹**å¤„ç†è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨æ¶ˆæ¯çš„**è§¦å‘åŠ¨ä½œ**åˆ¤æ–­æ˜¯å¦éœ€è¦å‘**å‘é€æ–¹**å‘é€åº”ç­”æ¶ˆæ¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº”ç­”**TraceIPC**æ—¶ä»…å…è®¸åº”ç­”ä¸€æ¬¡ï¼Œé“¾è·¯è¿½è¸ªä¿¡æ¯ä¸­çš„```responsive```è¡¨ç¤ºæ˜¯å¦å…è®¸è¿›è¡Œåº”ç­”ã€‚
:::

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨**TraceIPC**çš„ğŸŒ°ï¼š

```javascript
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // Masterè¿›ç¨‹ - åˆ›å»ºä¸¤ä¸ªWorkerè¿›ç¨‹
    if (processId === 'M') {
      Core.ClusterCore.fork(2);
    }
    // Workerè¿›ç¨‹ - åœ¨ä¸¤ä¸ªWorkerè¿›ç¨‹é—´è¿›è¡Œé€šä¿¡
    else {
      Core.ClusterCore.getAllProcessIds((err, processIds) => {
        if (err || processIds.length !== 3) {
          return;
        }
        const toProcessId = processIds[1];
        const fromProcessId = processIds[2];
        // å‘èµ·TraceIPC
        this.processId === fromProcessId && Core.ClusterCore.sendDataWithTraceCallBack(toProcessId, {
          // è®¾ç½®æ¶ˆæ¯çš„è§¦å‘åŠ¨ä½œ
          action: 'TEST_TRACE_IPC_ACTION',
          // è®¾ç½®æ¶ˆæ¯çš„é™„å±æ•°æ®
          payload: { value: 'è¿™æ˜¯ä¸€ä¸ªğŸŒ°' }
        }, (resData, next) => {
          console.log(`TraceIPCæ”¶åˆ°äº†åº”ç­”æ¶ˆæ¯:[${JSON.stringify(resData)}]`);
          // ä½¿ç”¨next()åˆ†å‘åº”ç­”æ¶ˆæ¯è¿›å…¥AppMainä¸­çš„ç¡®è®¤å¤„ç†
          next();
        });
      });
    }
  }

  /**
   * è¿›ç¨‹ç¡®è®¤å¤„ç†è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯
   * @override
   */
  onProcessDidReceiveMessage(fromProcessId, data) {
    console.log(`è¿›ç¨‹[${this.processId}]å¤„ç†æ¥è‡ªè¿›ç¨‹[${fromProcessId}]çš„æ¶ˆæ¯:[${JSON.stringify(data)}]`);
    const { action, payload } = data;
    // ä½¿ç”¨actionåˆ¤æ–­æ˜¯å¦éœ€è¦åº”ç­”
    if (action === 'TEST_TRACE_IPC_ACTION') {
      const { value } = payload;
      // è·å–é“¾è·¯è¿½è¸ªä¿¡æ¯
      const { responsive, resTrace } = data.getTraceDetail();
      // å‘é€åº”ç­”æ¶ˆæ¯
      const resData = {
        action: 'TEST_TRACE_IPC_RES_ACTION',
        payload: { value: value + 'ğŸŒ°' }
      };
      responsive && resTrace(resData);
    }
  }
}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

### æ¶ˆæ¯å¤„ç†

::: tip è¯´æ˜
æœ¬ç« ä¸­ä½¿ç”¨çš„å®å˜é‡å­˜å‚¨åœ¨```Core.Macros```ä¸­ã€‚
:::

åœ¨æ”¶åˆ°è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯æ—¶ï¼Œ**ClusterCore**å°†æ ¹æ®è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯è‡ªå®šä¹‰æ•°æ®ä¸­çš„```action```å¯¹**å†…éƒ¨é€šä¿¡æ¶ˆæ¯**å’Œ**è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯**è¿›è¡Œé¢„åˆ†ç±»ï¼š

- å¯¹äº**è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯**ï¼Œå°†ç›´æ¥è¿›å…¥**AppMain**ä¸­è¿›è¡Œæ¶ˆæ¯å¤„ç†ã€‚

- å¯¹äº**å†…éƒ¨é€šä¿¡æ¶ˆæ¯**ï¼Œå°†ä»…æ‰§è¡Œå†…éƒ¨å¤„ç†ï¼Œä¸å†è¿›å…¥**AppMain**ä¸­çš„æ¶ˆæ¯å¤„ç†æµç¨‹ã€‚

---

è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯è‡ªå®šä¹‰æ•°æ®ä¸­çš„```action```æŒ‡å®šä¸ºä»¥ä¸‹å®å˜é‡æ—¶ï¼Œå°†è¢«**ClusterCore**è®¤ä¸ºæ˜¯**å†…éƒ¨é€šä¿¡æ¶ˆæ¯**ï¼Œæ­¤ç±»æ¶ˆæ¯ä¸ä¼šè¿›å…¥**AppMain**ä¸­çš„æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š

| å®å˜é‡                                                              | æè¿°                                                 |
| :------------------------------------------------------------------ | :--------------------------------------------------- |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_GET_INITIAL_INFO```     | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·è·å–åˆå§‹åŒ–ä¿¡æ¯             |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_GET_INITIAL_INFO```     | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”åˆå§‹åŒ–ä¿¡æ¯                 |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_SET_GLOBAL_OBJECT```    | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·è®¾ç½®å…¨å±€å¯¹è±¡               |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_SET_GLOBAL_OBJECT```    | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”è®¾ç½®å…¨å±€å¯¹è±¡æ‰§è¡Œç»“æœ       |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_GET_GLOBAL_OBJECT```    | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·è·å–å…¨å±€å¯¹è±¡               |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_GET_GLOBAL_OBJECT```    | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”è·å–å…¨å±€å¯¹è±¡æ‰§è¡Œç»“æœ       |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_REMOVE_GLOBAL_OBJECT``` | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·åˆ é™¤å…¨å±€å¯¹è±¡               |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_REMOVE_GLOBAL_OBJECT``` | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”åˆ é™¤å…¨å±€å¯¹è±¡æ‰§è¡Œç»“æœ       |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_GET_ALL_PROCESS_IDS```  | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·è·å–è¿›ç¨‹ç»„å†…çš„æ‰€æœ‰è¿›ç¨‹ID   |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_GET_ALL_PROCESS_IDS```  | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”è¿›ç¨‹ç»„å†…æ‰€æœ‰è¿›ç¨‹ID         |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_QUERY_GLOBAL_OBJECT```  | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·è‡ªå®šä¹‰è¯»å–å…¨å±€å¯¹è±¡         |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_QUERY_GLOBAL_OBJECT```  | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”è‡ªå®šä¹‰è¯»å–å…¨å±€å¯¹è±¡æ‰§è¡Œç»“æœ |
| ```CLUSTER_CORE_WORKER_TO_MASTER_ACTION_REQ_UPDATE_GLOBAL_OBJECT``` | Workerè¿›ç¨‹å‘Masterè¿›ç¨‹å‘èµ·è‡ªå®šä¹‰æ›´æ–°å…¨å±€å¯¹è±¡         |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_UPDATE_GLOBAL_OBJECT``` | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”è‡ªå®šä¹‰æ›´æ–°å…¨å±€å¯¹è±¡æ‰§è¡Œç»“æœ |
| ```CLUSTER_CORE_MASTER_TO_WORKER_ACTION_RES_TRANSIT_RESULT```       | Masterè¿›ç¨‹å‘Workerè¿›ç¨‹åº”ç­”é€šä¿¡æ¶ˆæ¯è½¬å‘ç»“æœ           |

---

æˆ‘ä»¬å¯ä»¥é‡å†™**AppMain**ä¸­æ¶ˆæ¯å¤„ç†ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä»¥å®šåˆ¶è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯çš„å¤„ç†æµç¨‹ã€‚

::: tip æç¤º
åœ¨æ¶ˆæ¯å¤„ç†çš„ç›¸å…³ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­ï¼Œä»…å¸¦å…¥è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®éƒ¨åˆ†ï¼Œå³```data```ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š

- ```data.getOriginData()```ï¼šè¯»å–å®Œæ•´çš„[æ¶ˆæ¯ç»“æ„](#æ¶ˆæ¯ç»“æ„)ã€‚

- ```data.getTraceDetail()```ï¼šè¯»å–æ¶ˆæ¯çš„é“¾è·¯è¿½è¸ªä¿¡æ¯ï¼Œå³æˆ‘ä»¬åœ¨[æ¶ˆæ¯ç»“æ„](#æ¶ˆæ¯ç»“æ„)ä¸­æåˆ°çš„```{ traceId, responsive, resTrace }```ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¶ˆæ¯å¤„ç†æµç¨‹åœ¨å®ç°ç»†èŠ‚ä¸Šä½¿ç”¨ä¸­é—´ä»¶æ¨¡å¼ï¼Œä»»ä½•å¯¹```data```æˆ–```originData```çš„ä¿®æ”¹å°†è¢«ä¿ç•™å¹¶åˆ†å‘è‡³åç»­çš„å¤„ç†æµç¨‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡å±‚åº”å°½é‡é¿å…ä¿®æ”¹æºæ¶ˆæ¯ã€‚
:::

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¨è®º**AppMain**ä¸­æ¶ˆæ¯å¤„ç†ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š

#### ```onProcessWillReceiveMessage(fromProcessId, data, next)```

##### å‚æ•°åˆ—è¡¨

- ```fromProcessId```ï¼šæ¶ˆæ¯**å‘é€æ–¹**çš„è¿›ç¨‹IDã€‚

- ```data```ï¼šæ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®ã€‚

- ```next```ï¼šæµç¨‹åˆ†å‘å‡½æ•°ã€‚æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„[ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯-5)ä¸­ä»‹ç»æµç¨‹åˆ†å‘å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ã€‚

##### ä½¿ç”¨åœºæ™¯

å½“å‰è¿›ç¨‹æ¥æ”¶åˆ°**è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯**æ—¶è§¦å‘æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­å¯¹è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯è¿›è¡Œåˆ†æµï¼Œä½¿ç”¨æµç¨‹æ§åˆ¶å‡½æ•°```next()```ç¡®è®¤æˆ–èˆå¼ƒæ”¶åˆ°çš„æ¶ˆæ¯ã€‚

- æ‰§è¡Œ```next()```ï¼šç¡®è®¤è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ï¼Œåˆ†å‘æºæ¶ˆæ¯è¿›å…¥```onProcessDidReceiveMessage()```ã€‚æ˜¯```onProcessWillReceiveMessage()```çš„é»˜è®¤è¡Œä¸ºã€‚

- æ‰§è¡Œ```next(data)```ï¼šç¡®è®¤è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ï¼Œå°†```next()```å¸¦å…¥çš„```data```è¦†ç›–æºæ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®```data```ä¸­çš„```payload```å¹¶```onProcessDidReceiveMessage()```ã€‚

- æ‰§è¡Œ```next(CLUSTER_CORE_MESSAGE_COMMAND_DISCARD)```ï¼šèˆå¼ƒè¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯ï¼Œåˆ†å‘æºæ¶ˆæ¯è¿›å…¥```onProcessDidDiscardMessage()```ã€‚

::: tip æç¤º
**Masterè¿›ç¨‹**å’Œ**Workerè¿›ç¨‹**æ”¶åˆ°**è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯**æ—¶éƒ½å°†è§¦å‘**AppMain**ä¸­çš„```onProcessWillReceiveMessage()```ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸æ ¹æ®æ¶ˆæ¯çš„```action```å®ç°åˆ†æµé€»è¾‘ï¼Œæ— éœ€å…³æ³¨å½“å‰è¿è¡Œè¿›ç¨‹ç¯å¢ƒã€‚
:::

---

#### ```onProcessDidReceiveMessage(fromProcessId, data)```

##### å‚æ•°åˆ—è¡¨

- ```fromProcessId```ï¼šæ¶ˆæ¯**å‘é€æ–¹**çš„è¿›ç¨‹IDã€‚

- ```data```ï¼šæ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®ã€‚

##### ä½¿ç”¨åœºæ™¯

æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æœ‰ä¸¤ç§è§¦å‘æ–¹å¼ï¼š

- å½“å‰è¿›ç¨‹ä¸­æ”¶åˆ°çš„**è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯**åœ¨åˆ†æµé˜¶æ®µè¢«ç¡®è®¤ã€‚
- å½“å‰è¿›ç¨‹ä¸­æ”¶åˆ°çš„**TraceIPC**åº”ç­”æ¶ˆæ¯è§¦å‘çš„```traceCallBack()```ä¸­æ‰§è¡Œäº†```next()```ã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­æ ¹æ®æ¶ˆæ¯çš„```action```å®ç°æ¶ˆæ¯è§¦å‘çš„å®é™…ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚ï¼š[åº”ç­”TraceIPC](#åº”ç­”traceipc)ç­‰ã€‚

---

#### ```onProcessDidDiscardMessage(fromProcessId, data)```

##### å‚æ•°åˆ—è¡¨

- ```fromProcessId```ï¼šæ¶ˆæ¯**å‘é€æ–¹**çš„è¿›ç¨‹IDã€‚

- ```data```ï¼šæ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®ã€‚

##### ä½¿ç”¨åœºæ™¯

æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æœ‰ä¸¤ç§è§¦å‘æ–¹å¼ï¼š

- å½“å‰è¿›ç¨‹ä¸­æ”¶åˆ°çš„**è‡ªå®šä¹‰é€šä¿¡æ¶ˆæ¯**åœ¨åˆ†æµé˜¶æ®µè¢«èˆå¼ƒã€‚
- å½“å‰è¿›ç¨‹ä¸­åœ¨**TraceIPC**è¶…æ—¶åæ”¶åˆ°äº†åº”ç­”æ¶ˆæ¯ã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­å¯¹è¢«èˆå¼ƒçš„è¿›ç¨‹é—´é€šä¿¡æ¶ˆæ¯è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚

---

#### ```onProcessTraceMessageTimeout(toProcessId, data)```

##### å‚æ•°åˆ—è¡¨

- ```fromProcessId```ï¼šè¶…æ—¶çš„**TraceIPC**æ¶ˆæ¯**æ¥æ”¶æ–¹**çš„è¿›ç¨‹IDã€‚

- ```data```ï¼šæ¶ˆæ¯çš„è‡ªå®šä¹‰æ•°æ®ã€‚

##### ä½¿ç”¨åœºæ™¯

å½“å‰è¿›ç¨‹å‘èµ·**TraceIPC**ä¸”åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ”¶åˆ°**æ¥æ”¶æ–¹**åº”ç­”æ—¶è§¦å‘æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å¯¹è¶…æ—¶çš„**TraceIPC**æ¶ˆæ¯è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚ï¼šé‡æ–°å°è¯•å‘èµ·**TraceIPC**ç­‰ã€‚

## å…¨å±€å¯¹è±¡

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨å¤šè¿›ç¨‹æ¶æ„çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¸åŒçš„è¿›ç¨‹æ‹¥æœ‰å®Œå…¨ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹å†…çš„çŠ¶æ€å®Œå…¨éš”ç¦»ã€‚å› æ­¤ï¼ŒCorejsæä¾›äº†åœ¨è¿›ç¨‹ç»„ä¸­å…±äº«çŠ¶æ€çš„èƒ½åŠ›ï¼Œå³ï¼š**å…¨å±€å¯¹è±¡**ã€‚

::: warning æ³¨æ„
**å…¨å±€å¯¹è±¡**ä»…é™äºåœ¨å•ä¸ªåº”ç”¨ç¨‹åºä¸­çš„å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«æ•°æ®ï¼Œæ— æ³•å–ä»£åˆ†å¸ƒå¼åè°ƒå·¥å…·ï¼Œæ¯”å¦‚ï¼š```ZooKeeper```ã€```Redis```ç­‰ã€‚
:::

### APIè®¾è®¡

åœ¨å®ç°ç»†èŠ‚ä¸Šï¼Œ**å…¨å±€å¯¹è±¡**æ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨**Masterè¿›ç¨‹**ä¸­çš„```Object```ï¼Œ**Workerè¿›ç¨‹**é€šè¿‡[è¿›ç¨‹é—´é€šä¿¡](#è¿›ç¨‹é—´é€šä¿¡)å‘**Masterè¿›ç¨‹**å‘èµ·è¯»å†™æŒ‡ä»¤ä»¥å®ç°å¯¹**å…¨å±€å¯¹è±¡**çš„è®¿é—®ã€‚

::: tip æç¤º
å› æ­¤ï¼Œ**å…¨å±€å¯¹è±¡**ä¸­å€¼çš„ç±»å‹å—åˆ¶äºè¿›ç¨‹é—´é€šä¿¡æ—¶nodejsè‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–çš„å½±å“ã€‚

ä¸ºé¿å…åºåˆ—åŒ–é€ æˆçš„é—®é¢˜ï¼Œæˆ‘ä»¬è®¾ç½®å…¨å±€å¯¹è±¡æ—¶åŒæ ·åº”ä½¿ç”¨åŸºæœ¬ç±»å‹æ„æˆçš„```field```ï¼Œå³ï¼š

- ```Array```
- ```Object```
- ```Number```
- ```String```
- ```Boolean```
:::


**ClusterCore**æä¾›äº†å¯¹**å…¨å±€å¯¹è±¡**è¿›è¡Œç®€å•è¯»å†™æ“ä½œçš„APIï¼š

- [```getGlobalObject([keyPath], callBack)```](#getglobalobject-keypath-callback)ï¼šè¯»å–**å…¨å±€å¯¹è±¡**ä¸­æŒ‡å®šé”®åæˆ–é”®è·¯å¾„å¯¹åº”çš„å€¼ã€‚

- [```setGlobalObject(keyPath[, value][, callBack])```](#setglobalobject-keypath-value-callback)ï¼šè®¾ç½®/æ›´æ–°**å…¨å±€å¯¹è±¡**ä¸­æŒ‡å®šé”®åæˆ–é”®è·¯å¾„æŒ‡å‘çš„```field```ã€‚

- [```removeGlobalObject(keyPath[, callBack])```](#removeglobalobject-keypath-callback)ï¼šç§»é™¤**å…¨å±€å¯¹è±¡**ä¸­æŒ‡å®šé”®åæˆ–é”®è·¯å¾„æŒ‡å‘çš„```field```ã€‚

---

#### ```getGlobalObject([keyPath], callBack)```

##### ä½¿ç”¨è¯´æ˜

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```getGlobalObject()```è¯»å–æ•´ä¸ª**å…¨å±€å¯¹è±¡**ï¼Œæˆ–è¯»å–**å…¨å±€å¯¹è±¡**ä¸­æŒ‡å®šé”®å/é”®è·¯å¾„å¯¹åº”çš„å€¼ã€‚

##### å‚æ•°åˆ—è¡¨

- ```keyPath```ï¼šæœŸæœ›è¯»å–çš„é”®åæˆ–é”®è·¯å¾„ï¼Œéå¿…å¡«é¡¹ã€‚æŒ‡å®šé”®è·¯å¾„æ—¶ï¼Œä½¿ç”¨é”®åé“¾è·¯å­—ç¬¦ä¸²æ„æˆçš„```Array```å³å¯ã€‚

  > å½“æ­¤é¡¹æœªæŒ‡å®šæˆ–æŒ‡å®šä¸º```null```ã€```undefined```ã€```NaN```ã€```''```ã€```[]```ã€```{}```æ—¶å°†è¯»å–æ•´ä¸ª**å…¨å±€å¯¹è±¡**ã€‚

  ::: tip æç¤º
  å°è¯•è¯»å–**å…¨å±€å¯¹è±¡**æ—¶ï¼Œå¦‚æœé”®è·¯å¾„ä¸­å­˜åœ¨é”®åæŒ‡å‘çš„```field```ä¸å­˜åœ¨æˆ–æŒ‡å‘çš„å€¼ä¸ä¸ºå¼•ç”¨ç±»å‹ï¼Œåˆ™å°†åœ¨```callBack```ä¸­å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸ã€‚
  :::

- ```callBack```ï¼šè¯»å–**å…¨å±€å¯¹è±¡**çš„æ‰§è¡Œç»“æœï¼Œå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(error, value)```ï¼š

  - ```error```ï¼šè¯»å–**å…¨å±€å¯¹è±¡**å¤±è´¥çš„åŸå› ï¼Œä¸º```null```æ—¶è¡¨ç¤ºè¯»å–åŠ¨ä½œæ‰§è¡ŒæˆåŠŸã€‚
  - ```value```ï¼šåœ¨**å…¨å±€å¯¹è±¡**ä¸­è¯»å–åˆ°çš„å€¼ï¼Œå½“æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ä¸º```undefined```ã€‚
    > éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹å€¼ä¸ºå¼•ç”¨ç±»å‹çš„```field```ä¸­ä¸å­˜åœ¨çš„é”®åè¿›è¡Œå–å€¼æ—¶ä¹Ÿå°†å¾—åˆ°```undefined```ã€‚

  ::: tip è¯´æ˜
  åœ¨æ‰§è¡Œ```getGlobalObject()```æ—¶ï¼Œå³ä½¿æ²¡æœ‰æŒ‡å®š```callBack```ä¹Ÿä¸ä¼šäº§ç”Ÿé˜»å¡æ€§å¼‚å¸¸ã€‚
  
  å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œåœ¨æ£€æµ‹åˆ°æ²¡æœ‰æŒ‡å®š```calllBack```æ—¶å°†ç›´æ¥é€€å‡ºï¼Œä¸å†è§¦å‘å®é™…è¯»å–é€»è¾‘ã€‚
  :::

---

#### ```setGlobalObject(keyPath[, value][, callBack])```

::: tip æç¤º
æœ¬èŠ‚ä¸­ä½¿ç”¨çš„å®å˜é‡å­˜å‚¨åœ¨```Core.Macros```ä¸­ã€‚
:::

##### ä½¿ç”¨è¯´æ˜

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```setGlobalObject()```è®¾ç½®æˆ–æ›´æ–°æŒ‡å®šé”®åæˆ–é”®è·¯å¾„æŒ‡å‘çš„```field```ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆ[æ•°ç»„æŒ‡ä»¤](#æ•°ç»„æŒ‡ä»¤)å¿«é€Ÿå¯¹**å…¨å±€å¯¹è±¡**ä¸­çš„```Array```è¿›è¡Œæ“ä½œã€‚

##### å‚æ•°åˆ—è¡¨

- ```keyPath```ï¼šæœŸæœ›è®¾ç½®æˆ–æ›´æ–°çš„é”®åæˆ–é”®è·¯å¾„ï¼Œå¿…å¡«é¡¹ã€‚æŒ‡å®šé”®è·¯å¾„æ—¶ï¼Œä½¿ç”¨é”®åé“¾è·¯å­—ç¬¦ä¸²æ„æˆçš„```Array```å³å¯ã€‚

  ::: tip è¯´æ˜
  ```setGlobalObject()```ä¸å…è®¸å¯¹**å…¨å±€å¯¹è±¡**è¿›è¡Œä¸å®‰å…¨çš„å†™å…¥ï¼Œåœ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œæ—¶å°†åœ¨```callBack```ä¸­å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼š

  - å°è¯•åœ¨ä¸å­˜åœ¨çš„```field```ä¸­åˆ›å»ºæ–°```field```ã€‚
  - å°è¯•åœ¨å€¼ä¸ºéå¼•ç”¨ç±»å‹çš„```field```ä¸­åˆ›å»ºæ–°```field```ã€‚
  :::

- ```value```ï¼šæœŸæœ›è®¾ç½®/æ›´æ–°çš„é”®å€¼æˆ–[æ•°ç»„æŒ‡ä»¤](#æ•°ç»„æŒ‡ä»¤)çš„å‚æ•°ï¼Œéå¿…å¡«é¡¹ã€‚

  ::: tip è¯´æ˜
  åœ¨æ‰§è¡Œ```setGlobalObject()```æ—¶ï¼Œå°†æ ¹æ®ä¸šåŠ¡å±‚å®é™…ä½¿ç”¨çš„å‚æ•°åˆ—è¡¨åŠ¨æ€ç”Ÿæˆä¸€ä¸ªå‚æ•°```Array```ä»¥ä½œä¸º```value```ï¼š

  - å½“å‚æ•°åˆ—è¡¨ä¸­æœ€åä¸€ä¸ªå‚æ•°ä¸º```Function```æ—¶ï¼Œä½¿ç”¨ä¸šåŠ¡å±‚å®é™…ä½¿ç”¨çš„å‚æ•°åˆ—è¡¨ä¸­ä»ç¬¬äºŒä¸ªå‚æ•°è‡³å€’æ•°ç¬¬äºŒä¸ªå‚æ•°ä½œä¸º```value```ã€‚
  - å½“å‚æ•°åˆ—è¡¨ä¸­æœ€åä¸€ä¸ªå‚æ•°ä¸ºé```Function```æ—¶ï¼Œä½¿ç”¨å‚æ•°åˆ—è¡¨ä¸­ç¬¬äºŒä¸ªå‚æ•°è‡³å€’æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸º```value```ã€‚

  ---

  æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œ```value```æ˜¯ä¸€ä¸ª```Array```ï¼Œå¯¹äº```value```çš„åº”ç”¨äº**å…¨å±€å¯¹è±¡**çš„æ•ˆæœï¼š
  
  - åœ¨æŒ‡å®šçš„```keyPath```ä¸­ä¸åŒ…å«[æ•°ç»„æŒ‡ä»¤](#æ•°ç»„æŒ‡ä»¤)æ—¶ï¼Œå°†```value.pop()```çš„å€¼è®¾ç½®è‡³æŒ‡å®šçš„```keyPath```ä¸­ã€‚
  - åœ¨æŒ‡å®šçš„```keyPath```ä¸­ä½¿ç”¨äº†[æ•°ç»„æŒ‡ä»¤](#æ•°ç»„æŒ‡ä»¤)æ—¶ï¼Œå°†```...value```ä½œä¸º**æ•°ç»„æŒ‡ä»¤**çš„æ‰§è¡Œå‚æ•°åº”ç”¨è‡³æŒ‡å®šçš„```keyPath```ä¸­ã€‚

  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€äº›æ— éœ€å‚æ•°å³å¯æ‰§è¡Œçš„**æ•°ç»„æŒ‡ä»¤**å¯ä»¥ä¸ä¼ å…¥```value```ï¼Œæ¯”å¦‚ï¼š

  - ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_POP```
  - ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_SHIFT```
  - ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_REVERSE```
  :::

- ```callBack```ï¼šè®¾ç½®æˆ–æ›´æ–°**å…¨å±€å¯¹è±¡**çš„æ‰§è¡Œç»“æœï¼Œéå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(error, detail)```ï¼š

  - ```error```ï¼šè®¾ç½®æˆ–æ›´æ–°**å…¨å±€å¯¹è±¡**å¤±è´¥çš„åŸå› ï¼Œä¸º```null```æ—¶è¡¨ç¤ºæ“ä½œæ‰§è¡ŒæˆåŠŸã€‚
  - ```detail```ï¼šè®¾ç½®æˆ–æ›´æ–°**å…¨å±€å¯¹è±¡**çš„æ“ä½œè¯¦æƒ…ï¼Œå…¶ç»“æ„ä¸º```{ globalObject, commandResult }```ã€‚

  ::: tip è¯´æ˜
  å¯¹äºè®¾ç½®æˆ–æ›´æ–°**å…¨å±€å¯¹è±¡**çš„æ“ä½œè¯¦æƒ…ï¼š

  - ```globalObject```ï¼šæ‰§è¡Œè®¾ç½®æˆ–æ›´æ–°æ“ä½œåçš„**å…¨å±€å¯¹è±¡**ï¼Œå½“è®¾ç½®/æ›´æ–°æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ä¸º```undefined```ã€‚
  - ```commandResult```ï¼š**æ•°ç»„æŒ‡ä»¤**çš„æ‰§è¡Œç»“æœï¼Œå½“æ²¡æœ‰ä½¿ç”¨**æ•°ç»„æŒ‡ä»¤**æˆ–è®¾ç½®/æ›´æ–°æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ä¸º```undefined```ã€‚
    > å¯¹ç©ºæ•°ç»„ä½¿ç”¨```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_POP```æŒ‡ä»¤ï¼Œä¹Ÿå°†å¾—åˆ°```undefined```ã€‚
  :::

##### ä½¿ç”¨æ ·ä¾‹

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨```setGlobalObject()```è®¾ç½®**å…¨å±€å¯¹è±¡**çš„ğŸŒ°ï¼š

```javascript
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // ä¸»è¿›ç¨‹ä¸­åˆ›å»ºé”®åä¸ºprocessDetail.Mçš„fieldå­˜å‚¨å…¶è¿›ç¨‹pid
    if (processId === 'M') {
      // é¦–å…ˆåˆ›å»ºé”®åprocessDetailæŒ‡å‘çš„field
      Core.ClusterCore.setGlobalObject('processDetail', {}, (err) => {
        if (err) {
          return;
        }
        // åœ¨åˆ›å»ºé¦–å±‚fieldæˆåŠŸåå†™å…¥ä¸»è¿›ç¨‹çš„pidå¹¶æ´¾ç”Ÿå­è¿›ç¨‹
        Core.ClusterCore.setGlobalObject(['processDetail', 'M'], process.pid);
        Core.ClusterCore.fork(4);
      });
    }
    // å­è¿›ç¨‹ä¸­åˆ›å»ºé”®åä¸ºprocessDetail.[è¿›ç¨‹åç§»]çš„fieldå­˜å‚¨å…¶è¿›ç¨‹pid
    else {
      const processOffset = processId.split(':').pop();
      Core.ClusterCore.setGlobalObject(['processDetail', processOffset], process.pid);
    }
  }
}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

---

æˆ‘ä»¬å¯ä»¥åœ¨```onProcessDidInit()```ä¸­ä½¿ç”¨```getGlobalObject()```æ£€æŸ¥è®¾ç½®**å…¨å±€å¯¹è±¡**çš„æˆæœï¼š

```javascript
// æŸ¥çœ‹å…¨å±€å¯¹è±¡çš„è®¾ç½®ç»“æœ
setTimeout(() => {
  const fieldName = processId === 'M' ? 'M' : processId.split(':').pop();
  const keyPath = ['processDetail', fieldName];
  Core.ClusterCore.getGlobalObject(keyPath, (err, value) => {
    !err && console.log(`è¿›ç¨‹[${fieldName}]çš„PID -> ${value}`);
  });
}, 1000);
```

#### æ•°ç»„æŒ‡ä»¤

åœ¨```setGlobalObject()```æ—¶ï¼Œå¦‚æœæŒ‡å®šçš„**é”®è·¯å¾„**å¯¹åº”äº†**å…¨å±€å¯¹è±¡**ä¸­çš„å€¼ä¸º```Array```ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨**é”®è·¯å¾„**ä¸­è¿½åŠ ä»¥ä¸‹**æ•°ç»„æŒ‡ä»¤**ä»¥å¿«æ·å®ç°æ•°ç»„å˜å¼‚æ“ä½œï¼š

| æ•°ç»„æŒ‡ä»¤                                          | ä½œç”¨                                          |
| :------------------------------------------------ | :-------------------------------------------- |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_POP```        | åˆ é™¤æ•°ç»„å°¾éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³æ‰§è¡Œ```pop()```   |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_PUSH```       | å‘æ•°ç»„å°¾éƒ¨è¿½åŠ æ–°å…ƒç´ ï¼Œå³æ‰§è¡Œ```push()```      |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_FILL```       | æ•°ç»„å¡«å……ï¼Œå³æ‰§è¡Œ```fill()```                  |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_SHIFT```      | åˆ é™¤æ•°ç»„å¤´éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³æ‰§è¡Œ```shift()``` |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_SPLICE```     | å¯¹æ•°ç»„æ‰§è¡Œé“°æ¥æ“ä½œï¼Œå³æ‰§è¡Œ```splice()```      |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_UNSHIFT```    | å‘æ•°ç»„å¤´éƒ¨æ·»åŠ æ–°å…ƒç´ ï¼Œå³æ‰§è¡Œ```unshift()```   |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_REVERSE```    | æ•°ç»„ç¿»è½¬ï¼Œå³æ‰§è¡Œ```reverse()```               |
| ```CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_COPYWITHIN``` | æ•°ç»„å†…éƒ¨æ›¿æ¢ï¼Œå³æ‰§è¡Œ```copywhthin()```        |

##### ä½¿ç”¨æ ·ä¾‹

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªåœ¨```setGlobalObject()```ä½¿ç”¨**æ•°ç»„æŒ‡ä»¤**è®¾ç½®**å…¨å±€å¯¹è±¡**çš„ğŸŒ°ï¼š

```javascript
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // åœ¨ä¸»è¿›ç¨‹ä¸­åˆ›å»ºé”®åä¸ºprocessDetailçš„field,å¹¶æ¨å…¥ä¸»è¿›ç¨‹ä¿¡æ¯
    if (processId === 'M') {
      // é¦–å…ˆåˆ›å»ºé”®åprocessDetailæŒ‡å‘çš„field
      Core.ClusterCore.setGlobalObject('processDetail', [], (err) => {
        if (err) {
          return;
        }
        // åœ¨åˆ›å»ºé¦–å±‚fieldæˆåŠŸåæ¨å…¥ä¸»è¿›ç¨‹ä¿¡æ¯å¹¶æ´¾ç”Ÿå­è¿›ç¨‹
        Core.ClusterCore.setGlobalObject(
          ['processDetail', Core.Macros.CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_PUSH],
          { processId, processPid: process.pid }
        );
        Core.ClusterCore.fork(4);
      });
    }
    // å­è¿›ç¨‹ä¸­å°†å­è¿›ç¨‹ä¿¡æ¯æ¨å…¥processDetailæŒ‡å‘çš„field
    else {
      Core.ClusterCore.setGlobalObject(
        ['processDetail', Core.Macros.CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_PUSH],
        { processId, processPid: process.pid }
      );
    }
  }
}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

---

åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨```onProcessDidInit()```ä¸­ä½¿ç”¨```getGlobalObject()```æ£€æŸ¥è®¾ç½®**å…¨å±€å¯¹è±¡**çš„æˆæœï¼š

```javascript
// æŸ¥çœ‹å…¨å±€å¯¹è±¡çš„è®¾ç½®ç»“æœ
setTimeout(() => {
  Core.ClusterCore.getGlobalObject((err, value) => {
    if (err) {
      return;
    }
    console.log(`å½“å‰åº”ç”¨ç¨‹åºä¸­çš„å…¨å±€å¯¹è±¡ä¸º -> ${JSON.stringify(value)}`);
  });
}, 1000);
```

#### ```removeGlobalObject(keyPath[, callBack])```

##### ä½¿ç”¨è¯´æ˜

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨```removeGlobalObject()```ç§»é™¤æŒ‡å®šé”®åæˆ–é”®è·¯å¾„æŒ‡å‘çš„```field```ã€‚

##### å‚æ•°åˆ—è¡¨

- ```keyPath```ï¼šæœŸæœ›ç§»é™¤çš„é”®åæˆ–é”®è·¯å¾„ï¼Œå¿…å¡«é¡¹ã€‚æŒ‡å®šé”®è·¯å¾„æ—¶ï¼Œä½¿ç”¨é”®åé“¾è·¯å­—ç¬¦ä¸²æ„æˆçš„```Array```å³å¯ã€‚

  ::: tip è¯´æ˜
  ```removeGlobalObject()```å°†å› æœŸæœ›ç§»é™¤çš„é”®åæˆ–é”®è·¯å¾„å¯¹åº”çš„å€¼ç±»å‹æœ‰ä¸åŒçš„åˆ é™¤è¡Œä¸ºï¼š
  
  - å½“é”®åæˆ–é”®è·¯å¾„å¯¹åº”çš„å€¼ä¸º```Array```æ—¶ï¼Œå¦‚æœæœŸæœ›ç§»é™¤çš„é”®åä¸º```Number```ï¼Œåˆ™æ‰§è¡Œ```splice()```ç§»é™¤é”®åå¯¹åº”ä½ç½®çš„å…ƒç´ ã€‚
  - å…¶ä½™åœºæ™¯ä¸‹ï¼Œåœ¨æœŸæœ›ç§»é™¤çš„é”®åæ‰€å¤„çš„**å…¨å±€å¯¹è±¡**ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ```delete```æ“ä½œã€‚

  å¦‚æœé”®è·¯å¾„ä¸­å­˜åœ¨é”®åæŒ‡å‘çš„```field```ä¸å­˜åœ¨æˆ–æŒ‡å‘çš„å€¼ä¸ä¸ºå¼•ç”¨ç±»å‹ï¼Œåˆ™å°†åœ¨```callBack```ä¸­å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸ã€‚
  :::

- ```callBack```ï¼š**å…¨å±€å¯¹è±¡**ç§»é™¤æ“ä½œçš„æ‰§è¡Œç»“æœï¼Œéå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(error, detail)```ï¼š

  - ```error```ï¼š**å…¨å±€å¯¹è±¡**ç§»é™¤æ“ä½œæ‰§è¡Œå¤±è´¥çš„åŸå› ï¼Œä¸º```null```æ—¶è¡¨ç¤ºæ“ä½œæ‰§è¡ŒæˆåŠŸã€‚
  - ```globalObject```ï¼šæ‰§è¡Œç§»é™¤æ“ä½œåçš„**å…¨å±€å¯¹è±¡**ï¼Œå½“æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ä¸º```undefined```ã€‚


##### ä½¿ç”¨æ ·ä¾‹

è®©æˆ‘ä»¬åŸºäºè®¾ç½®**å…¨å±€å¯¹è±¡**çš„æ ·ä¾‹ï¼Œæ¥ä½¿ç”¨```removeGlobalObject()```åˆ é™¤**å…¨å±€å¯¹è±¡**ä¸­æŒ‡å®šçš„```field```ï¼š

```javascript {22-32}
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // ä¸»è¿›ç¨‹ä¸­åˆ›å»ºé”®åä¸ºprocessDetail.Mçš„fieldå­˜å‚¨å…¶è¿›ç¨‹pid
    if (processId === 'M') {
      // é¦–å…ˆåˆ›å»ºé”®åprocessDetailæŒ‡å‘çš„field
      Core.ClusterCore.setGlobalObject('processDetail', {}, (err) => {
        if (err) {
          return;
        }
        // åœ¨åˆ›å»ºé¦–å±‚fieldæˆåŠŸåå†™å…¥ä¸»è¿›ç¨‹çš„pidå¹¶æ´¾ç”Ÿå­è¿›ç¨‹
        Core.ClusterCore.setGlobalObject(['processDetail', 'M'], process.pid);
        Core.ClusterCore.fork(4);
      });

      // å°è¯•åˆ é™¤å…¨å±€å¯¹è±¡ä¸­çš„field
      setTimeout(()=>{
        // ç§»é™¤processDetail.MæŒ‡å‘çš„field
        Core.ClusterCore.removeGlobalObject(['processDetail', 'M'], (err, globalObject) => {
          !err && console.log(`ç§»é™¤processDetail.Måçš„å…¨å±€å¯¹è±¡ -> ${JSON.stringify(globalObject)}`);
        });
        // ç§»é™¤processDetailæŒ‡å‘çš„field
        Core.ClusterCore.removeGlobalObject('processDetail', (err, globalObject) => {
          !err && console.log(`ç§»é™¤processDetailåçš„å…¨å±€å¯¹è±¡ -> ${JSON.stringify(globalObject)}`);
        });
      }, 1000);
    }
    // å­è¿›ç¨‹ä¸­åˆ›å»ºé”®åä¸ºprocessDetail.[è¿›ç¨‹åç§»]çš„fieldå­˜å‚¨å…¶è¿›ç¨‹pid
    else {
      const processOffset = processId.split(':').pop();
      Core.ClusterCore.setGlobalObject(['processDetail', processOffset], process.pid);
    }
  }
}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

### æ•°æ®ä¸€è‡´æ€§

åœ¨å¤šè¿›ç¨‹æ¶æ„ä¸‹ï¼Œå¯¹**å…¨å±€å¯¹è±¡**çš„å¹¶å‘æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ä¸ºä¿è¯æ“ä½œ**å…¨å±€å¯¹è±¡**çš„äº‹åŠ¡æ€§ï¼Œ**ClusterCore**æä¾›äº†å¯¹**å…¨å±€å¯¹è±¡**è¿›è¡Œè‡ªå®šä¹‰äº‹åŠ¡æ“ä½œçš„APIï¼š

- [```queryGlobalObject([context,] [queryFn,] callBack)```](#queryglobalobject-context-queryfn-callback)ï¼šè‡ªå®šä¹‰è¯»å–**å…¨å±€å¯¹è±¡**ã€‚

- [```updateGlobalObject([context,] updateFn[, callBack])```](#updateglobalobject-context-updatefn-callback)ï¼šè‡ªå®šä¹‰æ›´æ–°**å…¨å±€å¯¹è±¡**ã€‚

::: danger æ³¨æ„
**è‡ªå®šä¹‰è¯»å–/æ›´æ–°å…¨å±€å¯¹è±¡çš„APIåœ¨Masterè¿›ç¨‹ä¸­ä½¿ç”¨Sandboxä¸¥æ ¼åŒæ­¥æ‰§è¡Œä»£ç ç‰‡æ®µçš„æ–¹å¼ä»¥ä¿è¯å…¨å±€å¯¹è±¡åœ¨åŒä¸€æ—¶åˆ»ä»…è¢«ä¸€ä¸ªæ“ä½œè®¿é—®ã€‚**

å› æ­¤ï¼Œæ“ä½œè§„åˆ™```queryFn```å’Œ```updateFn```ä¸­**ä¸å…è®¸æ‰§è¡Œå¼‚æ­¥é€»è¾‘**ä¹Ÿ**æ— æ³•è®¿é—®å¤–éƒ¨å˜é‡**ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡```context```å°†å¤–éƒ¨èµ„æºæ¤å…¥Sandboxã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ```context```å—åˆ¶äºè¿›ç¨‹é—´é€šä¿¡æ—¶nodejsè‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–çš„å½±å“ï¼Œåº”ä½¿ç”¨åŸºæœ¬ç±»å‹æ„æˆï¼Œå³ï¼š

- ```Array```
- ```Object```
- ```Number```
- ```String```
- ```Boolean```
:::

#### ```queryGlobalObject([context,] [queryFn,] callBack)```

##### ä½¿ç”¨è¯´æ˜

åœ¨è‡ªå®šä¹‰è¯»å–**å…¨å±€å¯¹è±¡**æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

- ```queryGlobalObject(callBack)```ï¼šé€‚ç”¨äºç›´æ¥è¯»å–æ•´ä¸ª**å…¨å±€å¯¹è±¡**çš„åœºæ™¯ã€‚

- ```queryGlobalObject(queryFn, callBack)```ï¼šé€‚ç”¨äºä½¿ç”¨ä¸è®¿é—®ä»»ä½•å¤–éƒ¨èµ„æºçš„è‡ªå®šä¹‰è§„åˆ™è¯»å–**å…¨å±€å¯¹è±¡**çš„åœºæ™¯ã€‚

- ```queryGlobalObject(context, queryFn, callBack)```ï¼šé€‚ç”¨äºä½¿ç”¨ä¾èµ–å¤–éƒ¨èµ„æºçš„è‡ªå®šä¹‰è§„åˆ™è¯»å–**å…¨å±€å¯¹è±¡**çš„åœºæ™¯ã€‚

##### å‚æ•°åˆ—è¡¨

- ```context```ï¼šåº”ç”¨äºè¯»å–è§„åˆ™çš„èµ„æºä¸Šä¸‹æ–‡ï¼Œéå¿…å¡«é¡¹ã€‚

- ```queryFn```ï¼š**å…¨å±€å¯¹è±¡**çš„è‡ªå®šä¹‰è¯»å–è§„åˆ™ï¼Œéå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ª```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(globalObject, context)```ï¼š

  - ```globalObject```ï¼šæ‰§è¡Œè¯»å–æ“ä½œæ—¶åº”ç”¨ç¨‹åºä¸­**å…¨å±€å¯¹è±¡**çš„å¿«ç…§ã€‚
  - ```context```ï¼šå¤–éƒ¨èµ„æºä¸Šä¸‹æ–‡ã€‚å½“æ‰§è¡Œè‡ªå®šä¹‰è¯»å–æ“ä½œæœªæŒ‡å®šèµ„æºä¸Šä¸‹æ–‡æ—¶ï¼Œåˆ™æ­¤å€¼ä¸º```undefined```ã€‚

  ::: danger æ³¨æ„
  **ClusterCore**å°†åœ¨æœªæŒ‡å®šè‡ªå®šä¹‰è¯»å–è§„åˆ™```queryFn```æ—¶è¿”å›æ•´ä¸ª**å…¨å±€å¯¹è±¡**ã€‚å¦å¤–ï¼Œ```queryFn```ä¸­**ä¸å…è®¸æ‰§è¡Œå¼‚æ­¥é€»è¾‘**ä¹Ÿ**æ— æ³•è®¿é—®å¤–éƒ¨å˜é‡**ã€‚

  é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨```queryFn```ä¸­æ ¹æ®å¤–éƒ¨ä¾èµ–èµ„æº```context```å¯¹```globalObject```è¿›è¡Œè§£æå’Œè®¡ç®—ï¼Œå¹¶å°†æœŸæœ›çš„æ•°æ®ç»“æ„ä½¿ç”¨```return```æŒ‡ä»¤è¿”å›ã€‚
  :::

- ```callBack```ï¼šè‡ªå®šä¹‰è¯»å–**å…¨å±€å¯¹è±¡**çš„æ‰§è¡Œç»“æœï¼Œå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(error, value)```ï¼š

  - ```error```ï¼šè‡ªå®šä¹‰è¯»å–**å…¨å±€å¯¹è±¡**å¤±è´¥çš„åŸå› ï¼Œä¸º```null```æ—¶è¡¨ç¤ºè¯»å–åŠ¨ä½œæ‰§è¡ŒæˆåŠŸã€‚
  - ```value```ï¼šè‡ªå®šä¹‰è¯»å–è§„åˆ™çš„è¿”å›å€¼ï¼Œå³```queryFn```ä¸­```return```çš„ç»“æœï¼Œå½“æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ä¸º```undefined```ã€‚

  ::: tip è¯´æ˜
  åœ¨æ‰§è¡Œ```queryGlobalObject()```æ—¶ï¼Œå³ä½¿æ²¡æœ‰æŒ‡å®š```callBack```ä¹Ÿä¸ä¼šäº§ç”Ÿé˜»å¡æ€§å¼‚å¸¸ã€‚
  
  å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œåœ¨æ£€æµ‹åˆ°æ²¡æœ‰æŒ‡å®š```calllBack```æ—¶å°†ç›´æ¥é€€å‡ºï¼Œä¸å†è§¦å‘å®é™…è¯»å–é€»è¾‘ã€‚
  :::

##### ä½¿ç”¨æ ·ä¾‹

è®©æˆ‘ä»¬åŸºäºä½¿ç”¨**æ•°ç»„æŒ‡ä»¤**è®¾ç½®å…¨å±€å¯¹è±¡çš„æ ·ä¾‹ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨```queryGlobalObject()```è‡ªå®šä¹‰è¯»å–**å…¨å±€å¯¹è±¡**ï¼š

```javascript {33-53}
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // åœ¨ä¸»è¿›ç¨‹ä¸­åˆ›å»ºé”®åä¸ºprocessDetailçš„field,å¹¶æ¨å…¥ä¸»è¿›ç¨‹ä¿¡æ¯
    if (processId === 'M') {
      // é¦–å…ˆåˆ›å»ºé”®åprocessDetailæŒ‡å‘çš„field
      Core.ClusterCore.setGlobalObject('processDetail', [], (err) => {
        if (err) {
          return;
        }
        // åœ¨åˆ›å»ºé¦–å±‚fieldæˆåŠŸåæ¨å…¥ä¸»è¿›ç¨‹ä¿¡æ¯å¹¶æ´¾ç”Ÿå­è¿›ç¨‹
        Core.ClusterCore.setGlobalObject(
          ['processDetail', Core.Macros.CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_PUSH],
          { processId, processPid: process.pid }
        );
        Core.ClusterCore.fork(4);
      });
    }
    // å­è¿›ç¨‹ä¸­å°†å­è¿›ç¨‹ä¿¡æ¯æ¨å…¥processDetailæŒ‡å‘çš„field
    else {
      Core.ClusterCore.setGlobalObject(
        ['processDetail', Core.Macros.CLUSTER_CORE_GLOBAL_OBJECT_ARRAY_PUSH],
        { processId, processPid: process.pid }
      );
    }

    // è‡ªå®šä¹‰è¯»å–å…¨å±€å¯¹è±¡
    setTimeout(() => {
      // å®šä¹‰è¯»å–è§„åˆ™ä¸­ä¾èµ–çš„å¤–éƒ¨å˜é‡ä¸ºèµ„æºä¸Šä¸‹æ–‡
      const context = { processId };
      Core.ClusterCore.queryGlobalObject(
        // è®¾ç½®å¤–éƒ¨èµ„æºä¸Šä¸‹æ–‡
        context,
        // è®¾ç½®è‡ªå®šä¹‰è¯»å–è§„åˆ™
        (globalObject, context) => {
          const { processId } = context;
          const { processDetail } = globalObject;
          return processDetail.find((detail) => detail.processId === processId);
        },
        // å¤„ç†è¯»å–ç»“æœ
        (err, value) => {
          if (err) {
            return;
          }
          console.log(`å½“å‰è¿›ç¨‹çš„ä¿¡æ¯ -> ${JSON.stringify(value)}`);
        });
    }, 1000);
  }
}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```

#### ```updateGlobalObject([context,] updateFn[, callBack])```

##### ä½¿ç”¨è¯´æ˜

åœ¨è‡ªå®šä¹‰æ›´æ–°**å…¨å±€å¯¹è±¡**æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

- ```updateGlobalObject(updateFn)```ï¼šé€‚ç”¨äºç›´æ¥æ›´æ–°**å…¨å±€å¯¹è±¡**ä¸å…³æ³¨æ‰§è¡Œç»“æœçš„åœºæ™¯ã€‚

- ```updateGlobalObject(context, updateFn)```ï¼šé€‚ç”¨äºä½¿ç”¨ä¾èµ–å¤–éƒ¨èµ„æºçš„è‡ªå®šä¹‰è§„åˆ™æ›´æ–°**å…¨å±€å¯¹è±¡**ä½†ä¸å…³æ³¨æ‰§è¡Œç»“æœçš„åœºæ™¯ã€‚

- ```updateGlobalObject(context, updateFn, callBack)```ï¼šé€‚ç”¨äºä½¿ç”¨ä¾èµ–å¤–éƒ¨èµ„æºçš„è‡ªå®šä¹‰è§„åˆ™æ›´æ–°**å…¨å±€å¯¹è±¡**çš„åœºæ™¯ã€‚

##### å‚æ•°åˆ—è¡¨

- ```context```ï¼šåº”ç”¨äºæ›´æ–°è§„åˆ™çš„èµ„æºä¸Šä¸‹æ–‡ï¼Œéå¿…å¡«é¡¹ã€‚

- ```updateFn```ï¼š**å…¨å±€å¯¹è±¡**çš„è‡ªå®šä¹‰æ›´æ–°è§„åˆ™ï¼Œå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ª```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(globalObject, context)```ï¼š

  - ```globalObject```ï¼šæ‰§è¡Œæ›´æ–°æ“ä½œæ—¶åº”ç”¨ç¨‹åºä¸­**å…¨å±€å¯¹è±¡**çš„å¿«ç…§ã€‚
  - ```context```ï¼šå¤–éƒ¨èµ„æºä¸Šä¸‹æ–‡ã€‚å½“æ‰§è¡Œè‡ªå®šä¹‰æ›´æ–°æ“ä½œæœªæŒ‡å®šèµ„æºä¸Šä¸‹æ–‡æ—¶ï¼Œåˆ™æ­¤å€¼ä¸º```undefined```ã€‚

  ::: tip æç¤º
  è‡ªå®šä¹‰æ›´æ–°è§„åˆ™```updateFn```ä¸­**ä¸å…è®¸æ‰§è¡Œå¼‚æ­¥é€»è¾‘**ä¹Ÿ**æ— æ³•è®¿é—®å¤–éƒ¨å˜é‡**ã€‚**ClusterCore**å°†ä½¿ç”¨```Object.assign()```å°†```updateFn```çš„æ‰§è¡Œç»“æœåº”ç”¨è‡³**å…¨å±€å¯¹è±¡**ã€‚

  é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨```updateFn```ä¸­æ ¹æ®å¤–éƒ¨ä¾èµ–èµ„æº```context```å’Œå½“å‰```globalObject```å®Œæˆè§£æå’Œè®¡ç®—ï¼Œå¹¶é€šè¿‡ä½¿ç”¨```Spread```ç­‰æ“ä½œç¬¦é‡ç»„æ–°çš„**å…¨å±€å¯¹è±¡**ä½¿ç”¨```return```æŒ‡ä»¤è¿”å›ã€‚
  :::

- ```callBack```ï¼šè‡ªå®šä¹‰æ›´æ–°**å…¨å±€å¯¹è±¡**çš„æ‰§è¡Œç»“æœï¼Œéå¿…å¡«é¡¹ï¼Œæ˜¯ä¸€ä¸ªcpsé£æ ¼çš„```Function```ã€‚å…¶å‚æ•°åˆ—è¡¨ä¸º```(error, globalObject)```ï¼š

  - ```error```ï¼šè‡ªå®šä¹‰æ›´æ–°**å…¨å±€å¯¹è±¡**å¤±è´¥çš„åŸå› ï¼Œä¸º```null```æ—¶è¡¨ç¤ºæ›´æ–°åŠ¨ä½œæ‰§è¡ŒæˆåŠŸã€‚
  - ```globalObject```ï¼šè‡ªå®šä¹‰æ›´æ–°æ“ä½œæ‰§è¡ŒæˆåŠŸåçš„**å…¨å±€å¯¹è±¡**ï¼Œå½“æ“ä½œæ‰§è¡Œå¤±è´¥æ—¶ä¸º```undefined```ã€‚

##### ä½¿ç”¨æ ·ä¾‹

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å€ŸåŠ©**å…¨å±€å¯¹è±¡**æ¥å®ç°ä¸€ä¸ªåœ¨è¿›ç¨‹ç»„ä¸­ç«äº‰èµ„æºçš„Demoï¼š

```javascript
const Core = require('node-corejs');

class AppMain extends Core.AppMain {
  /**
   * è¿›ç¨‹åˆå§‹åŒ–å®Œæˆ
   * @override
   */
  onProcessDidInit(processId, launchParams) {
    super.onProcessDidInit(processId, launchParams);
    // åœ¨ä¸»è¿›ç¨‹ä¸­è®¾ç½®èµ„æºæ€»æ•°ä¸º9
    // åˆ›å»º8ä¸ªWorkerè¿›ç¨‹å¯¹èµ„æºè¿›è¡Œç«äº‰
    if (processId === 'M') {
      Core.ClusterCore.setGlobalObject('totalCount', 9, (err) => {
        if (err) {
          return;
        }
        Core.ClusterCore.fork(8);
      });
    }
    // åœ¨å­è¿›ç¨‹ä¸­ç«äº‰èµ„æº,å¹¶å…³é—­æœªè·å¾—èµ„æºçš„è¿›ç¨‹
    // åç§»ä¸ºå¥‡æ•°çš„è¿›ç¨‹å ç”¨1ä¸ªèµ„æº
    // åç§»ä¸ºå¶æ•°çš„è¿›ç¨‹å ç”¨2ä¸ªèµ„æº
    else {
      // è®¡ç®—è¿›ç¨‹åç§»å¹¶å®šä¹‰æ›´æ–°è§„åˆ™ä¾èµ–çš„èµ„æºä¸Šä¸‹æ–‡
      const processOffset = parseInt(processId.split(':').pop());
      const context = { processOffset };
      Core.ClusterCore.updateGlobalObject(
        // è®¾ç½®å¤–éƒ¨èµ„æºä¸Šä¸‹æ–‡
        context,
        // è®¾ç½®è‡ªå®šä¹‰æ›´æ–°è§„åˆ™
        (globalObject, context) => {
          let { totalCount } = globalObject;
          const { processOffset } = context;

          // æ ¹æ®è¿›ç¨‹åç§»å°è¯•å¯¹èµ„æºè¿›è¡Œé¢„å ä½
          if (processOffset % 2) {
            totalCount -= 1;
          } else {
            totalCount -= 2;
          }

          // å½“èµ„æºä¸è¶³æ—¶æŠ›å‡ºå¼‚å¸¸,ä¸æ”¹å˜å…¨å±€å¯¹è±¡
          if (totalCount < 0) {
            throw new Error('èµ„æºä¸è¶³');
          }
          // èµ„æºé¢„å ä½æˆåŠŸæ—¶æ›´æ–°å…¨å±€å¯¹è±¡æ‰£é™¤å¯¹åº”çš„èµ„æº
          else {
            return {
              ...globalObject,
              totalCount,
            };
          }
        },
        // å¤„ç†æ›´æ–°ç»“æœ
        (err, globalObject) => {
          // å½“æ›´æ–°å…¨å±€å¯¹è±¡å¤±è´¥æ—¶è¯´æ˜ç«äº‰èµ„æºå¤±è´¥,é€€å‡ºè¿›ç¨‹
          err && process.exit();
          console.log(`è¿›ç¨‹[${processId}]è·å–èµ„æºæˆåŠŸï¼Œå½“å‰å‰©ä½™èµ„æº -> ${globalObject.totalCount}`);
        }
      )
    }
  }

  /**
   * Workerè¿›ç¨‹é€€å‡º
   * @override
   */
  onWorkerProcessDidExit(exitedProcessId, exitedDetail, reboot) {
    console.log(`è¿›ç¨‹[${exitedProcessId}]å› æœªè·å–åˆ°èµ„æºé€€å‡º`);
  }

}

// ä½¿ç”¨AppMainåˆå§‹åŒ–ClusterCoreå¹¶å¯åŠ¨
Core.ClusterCore.init(AppMain);
Core.ClusterCore.start();
```
