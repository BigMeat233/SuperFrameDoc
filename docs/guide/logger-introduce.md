# 日志输出器

::: tip 说明
本章中使用的宏变量如果没有特殊描述，则存储在```Core.Macros```中。
:::

## 输出模型

[输出模型](/images/test.png)

## 输出器配置

通常，我们实例化**日志输出器**时需要指定由**运行环境**、**最小输出等级**和**功能参数**构成的配置对象，即：**```{ env, level, params }```**。

- **```env```**：**日志输出器**的**运行环境**，默认值为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```。

  ::: tip 说明
  通常，**运行环境**将影响**日志输出器**的输出行为：

  - 当**运行环境**为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，**日志输出器**将日志统一输出至控制台。

  - 当**运行环境**非```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，**日志输出器**将日志输出至由其本身功能实现而指向的目标位置。

  **我们在[自定义输出器](/guide/logger-customizing.html)时同样应该遵守在运行环境为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时输出日志到控制台的准则。**
  :::

- **```level```**：**最小输出等级**（支持使用输出等级的全称或别名），**日志输出器**仅输出权重大于等于此输出等级的日志。

  **最小输出等级**的默认值依赖于**日志输出器**的**运行环境**：

  - 当**运行环境**为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，默认值为```'all'```。

  - 当**运行环境**非```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，默认值为```'error'```。
  
  ::: tip 说明 
  当**最小输出等级**不在**日志输出器**的**输出等级支持列表**中时，**日志输出器**将使用[等级选举](#等级选举)产生的**默认日志等级**。

  我们可以在[输出等级](#输出等级)一节中了解**日志输出器**原生支持的输出等级。
  :::

- **```params```**：控制**日志输出器**的输出行为的**功能参数**，不同类型的**日志输出器**通常拥有不同的功能参数。

  ::: tip 提示
  **功能参数将在日志输出器实例化时被缓存在实例属性```params```中。**
  
  因此，我们在[自定义输出器](/guide/logger-customizing.html)时可以使用**功能参数**的缓存机制存储一些**自定义参数**，以使其在整个输出器生命周期的任意阶段中共享。
  
  **需要注意的是，为了避免对日志输出器的行为产生影响，我们在使用自定义参数时不要使用与已有功能参数相同的键名。**
  :::

## 输出等级

我们可以使用**输出等级名称**和**输出等级别名**指定**输出等级**。

**日志输出器**默认支持6个**输出等级**：

| 日志类型 | 名称          | 别名                    | 权重        |
| :------- | :------------ | :---------------------- | :---------- |
| 追踪日志 | ```'trace'``` | ```'t'```               | ```10000``` |
| 调试日志 | ```'debug'``` | ```'t'```               | ```20000``` |
| 信息日志 | ```'infos'``` | ```'i'```、```'info'``` | ```30000``` |
| 警告日志 | ```'warns'``` | ```'w'```、```'warn'``` | ```40000``` |
| 错误日志 | ```'error'``` | ```'e'```、```'err'```  | ```50000``` |
| 灾难日志 | ```'fatal'``` | ```'f'```               | ```60000``` |

另外，**日志输出器**使用2个内部**输出等级**用于等级限定：

| 限定规则     | 等级名称    | 等级别名  | 等级权重     |
| :----------- | :---------- | :-------- | :----------- |
| 保留所有日志 | ```'all'``` | ```'a'``` | ```0```      |
| 禁止所有日志 | ```'off'``` | ```'o'``` | ```100000``` |

---

**日志输出器**内部使用4个**基准输出等级**：

- **最小输出等级**（通过配置对象指定）

- **默认日志等级**（通过配置对象中的功能参数指定）

- **默认警告日志等级**（通过配置对象中的功能参数指定）

- **默认错误日志等级**（通过配置对象中的功能参数指定）

当**基准输出等级**未指定，或指定的值不在**输出等级支持列表**中时，将使用[等级选举](#等级选举)的结果。

## 等级选举

**日志输出器**将自动进行**等级选举**以在**输出等级支持列表**中选出**基准输出等级**的默认值。一旦某个**基准输出等级**无效，则应用选举结果。

::: warning 注意
**等级选举**将产生绝对有效的**默认日志等级**、**默认警告日志等级**和**默认错误日志等级**，但是**日志输出器**不会应用全部的选举结果。

比如，当我们指定的**默认日志等级**无效，但**默认警告日志等级**和**默认错误日志等级**有效时，**日志输出器**仅使用选举结果中的**默认日志等级**。

另外，**当最小输出等级无效时将使用选举结果中的默认日志等级。**
:::

---

输出等级选举规则为：

1. 迭代**输出等级支持列表**，尝试在配置了```default```为```true```的**输出等级**中选择权重最高项作为**默认日志等级**。

2. 若上述步骤未能产生**默认日志等级**（比如：**输出等级支持列表**中不存在```default```为```true```的**输出等级**），则使用**输出等级支持列表**中权重居中项作为**默认日志等级**。

3. 若上述步骤产生了两个**权重居中**的**输出等级**，则使用**权重较小项**（两者中前者）作为**默认日志等级**。

4. 选举比**默认日志等级**权重大一个梯度的输出等级（即**输出等级支持列表**按权重升序排列后位于**默认日志等级**后一个位置的**输出等级**）作为**默认警告日志等级**。

5. 若上述步骤未能产生**默认警告日志等级**（比如：**默认日志等级**位于**输出等级支持列表**的最末位），则使用**默认日志等级**作为**默认警告日志等级**。 

6. 选举比**默认日志等级**权重大二个梯度的输出等级（即**输出等级支持列表**按权重升序排列后位于**默认日志等级**后二个位置的**输出等级**）作为**默认错误日志等级**。

7. 若上述步骤未能产生**默认错误日志等级**（比如：**默认日志等级**位于**输出等级支持列表**的最末位或倒数第二位），则使用**默认警告日志等级**作为**默认错误日志等级**。

## 基础输出器

**基础输出器**抽象了**日志输出器**基本的**生命周期管理**和**输出链路控制**，是**日志输出器**的基类。

通过**基础输出器**输出的日志最终将打印至控制台。因此，**基础输出器通常不用于生产环境的日志收集。**

::: warning 注意
我们实现的[自定义输出器](/guide/logger-customizing.html)必须继承自**基础输出器**，否则在使用时将**无法通过类型校验**。
:::

### 功能说明

1. 输出的日志将被打印至控制台。

2. 支持自启动。即：**基础输出器**实例化后自动启动，无需显式执行实例方法```start```即可执行输出动作。

3. 执行实例方法```start```、```close```和```log```时自动进行状态检测。
   
   - **执行实例方法```log```时**：检测当前是否处于启动状态，若**实例未启动则放弃此次日志输出**。

   - **执行实例方法```start```时**：检测当前是否处于启动状态，若**实例已启动则不再执行启动逻辑**。

   - **执行实例方法```close```时**：检测当前是否处于关闭状态，若**实例已关闭则不再执行关闭逻辑**。

   ::: tip 说明
   通常，**日志输出器**仅提供实例方法```start```、```close```和```log```以被业务层调用。
   
   在业务层执行**日志输出器**提供的实例方法时**默认进行状态检测**，未通过状态检测或执行链路中产生异常时将抛出异常信息。

   我们可以通过实例化**日志输出器**时指定[功能参数](#功能参数)以控制是否进行状态检测和捕获异常信息。
   :::

4. 实例方法```log```支持多种调用方式以快捷输出日志。

   | 调用方式                            | 说明                                                             |
   | :---------------------------------- | :--------------------------------------------------------------- |
   | ```log(message)```                  | 根据日志内容智能选择**输出等级**，且根据实际调用栈获取调用方法名 |
   | ```log(level, message)```           | 使用指定的**输出等级**输出日志，且根据实际调用栈获取调用方法名   |
   | ```log(level, funcName, message)``` | 使用指定的**输出等级**和方法名输出日志                           |

   ::: tip 说明

   使用```log(message)```方式输出日志时，**日志输出器**将根据日志内容```message```自动选择**输出等级**：

   - **当```message```非```Error```类型**：使用**默认日志等级**输出日志。
   - **当```message```为```Error```类型**：使用**默认错误日志等级**输出日志。
   
   ---

   在**日志输出器**执行输出动作时，如果实际应用的**输出等级**权重高于或等于**默认错误日志等级**时，将在日志内容中附加调用栈：

   - **当```message```非```Error```类型时**：使用执行实例方法```log```时的实际调用栈。
   - **当```message```为```Error```类型时**：使用```Error```实例携带的调用栈。

   我们可以通过在**日志输出器**实例化时配置[```callStackOffset```](#callstackoffset)以调整自动构建调用栈时的偏移基准。
   :::

### 功能参数

- #### ```template```
  
  设置此配置将指定**日志输出器**的**输出模板**，默认值为：```BASE_LOGGER_MESSAGE_DEFAULT_TEMPLATE```，即：```'[${timestamp}] [${env} LOG] [${level}] - <${funcName}><${content}>\n'```。

  ::: tip 说明
  宏变量```BASE_LOGGER_MESSAGE_DEFAULT_TEMPLATE```存储在```Core.Messages```中。
  :::

  我们在指定**输出模板**时，可以使用```${}```引用日志的**内容元素**，默认支持：

  | 内容元素           | 说明                                   |
  | :----------------- | :------------------------------------- |
  | ```${env}```       | 当前运行环境                           |
  | ```${level}```     | 日志输出等级                           |
  | ```${content}```   | 日志内容（可能由日志消息和调用栈组成） |
  | ```${funcName}```  | 调用方法名                             |
  | ```${timestamp}``` | 时间戳字符串                           |

- #### ```defaultLevel```

  设置此配置将指定**日志输出器**的**默认日志等级**，默认值为：```null```。我们可以使用[输出等级](#输出等级)的**名称**或**别名**作为**默认日志等级**。
  
  当指定此配置为```null```或指定了不在**输出等级支持列表**中的值时，将使用[等级选举](#等级选举)产生的**默认日志等级**。

  ::: tip 应用场景
  在以下场景中，**日志输出器**将自动应用**默认日志等级**：

  - **日志输出器**配置的**最小输出等级**不在**输出等级支持列表**中时，将使用**默认日志等级**作为**最小输出等级**。
  
  - **日志输出器**使用```log(message)```方式输出日志，且日志内容```message```不为```Error```类型时，将使用**默认日志等级**输出日志。
  
  - **日志输出器**使用```log(level[, funcName], message)```方式输出日志，且指定的**输出等级**不在**输出等级支持列表**中时，将使用**默认日志等级**输出日志。
  :::

  让我们来看一个有关**默认日志等级**的🌰：

  ```javascript
  const Core = require('node-corejs');

  // 创建基础输出器
  const logger = new Core.BaseLogger({
    level: 'x', // 此时最小输出等级无效,将应用默认日志等级error
    params: { defaultLevel: 'error' },
  });

  logger.log('i', '此条日志不会被输出');             // infos日志权重小于当前的最小输出等级error
  logger.log('这是一条红色的错误日志');               // 不指定输出等级时将使用默认等级error
  logger.log('x', '这是一条红色的错误日志');          // 输出等级无效时将使用默认等级error
  logger.log('x', '方法名', '这是一条红色的错误日志'); // 输出等级无效时将使用默认等级error
  ```

- #### ```defaultWarnsLevel```

  设置此配置将指定**日志输出器**的**默认警告日志等级**，默认值为：```null```。我们可以使用[输出等级](#输出等级)的**名称**或**别名**作为**默认警告日志等级**。
  
  当指定此配置为```null```或指定了不在**输出等级支持列表**中的值时，将使用[等级选举](#等级选举)产生的**默认警告日志等级**。

  ::: tip 说明
  **默认警告日志等级**是**日志输出器**的预留属性，并没有在实际业务中使用。
  
  我们可以在[自定义输出器](/guide/logger-customizing.html)时，将内部产生的异常使用**默认警告日志等级**输出。
  :::

- #### ```defaultErrorLevel```

  设置此配置将指定**日志输出器**的**默认错误日志等级**，默认值为：```null```。我们可以使用[输出等级](#输出等级)的**名称**或**别名**作为**默认错误日志等级**。
  
  当指定此配置为```null```或指定了不在**输出等级支持列表**中的值时，将使用[等级选举](#等级选举)产生的**默认错误日志等级**。

  ::: tip 应用场景
  在以下场景中，**日志输出器**将自动应用**默认错误日志等级**：

  - **日志输出器**使用```log(message)```方式输出日志，且日志内容```message```为```Error```类型时，将使用**默认错误日志等级**输出日志。
  
  - **日志输出器**使用```log(level[, funcName], message)```方式输出日志，且指定的**输出等级**的权重高于或等于**默认错误日志等级**的权重时，将在日志内容中附加调用栈。
  :::

  让我们来看一个有关**默认错误日志等级**的🌰：

  ```javascript
  const Core = require('node-corejs');

  // 创建基础输出器
  const logger = new Core.BaseLogger({
    params: { defaultErrorLevel: 'i' } // 指定infos为默认错误等级
  });

  logger.log(new Error('这是一条绿色且包含调用栈的错误日志'));        // Error类型的日志内容将以infos等级输出
  logger.log('i', new Error('这是一条绿色且包含调用栈的错误日志'));   // 指定infos及以上的输出等级时将在日志内容中添加调用栈
  logger.log('d', new Error('这是一条蓝色且不包含调用栈的错误日志')); // debug等级的权重小于infos因此不在日志内容中添加调用栈
  ```

- #### ```callStackOffset```

  设置此配置将指定**日志输出器**构建实际调用栈时使用的**偏移基准**，默认值为：```BASE_LOGGER_DEFAULT_CALLSTACK_OFFSET```，即：```0```，此时将取得实例方法```log```之前的调用栈记录。

  ::: tip 说明
  **偏移基准**仅作用于**日志输出器**自动构建实际调用栈的场景，不会影响```Error```类型日志内容的调用栈提取。
  :::

  ---

  我们可以根据实际场景调整**偏移基准**以控制调用栈提取内容：
  
  - **使用```Function```类型的偏移基准**：**日志输出器**自动构建调用栈时将仅提取在**偏移基准**之上的调用栈记录。

    ::: warning 注意
    **日志输出器使用```Error.captureStackTrace```提取调用栈，如果偏移基准指定的```Function```不在调用链路中则将取得空调用栈。**
    :::
  
  - **使用```Number```类型的偏移基准**：**日志输出器**首先提取实例方法```log```之前的调用栈记录，接下来通过```slice```应用**偏移基准**中指定的偏移量以取得调用栈。

    ::: warning 注意
    因nodejs默认限制，**日志输出器**使用```Error.captureStackTrace```最大仅能提取实例方法```log```之前的```Error.stackTraceLimit```条调用栈记录。**偏移基准将以此为基础进行偏移，使调用栈信息量降低。**
    :::

  我们可以使用**日志输出器**的某个原型方法作为**偏移基准**：

  ```javascript
  const Core = require('node-corejs');

  // 创建基础输出器
  const logger = new Core.BaseLogger({
    params: {
      // 使用原型方法作为偏移基准
      callStackOffset: Core.BaseLogger.prototype.buildCallSnapshot
    }
  });

  logger.log('e', '非Error类型日志内容将应用偏移基准');
  logger.log(new Error('Error类型日志内容不受偏移基准影响'));
  ```

- #### ```_checkStateInLog```

  设置此配置将指定**日志输出器**在执行实例方法```log```时是否检查输出器状态，默认值为：```true```。

  通常，**日志输出器的状态（开启/关闭）应与输出动作所需资源的创建与否具有相关性**，因此引入了此配置以在执行输出动作时检查输出器状态。
  
  ::: tip 提示
  启用此配置后，如果**日志输出器**在执行输出动作时处于关闭状态，则抛出类型为```BASE_LOGGER_ERROR_TYPE_CANT_LOG```的异常信息且不再执行后续的实际输出链路。
  
  我们可以设置**异常处理器**[```_errorHandler```](#errorhandler)以捕获和处理状态检查失败时抛出的异常。
  :::

  ::: warning 注意
  我们在[自定义输出器](/guide/logger-customizing.html)时需要注意：
  
  **对于输出链路中存在异步操作的日志输出器，仅在执行实例方法```log```时检查输出器状态无法保证输出动作所需资源的有效性**，应在操作资源时进行有效性校验或进行异常捕获。
  :::

- #### ```_checkStateInStart```

  设置此配置将指定**日志输出器**在执行实例方法```start```时是否检查输出器状态，默认值为：```true```。

  ::: danger 警告
  **日志输出器**默认开启此配置用于避免资源创建逻辑多次执行，请谨慎调整此配置。
  :::

  ::: tip 提示
  启用此配置后，如果**日志输出器**在执行启动动作时已处于启动状态，则抛出类型为```BASE_LOGGER_ERROR_TYPE_CANT_START```的异常信息且不再执行后续的实际启动逻辑。

  我们可以设置**异常处理器**[```_errorHandler```](#errorhandler)以捕获和处理状态检查失败时抛出的异常。
  :::

- #### ```_checkStateInClose```

  设置此配置将指定**日志输出器**在执行实例方法```close```时是否检查输出器状态，默认值为：```true```。

  ::: danger 警告
  **日志输出器**默认开启此配置用于避免资源释放逻辑多次执行，请谨慎调整此配置。
  :::

  ::: tip 提示
  启用此配置后，如果**日志输出器**在执行关闭动作时已处于关闭状态，则抛出类型为```BASE_LOGGER_ERROR_TYPE_CANT_CLOSE```的异常信息且不再执行后续的实际关闭逻辑。

  我们可以设置**异常处理器**[```_errorHandler```](#errorhandler)以捕获和处理状态检查失败时抛出的异常。
  :::

- #### ```_errorHandler```
  
  设置此配置将指定**日志输出器**的**异常处理器**。

  ::: tip 说明
  **日志输出器将自动捕获关键动作中产生的异常并调用实例方法```onError```，默认将直接触发异常处理器**。
  
  通常，我们在[自定义输出器](/guide/logger-customizing.html)时应根据**关键动作**实际逻辑的同步或异步指定对应的实例方法为```Function```或```AsyncFunction```，在其中使用```throw```即可直接触发异常处理，**日志输出器**将自动根据产生异常的**关键动作**计算其类型。

  对于**需要自定义类型**或**无法通过```throw```抛出**的异常，我们可以直接调用实例方法```onError```。
  :::

  **异常处理器**接收一个参数列表为```(errType, errDetail)```的```Function```：

  - **```errType```**：异常的类型，为```String```。
    
    **日志输出器**将根据产生异常的**关键动作**计算其类型：

    | 异常类型                                | 描述                       | 产生原因                 |
    | :-------------------------------------- | :------------------------- | :----------------------- |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_LOG```   | 日志输出器无法执行输出动作 | 日志输出链路中产生了异常 |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_INIT```  | 日志输出器无法构建和实例化 | 输出器初始化时产生了异常 |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_START``` | 日志输出器无法启动         | 输出器启动时产生了异常   |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_CLOSE``` | 日志输出器无法关闭         | 输出器关闭时产生了异常   |
  
  - **```errDetail```**：异常的细节信息，为```Object```。

    通常，**细节信息的结构中至少包含```{ error }```以指示造成异常的```Error```对象。**
    
    在**日志输出器**执行实例方法```start```、```close```和```log```**未通过状态校验**时将产生以下```Error```：

    ::: tip 提示
    **Error描述文案**的相关宏变量存储在```Core.Messages```中，我们可以在```Error```产生前修改对应宏变量的值以实现对**Error描述文案**的变更。
    :::

    | Error描述文案                        | 描述                   | 产生原因                       |
    | :----------------------------------- | :--------------------- | :----------------------------- |
    | ```BASE_LOGGER_MESSAGE_CANT_LOG```   | 日志输出器无法输出日志 | 执行日志输出时无法通过状态检验 |
    | ```BASE_LOGGER_MESSAGE_CANT_START``` | 日志输出器无法启动     | 执行启动动作时无法通过状态校验 |
    | ```BASE_LOGGER_MESSAGE_CANT_CLOSE``` | 日志输出器无法关闭     | 执行关闭动作时无法通过状态校验 |

## 日期输出器

**日期输出器提供了按时间周期归档日志的能力。**

我们可以使用**日期输出器**将同一时间周期内产生的日志输出至**单个日志文件**或是按照体积自动拆分为**日志文件组**。

同时，我们还可以指定**归档周期保留数量**，**日期输出器**将滚动清理过期的**日志文件**。

::: tip 提示
**日期输出器**继承自[基础输出器](#基础输出器)，支持其全部**功能参数**。

另外，**日期输出器**在运行环境为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，将保持与**基础输出器**一致的输出行为，即：将日志打印至控制台。

> **此时，当输出器执行启动和关闭动作时，仅进行基本状态判断，不再触发对资源的计算和操作。**
:::

### 功能说明

1. 将日志按照指定的**归档周期**归档至文件中。

2. 支持**日志文件**按体积自动分割。

3. 支持设置**归档周期保留数量**，以自动清理过时的日志文件。

4. 支持设置日志文件的**输出目录**和**输出文件名**的构成规则。

   ::: tip 提示

   - **输出目录**可能由**归档源目录**和**归档前缀**构成。

   - **输出文件名**结构为：**<%归档前缀%>.<%归档日期%>.<%归档偏移%>.<%文件后缀%>**。

   | 构成元素 | 规则                                                                                                                         |
   | :------- | :--------------------------------------------------------------------------------------------------------------------------- |
   | 归档前缀 | 实例化日期输出器时配置[```filePrefix```](#fileprefix)和[```filePrefixAsFileName```](#fileprefixasfilename)附加至输出文件名中 |
   | 归档日期 | 一定出现在归档文件名中；日期格式将使用实例化日期输出器时指定的[```dateFormat```](#dateformat)                                |
   | 归档偏移 | 实例化日期输出器时配置[```maxSize```](#maxsize)启动日志文件自动分割时会附加至输出文件名中                                    |
   | 文件后缀 | 实例化日期输出器时配置[```keepFileExt```](#keepfileext)启用日志文件后缀时会附加至输出文件名中                                |

   :::

5. 输出环境异常时自动降级以保证日志完整性。
  
   ::: tip 说明
   当**日期输出器**无法创建日志**输出目录**或**输出文件**时，**运行环境**自动降级至```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```将日志打印至控制台。
   :::

### 异常捕获

在**日期输出器**的**异常处理器**中可能接收到拓展的自定义异常类型（即：```errType```）：

| 异常类型                                        | 描述             | 产生原因                                 |
| :---------------------------------------------- | :--------------- | :--------------------------------------- |
| ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   | 无法创建日志文件 | 应用权限不足或操作系统异常（磁盘不足等） |
| ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` | 无法创建输出目录 | 应用权限不足或操作系统异常（磁盘不足等） |

同时，**日期输出器**拓展的自定义异常类型附带的细节信息（即：```errDetail```）将更加详细，其结构为```{ error, errorPath, errorDescription }```。

- **```error```**：导致异常的```Error```实例。
- **```errorPath```**：导致异常的日志输出目录/文件路径。
- **```errorDescription```**：异常描述。

::: tip 提示
**异常描述文案**的相关宏变量存储在```Core.Messages```中， 我们同样可以通过修改对应宏变量的值以实现对**异常描述文案**的变更。
:::

| 异常描述文案                                 | 产生时机                     | 异常类型归属                                    |
| :------------------------------------------- | :--------------------------- | :---------------------------------------------- |
| ```BASE_LOGGER_MESSAGE_CANT_CREATE_FILE```   | 日期输出器无法创建日志文件时 | ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   |
| ```BASE_LOGGER_MESSAGE_CANT_CREATE_FOLDER``` | 日期输出器无法创建输出目录时 | ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` |

### 功能参数

::: tip 提示
**日期输出器**支持[基础输出器](#基础输出器)的全部[功能参数](#功能参数)。
:::

- #### ```sourcePath```

  设置此配置将指定**日期输出器**的**归档源目录**，默认值为```path.resolve(process.cwd(), `./logs/${process.pid}`)```。

  **归档源目录**是进行日志文件分割和清理的工作区，我们将在[日志分割](#日志分割)和[日志清理](#日志清理)中进行详细讨论。

  ::: tip 提示

  - 由于文件系统限制，我们在指定**归档源目录**时使用的```<:?*"|>```这7个非法字符将被自动替换为```'_'```。

  - 在使用了```Cluster```架构的应用程序中，多进程抢夺相同的文件资源将导致日志归档异常。因此，我们应尽量使用进程标识符（比如：```process.pid```）作为**归档源目录**的构成元素。

  - 当由**归档源目录**和**归档前缀**构成的**日志输出目录**在文件系统中不存在时，**日期输出器**将在实例化过程中尝试创建，创建失败将导致**运行环境**降级。
  
  :::

  ---

  通常，应用程序中的**日志输出器**应使用相同的**归档源目录**以实现日志的集中存储：

  ```javascript
  const Core = require('node-corejs');

  // 公用的日志归档源目录
  const sourcePath = './testlogs';

  // 创建第一个日期输出器
  const logger1 = new Core.DateLogger({
    env: 'prod',
    params: { filePrefix: 'DateLogger1', sourcePath }
  });

  // 创建第二个日期输出器
  const logger2 = new Core.DateLogger({
    env: 'prod',
    params: { filePrefix: 'DateLogger2', sourcePath }
  });
  ```

- #### ```filePrefix```

  设置此配置将指定**日期输出器**的**归档前缀**，默认值为```''```。

  **归档前缀**可以作为**日志输出目录**和**输出文件名**的组成部分。因此，由于文件系统限制，我们在指定**归档前缀**时使用的```<\.:?*"|/>```这10个非法字符将被自动替换为```'_'```。
  
  ::: danger 注意
  **归档前缀**是一个非常关键的功能参数，将极大影响**日期输出器**的行为。
  
  此配置将影响以下功能参数：

  - [使用归档前缀构建输出目录](#fileprefixassourcepath)
  - [使用归档前缀构建输出文件名](#fileprefixasfilename)
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动)一节中进行详细讨论。
  :::

- #### ```filePrefixAsSourcePath```

  设置此配置将指定**日期输出器**是否在**归档源目录**中创建以**归档前缀**命名的目录用于存放**日志文件**，即在文件系统中使用**归档前缀**分类**日志文件**，默认值为```true```。

  ::: danger 注意
  此配置将**被**以下功能参数影响：
  
  - [归档前缀](#fileprefix)
  - [使用归档前缀构建输出文件名](#fileprefixasfilename)

  此配置将影响以下功能参数：
  
  - [使用归档前缀构建输出文件名](#fileprefixasfilename)
  
  因此，当我们指定的值违反了联动关系时将被**日期输出器**强制校正。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动)一节中进行详细讨论。
  :::

- #### ```filePrefixAsFileName```

  设置此配置将指定**日期输出器**是否在**输出文件名**中展示**归档前缀**，默认值为```true```。

  ::: danger 注意
  此配置将**被**以下功能参数影响：
  
  - [归档前缀](#fileprefix)
  - [使用归档前缀构建输出目录](#fileprefixassourcepath)

  此配置将影响以下功能参数：
  
  - [使用归档前缀构建输出目录](#fileprefixassourcepath)
  
  因此，当我们指定的值违反了联动关系时将被**日期输出器**强制校正。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动)一节中进行详细讨论。
  :::

---

让我们来看一个使用**归档前缀**构建**输出目录**和**输出文件名**的🌰：

```javascript
const Core = require('node-corejs');

const env = 'prod';
const level = 'infos';
const sourcePath = './testlogs';

// 日志输出目录：./testlogs/DateLogger1
// 日志输出文件：[归档日期].log
const logger1 = new Core.DateLogger({
  env,
  level,
  params: {
    sourcePath,
    filePrefix: 'DateLogger1',
    filePrefixAsFileName: false,
    filePrefixAsSourcePath: true,
  }
});

// 日志输出目录：./testlogs/DateLogger2
// 日志输出文件：DateLogger2.[归档日期].log
const logger2 = new Core.DateLogger({
  env,
  level,
  params: {
    sourcePath,
    filePrefix: 'DateLogger2',
    filePrefixAsFileName: true,
    filePrefixAsSourcePath: true,
  }
});

// 日志输出目录：./testlogs
// 日志输出文件：DateLogger3.[归档日期].log
const logger3 = new Core.DateLogger({
  env,
  level,
  params: {
    sourcePath,
    filePrefix: 'DateLogger3',
    filePrefixAsFileName: true,
    filePrefixAsSourcePath: false,
  }
});

// 执行日志输出
logger1.log('一条🌰日志');
logger2.log('一条🌰日志');
logger3.log('一条🌰日志');
```

- #### ```dateFormat```
  
  设置此配置将指定**日期输出器**的**归档周期**和**归档日期格式**，默认值为```YYYY-MM-DD```。
  
  **归档日期**将根据此配置中指定的**归档日期格式**附加至**输出文件名**。因此，由于文件系统限制，我们在指定此配置时使用的```<\.:?*"|/>```这10个非法字符将被自动替换为```'_'```。

  ::: tip 说明
  **日期输出器**支持以**月**、**日**、**时**、**分**、**秒**（因年周期过长，故不支持）作为**归档周期**。
  
  我们在**指定归档日期格式时需要使用递进方式组合日期元素**，即**归档日期格式**必须包含**归档周期**前置的**所有日期元素**。比如：

  - **选择月作为归档周期**

    **归档日期格式**需要包含**月**及其前置的所有日期元素，即：**年**（```'YYYY'```）和**月**（```'MM'```）。

    此时，我们可以指定**归档日期格式**为：```'YYYY-MM'```。

  - **当选择分作为归档周期**
    
    **归档日期格式**需要包含**分**及其前置的所有日期元素，即：**年**（```'YYYY'```）、**月**（```'MM'```）、**日**（```'DD'```）、**时**（```'HH'```）和**分**（```'mm'```）。
    
    此时，我们可以指定**归档日期格式**为：```'YYYY-MM-DD_HH_mm'```。
  
  ---

  日期元素及其表示方式从前至后依次为：

  - **年**：```'YYYY'```
  - **月**：```'MM'```
  - **日**：```'DD'```
  - **时**：```'HH'```
  - **分**：```'mm'```
  - **秒**：```'ss'```
  :::

  接下来，我们尝试构建一个以秒为**归档周期**的**日期输出器**：

  ```javascript {9}
  const Core = require('node-corejs');

  // 创建输出器
  const logger = new Core.DateLogger({
    env: 'prod',
    level: 'infos',
    params: {
      sourcePath: './testlogs',
      dateFormat: 'YYYY-MM-DD_HH_mm_ss' // 指定日期格式和归档周期
    }
  });
  
  // 每150ms执行一次日志输出
  setInterval(() => { logger.log('一条🌰日志') }, 150);
  ```


- #### ```keepDateNum```

  设置此配置将指定**日期输出器**的**归档周期保留数量**，当指定了```<=0```的值时将关闭自动清理，默认值为```0```。

  ::: tip 提示
  **日期输出器**将保留包含当前**归档周期**在内的最近```keepDateNum```个周期内生成的**日志文件**。比如：

  1. 指定**归档周期保留数量**为```2```。

  2. 指定**归档日期格式**为```'YYYY-MM'```。

  3. 当前日期为2011年10月，且**日志输出目录**中有五个**日志文件**：
     - ```2011-01.log```
     - ```2011-02.log```
     - ```2011-05.log```
     - ```2011-08.log```
     - ```2011-10.log```

  清理动作完成后，将只保留```2011-10.log```、```2011-08.log```两个**日志文件**。
  :::

- #### ```maxSize```
  
  设置此配置将指定**日期输出器**触发**日志文件**分割的最大体积，单位为```Byte```，当指定了```<=0```的值时将关闭自动分割，默认值为```0```。

  ::: tip 提示
  启动自动分割后，**输出文件名**中将附加**归档偏移**。
  :::

- #### ```keepFileExt```

  设置此配置将指定**日期输出器**是否在**输出文件名**中附加文件后缀```.log```，默认值为```true```。

---

接下来，我们将在一个复杂的场景下使用**日期输出器**进行日志收集：

- 保留最近5个归档日期内的日志。

- 将每秒内产生的日志归档至同一**日志文件**，超出```1KB```时自动分割。

- **日志文件**按照**归档前缀**存储，且**输出文件名**中不展示**归档前缀**。

```javascript
const Core = require('node-corejs');

// 构建输出器
const logger = new Core.DateLogger({
  env: 'prod',
  params: {
    maxSize: 1024,                      // 最大日志文件体积为1K
    keepDateNum: 5,                     // 保留最近5个周期
    sourcePath: './testlogs',           // 归档源目录
    filePrefix: 'ComplexLogger',        // 归档前缀
    filePrefixAsFileName: false,        // 输出文件名不附加归档前缀
    filePrefixAsSourcePath: true,       // 在归档源目录中创建归档前缀目录
    dateFormat: 'YYYY-MM-DD_HH_mm_ss',  // 以秒作为归档周期
  },
});

// 每100ms执行一次日志输出
setInterval(() => logger.log(new Error(`一个🌰日志`)), 100);
```

### 配置联动

在**日期输出器**的功能参数中，其中三个功能参数具有联动关系：

- [归档前缀](#fileprefix)：```filePrefix```
- [使用归档前缀构建输出目录](#fileprefixassourcepath)：```filePrefixAsSourcePath```
- [使用归档前缀构建输出文件名](#fileprefixasfilename)：```filePrefixAsFileName```

首先，我们先分析其联动逻辑关系：

1. 当**归档前缀**无效时，则**归档前缀**无法参与**输出目录**和**输出文件名**的构建。
2. 当**归档前缀**有效时，则**归档前缀**至少参与**输出目录**和**输出文件名**其中一项的构建，否则设置**归档前缀**没有意义。

::: tip 说明
当**归档前缀**没有指定或是指定为```''```时，认为无效。
:::

---

因此，**日期输出器**将自动进行功能参数校正以满足联动关系：

- **当```filePrefix```无效时**，将锁定```filePrefixAsSourcePath```和```filePrefixAsFileName```为```false```。

- **当```filePrefix```有效时**，则```filePrefixAsSourcePath```和```filePrefixAsFileName```中必须至少有一项指定为```true```。

  > **如果两项都指定为```false```，则锁定```filePrefixAsSourcePath```为```true```。**
  
::: tip 提示
**日期输出器**将在功能功能参数违反联动关系时，优先保证使用**归档前缀**构建**输出目录**而不是用于构建**输出文件名**。
:::

### 日志分割

在自动分割**日志文件**的模式下，**日期输出器**将在执行日志输出动作时根据**日志文件**的体积情况自动定向目标输出文件。

::: tip 提示
**自动分割功能不会对已产生的日志文件进行分割。**
:::

---

接下来，我们将讨论**日志分割**的实现方案：

- **日期输出器执行启动动作时**
  
  在其**归档源目录**中提取**相同归档前缀**且**相同归档周期**内全部日志文件以进行**日志分割**的首次仲裁计算，将取得初始**归档偏移**和**日志文件**的体积。

  ::: tip 提示
  当**日期输出器**启用**使用归档前缀构建日志输出目录**时，将提升日志文件检索效率。
  :::

- **日志输出器执行输出动作时**

  计算输出动作造成的体积增量，并与分割阈值```maxSize```进行比较，以仲裁后续**归档偏移**。

::: warning 注意

当多个启用了**日志分割**的**日期输出器**将日志输出至相同的**日志输出目录**，且拥有相同的**归档前缀**和**归档周期**时，将可能导致**日志分割**紊乱。

> **即：多个日期输出器的```sourcePath```、```filePrefix```、```filePrefixAsSourcePath```和```dateFormat```指定了相同的值。**

因此，我们在使用**日期输出器**时通常：

- **在单进程维度**，每个**日期输出器**指定唯一的**归档前缀**。

- **在```Cluter```架构下**，使用进程标识参与构建**归档源目录**，以隔离不同进程内**日期输出器**对应的**日志输出目录**。

:::

### 日志清理

Corejs内置了用于定时进行文件清理的**清理引擎**，将统一管理挂载了**清理规则**的**文件系统目录**。

**清理引擎将在单个文件系统目录挂载多个清理规则时自动仲裁触发周期**，以避免过于频繁的磁盘读写。

---

**日志清理**同样使用分治设计，**清理引擎**将周期性选择**日志输出目录**中符合以下全部条件的**日志文件**按照**归档周期保留数量**进行删除：

- **归档日期**早于当前日期
- 与当前**日期输出器**拥有相同的**归档前缀**
- 与当前**日期输出器**拥有相同的**归档日期格式**

::: tip 提示

**日期输出器**将在执行启动动作时向**清理引擎**中添加**清理规则**：

- 未使用**归档前缀构建日志输出目录**时，**日期输出器**向**归档源目录**的规则池中添加**清理规则**。

- 使用了**归档前缀构建日志输出目录**时，**日期输出器**向**归档源目录**下**归档前缀**目录的规则池中添加**清理规则**。

因此，我们通常使用**归档前缀构建日志输出目录**，以提高清理仲裁逻辑的执行效率。

:::

## 文件输出器

**文件输出器提供了将日志输出至单一文件的能力。**

通常，我们使用**文件输出器**对**频次型业务**产生的日志进行收集，**将每次业务执行链路中的日志输出至同一文件。**

::: tip 提示
**文件输出器**继承自[基础输出器](#基础输出器)，支持其全部**功能参数**。

另外，**文件输出器**在运行环境为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，将保持与**基础输出器**一致的输出行为，即：将日志打印至控制台。

> **此时，当输出器执行启动和关闭动作时，仅进行基本状态判断，不再触发对资源的计算和操作。**
:::

### 功能说明

1. **文件输出器**将其产生的所有日志输出至同一的文件。

2. 支持自动/手动管理**文件输出器**的状态和资源。

3. 支持设置日志文件的**输出目录**和**输出文件名**的构成规则。

   ::: tip 提示
   日志文件的**输出目录**和**输出文件名**由多个功能参数（**归档源目录**、**归档前缀**、**归档周期**等）共同决定。

   通常，我们将**相同业务产生的日志**归档至相同的**输出目录**中，并使用不同的**输出文件名**以区分业务调用的次序。
   :::
  
4. 支持设置**归档周期**和**周期保留数量**，以自动清理过时的输出文件。

5. 输出环境异常时自动降级以保证日志完整性。
  
   ::: tip 说明
   当**文件输出器**无法创建日志**输出目录**或**输出文件**时，**运行环境**自动降级至```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```将日志打印至控制台。
   :::

### 异常捕获

在**文件输出器**的**异常处理器**中可能接收到拓展的自定义异常类型（即：```errType```）：

| 异常类型                                        | 描述             | 产生原因                                 |
| :---------------------------------------------- | :--------------- | :--------------------------------------- |
| ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   | 无法创建日志文件 | 应用权限不足或操作系统异常（磁盘不足等） |
| ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` | 无法创建输出目录 | 应用权限不足或操作系统异常（磁盘不足等） |

同时，**文件输出器**拓展的自定义异常类型附带的细节信息（即：```errDetail```）将更加详细，其结构为```{ error, errorPath, errorDescription }```。

- **```error```**：导致异常的```Error```实例。
- **```errorPath```**：导致异常的日志输出目录/文件路径。
- **```errorDescription```**：异常描述。

::: tip 提示
**异常描述文案**的相关宏变量存储在```Core.Messages```中， 我们同样可以通过修改对应宏变量的值以实现对**异常描述文案**的变更。
:::

| 异常描述文案                                 | 产生时机                     | 异常类型归属                                    |
| :------------------------------------------- | :--------------------------- | :---------------------------------------------- |
| ```BASE_LOGGER_MESSAGE_CANT_CREATE_FILE```   | 文件输出器无法创建日志文件时 | ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   |
| ```BASE_LOGGER_MESSAGE_CANT_CREATE_FOLDER``` | 文件输出器无法创建输出目录时 | ```BASE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` |

---

此外，**文件输出器**在输出器启动和关闭动作时可能产生新的```Error```。

::: tip 提示
```Error```信息文案的相关宏变量存储在```Core.Messages```中， 我们同样可以通过修改对应宏变量的值以实现对```Error```信息文案的变更。
:::

| ```Error```信息文案                          | 产生时机                                  | ```Error```类型归属                     |
| :------------------------------------------- | :---------------------------------------- | :-------------------------------------- |
| ```FILE_LOGGER_MESSAGE_CANT_START_IN_AUTO``` | 自动模式下的文件输出器执行了```start()``` | ```BASE_LOGGER_ERROR_TYPE_CANT_START``` |
| ```FILE_LOGGER_MESSAGE_CANT_CLOSE_IN_AUTO``` | 自动模式下的文件输出器执行了```close()``` | ```BASE_LOGGER_ERROR_TYPE_CANT_CLOSE``` |

### 运行模式

**文件输出器**支持使用**两种**管理状态和资源的模式：

- **自动模式**

  **文件输出器**的默认运行模式。

  此模式下，**文件输出器**将自动进行状态和资源管理：
  
  - **执行日志输出动作前**，如果**文件输出器**处于关闭状态，将自动执行启动动作，再执行日志输出。
  - **执行日志输出动作后**，如果**文件输出器**在等待阈值[```timeout```](#timeout)内无日志输出动作，将自动执行关闭动作。

  ::: warning 注意
  在**自动模式**下，手动执行**文件输出器**的启动和关闭将产生异常，我们可以在**异常处理器**中对其进行捕获和处理。

  因此，我们**无需在业务层中显式调用**使用了**自动模式**的**文件输出器**的实例方法```start()```和```close()```，直接使用实例方法```log()```输出日志即可。
  :::

- **手动模式**

  此模式下，我们需要手动对**文件输出器**进行状态和资源管理：

  - **执行实例方法```start()```**：启动**文件输出器**，并创建文件句柄等必要资源。
  - **执行实例方法```close()```**：关闭**文件输出器**，并释放文件句柄等必要资源。

  ::: warning 注意
  在**文件输出器处于关闭状态时执行输出动作，或重复启动/关闭时**将产生异常，我们可以在**异常处理器**中对其进行捕获和处理。
  :::

### 使用规则

每次业务执行时实例化**文件输出器**，调整相关功能参数以指定日志的**输出目录**和**输出文件名**：

- 对于同类型业务，实例化**文件输出器**时使用相同的**归档源目录**、**归档前缀**和**归档周期**及其附属配置，以将同类型业务产生的日志归档至相同的**输出目录**。
- 在**输出文件名**中附带次序标识或内置随机文件名，以在**输出目录**中区分每次业务执行链路。



#### 输出目录

---

我们无法直接指定日志最终的**输出目录**，而是通过调整**归档源目录**、**归档前缀**和**归档日期**及其附属配置间接指定。

因此，日志的**输出目录**将由**归档源目录**、**归档前缀**和**归档日期**中的一项或几项组合而成。

::: warning 注意
仅在**文件输出器**使用**归档前缀**预分类**日志文件**时，才能通过**归档日期**进行二次分类。

即：**输出目录**构成规则为```path.resolve(<%归档源目录%>[, <%归档前缀%>[, <%归档日期%>]])```。

我们将在[配置联动](#配置联动-2)一节中详细讨论功能参数间的依赖关系。
:::

#### 输出文件名

---

我们也无法直接指定日志最终的**输出文件名**，同样是通过调整**归档前缀**、**归档日期**和**归档文件名**及其附属配置间接指定。

**输出文件名**的结构为：**<%归档前缀%>.<%归档文件名%>.<%归档日期%>.<%归档类型%>.<%文件后缀%>**。

| 构成元素   | 规则                                                                                                                                       |
| :--------- | :----------------------------------------------------------------------------------------------------------------------------------------- |
| 归档前缀   | 实例化文件输出器时，指定功能参数[```filePrefix```](#fileprefix-2)和[```filePrefixAsFileName```](#fileprefixasfilename-2)附加至输出文件名中 |
| 归档文件名 | 一定出现在输出文件名中；首先应用实例化文件输出器时的功能参数[```fileName```](#filename)，当此配置无效时则使用长度为```16```的随机字符串    |
| 归档日期   | 实例化文件输出器时，指定功能参数[```dateFormat```](#dateformat-2)和[```dateAsFileName```](#dateasfilename)附加至输出文件名中               |
| 归档类型   | 文件输出器将根据输出文件名构成元素的排列方式自动生成                                                                                       |
| 文件后缀   | 实例化文件输出器时，指定功能参数[```keepFileExt```](#keepfileext-2)附加至输出文件名中                                                      |

::: tip 说明
**归档类型**由**归档前缀**、**归档日期**和**归档文件名**的排列方式决定：

- 当**输出文件名**由**归档文件名**和**归档日期**构成时，**归档类型**为```[FN]```。

- 当**输出文件名**由**归档前缀**和**归档文件名**构成时，**归档类型**为```[FP]```。

- 其他场景不附加**归档类型**至**输出文件名**。

需要注意的是，**归档类型**记录了**输出文件名**的元信息，对**输出目录**中已生成的**日志文件**进行重命名操作将导致元信息损坏。
:::

### 功能参数

::: tip 提示
**日期输出器**支持[基础输出器](#基础输出器)的全部[功能参数](#功能参数)。
:::

- #### ```sourcePath```

  设置此配置将指定**文件输出器**的**归档源目录**，默认值为```path.resolve(process.cwd(), `./logs/${process.pid}`)```。

  **归档源目录**是进行**日志文件**清理的工作区，我们将在[日志清理](#日志清理-2)中进行详细讨论。

  ::: tip 提示

  - 由于文件系统限制，我们在指定**归档源目录**时使用的```<:?*"|>```这7个非法字符将被自动替换为```'_'```。

  - 在使用了```Cluster```架构的应用程序中，多进程抢夺相同的文件资源将导致日志归档异常。因此，我们应尽量使用进程标识符（比如：```process.pid```）作为**归档源目录**的构成元素。

  - 当由**归档源目录**、**归档前缀**和**归档日期**中的一项或几项构成的**输出目录**在文件系统中不存在时，**文件输出器**将在实例化过程中尝试创建，创建失败将导致**运行环境**降级。
  
  :::

  ---

  通常，**日志输出器**应使用相同的**归档源目录**以实现日志的集中存储。
  
  当然，**文件输出器**可以与**日期输出器**使用相同的**归档源目录**：

  ```javascript
  const Core = require('node-corejs');

  // 日志归档源目录
  const sourcePath = './testlogs';

  // 创建日期输出器
  const dateLogger = new Core.DateLogger({
    env: 'prod',
    level: 'infos',
    params: { filePrefix: 'DateLogger', sourcePath }
  });

  // 创建文件输出器
  const fileLogger = new Core.FileLogger({
    env: 'prod',
    level: 'infos',
    params: { filePrefix: 'FileLogger', sourcePath }
  });

  // 执行日志输出
  dateLogger.log('一条🌰日志');
  fileLogger.log('一条🌰日志');
  ```

- #### ```auto```

  设置此配置将指定**文件输出器**是否使用**自动模式**作为[运行模式](#运行模式)，默认值为```true```。

- #### ```timeout```

  设置此配置将指定**文件输出器**在**自动模式**中**自动释放资源的等待时间**，单位为**毫秒**，默认值为```10000```。

  ::: tip 提示
  在**手动模式**下，此配置将被锁定为```0```。

  在**自动模式**下指定了```<=0```的值时，将使用默认值```10000```。
  :::

---

使用**自动模式**时，我们无需显式调用```start()```和```close()```即可执行日志输出动作。

在**自动模式**强行调用**文件输出器**的实例方法```start()```或```close()```将抛出异常，我们可以通过在实例化时配置**异常处理器**```_errorHandler```进行捕获和处理：

```javascript
const Core = require('node-corejs');

// 创建使用自动模式的文件输出器
const logger = new Core.FileLogger({
  env: 'prod',
  params: {
    // 指定使用自动模式
    auto: true,
    timeout: 10000,
    // 将捕获到的异常输出到控制台
    _errorHandler(errType, errDetail) { console.log(errType, errDetail) }
  }
});

// 强行调用start()和close()
logger.start();
logger.close();
```

---

使用**手动模式**时，如果在执行日志输出动作前没有调用```start()```启动**文件输出器**，同样会抛出异常：

```javascript
const Core = require('node-corejs');

// 创建使用手动模式的文件输出器
const logger = new Core.FileLogger({
  env: 'prod',
  params: {
    // 指定使用手动模式
    auto: false,
    // 将捕获到的异常输出到控制台
    _errorHandler(errType, errDetail) { console.log(errType, errDetail) }
  }
});

// 强行发起log()
logger.log('一条🌰日志');
```

- #### ```fileName```
  
  设置此配置将指定**文件输出器**的**归档文件名**，默认根据**进程标识**、**当前时间戳**和**8位随机小写字母和数字**生成16长度的字符串作为**归档文件名**。

  **归档文件名**将作为**输出文件名**的组成部分。因此，由于文件系统限制，我们在指定此配置时使用的```<\.:?*"|/>```这10个非法字符将被自动替换为```'_'```。

  ::: tip 提示
  我们需求注意的是，**归档文件名**不是最终输出至文件系统的**输出文件名**，而是作为**输出文件名**的构成元素。

  对于**输出文件名**的构成规则请参考[输出文件名](#输出文件名)。
  :::

  ---

  通常，**归档文件名**由业务自定义部分和随机字符串部分共同组成。
  
  此场景下，我们可以在指定**归档文件名**时使用宏字符串```[%RANDOM_FILE_NAME%]```以引用**文件输出器**内置的**随机字符串**：

  ```javascript
  const Core = require('node-corejs');

  setInterval(() => {
    const logger = new Core.FileLogger({
      env: 'prod',
      level: 'infos',
      params: {
        sourcePath: './testlogs',
        // 在fileName中使用宏字符串
        fileName: 'LogFile_[%RANDOM_FILE_NAME%]'
      }
    });

    // 日志输出文件名为LogFile_[%随机字符串%].log
    logger.log('一个🌰日志');
  }, 500);
  ```

- #### ```filePrefix```

  设置此配置将指定**文件输出器**的**归档前缀**，默认值为空字符串```''```。

  **归档前缀**可以作为**输出目录**和**输出文件名**的组成部分。因此，由于文件系统限制，我们在指定**归档前缀**时使用的```<\.:?*"|/>```这10个非法字符将被自动替换为```'_'```。
  
  ::: danger 注意
  **归档前缀**是一个非常关键的功能参数，将极大影响**文件输出器**的行为。
  
  此配置将影响以下功能参数：

  - [使用归档前缀构建输出目录](#fileprefixassourcepath-2)
  - [使用归档前缀构建输出文件名](#fileprefixasfilename-2)
  - [使用归档日期构建输出目录](#dateassourcepath)
  - [使用归档日期构建输出文件名](#dateasfilename)
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```filePrefixAsSourcePath```

  设置此配置将指定**文件输出器**是否在**归档源目录**中创建以**归档前缀**命名的目录用于存放**日志文件**，即在文件系统中使用**归档前缀**分类**日志文件**，默认值为```true```。

  ::: danger 注意
  此配置将**被**以下功能参数影响：
  
  - [归档前缀](#fileprefix-2)
  - [使用归档前缀构建输出文件名](#fileprefixasfilename-2)

  此配置将影响以下功能参数：
  
  - [使用归档前缀构建输出文件名](#fileprefixasfilename-2)
  - [使用归档日期构建输出目录](#dateassourcepath)
  - [使用归档日期构建输出文件名](#dateasfilename)
  
  因此，当我们指定的值违反了联动关系时将被**文件输出器**强制校正。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```filePrefixAsFileName```

  设置此配置将指定**文件输出器**是否在**输出文件名**中展示**归档前缀**，默认值为```true```。

  ::: danger 注意
  此配置将**被**以下功能参数影响：
  
  - [归档前缀](#fileprefix-2)
  - [使用归档前缀构建输出目录](#fileprefixassourcepath-2)

  此配置将影响以下功能参数：

  - [使用归档前缀构建输出目录](#fileprefixassourcepath-2)

  因此，当我们指定的值违反了联动关系时将被**文件输出器**强制校正。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```dateFormat```

  设置此配置将指定**文件输出器**的**归档周期**和**归档日期格式**，默认值为```YYYY-MM-DD```。
  
  **归档日期**将根据此配置中指定的**归档日期格式**附加至**输出文件名**。因此，由于文件系统限制，我们在指定此配置时使用的```<\.:?*"|/>```这10个非法字符将被自动替换为```'_'```。

  ::: tip 说明
  **文件输出器**支持以**月**、**日**、**时**、**分**、**秒**（因年周期过长，故不支持）作为**归档周期**。
  
  我们在**指定归档日期格式时需要使用递进方式组合日期元素**，即**归档日期格式**必须包含**归档周期**前置的**所有日期元素**。比如：

  - **选择月作为归档周期**

    **归档日期格式**需要包含**月**及其前置的所有日期元素，即：**年**（```'YYYY'```）和**月**（```'MM'```）。

    此时，我们可以指定**归档日期格式**为：```'YYYY-MM'```。

  - **当选择分作为归档周期**
    
    **归档日期格式**需要包含**分**及其前置的所有日期元素，即：**年**（```'YYYY'```）、**月**（```'MM'```）、**日**（```'DD'```）、**时**（```'HH'```）和**分**（```'mm'```）。
    
    此时，我们可以指定**归档日期格式**为：```'YYYY-MM-DD_HH_mm'```。
  
  ---

  日期元素及其表示方式从前至后依次为：

  - **年**：```'YYYY'```
  - **月**：```'MM'```
  - **日**：```'DD'```
  - **时**：```'HH'```
  - **分**：```'mm'```
  - **秒**：```'ss'```
  :::

  ::: danger 注意
  **归档日期格式**也是一个非常关键的功能参数，将极大影响**文件输出器**的行为。

  此配置将影响以下功能参数：

  - [使用归档日期构建输出目录](#dateassourcepath)
  - [使用归档日期构建输出文件名](#dateasfilename)

  对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```dateAsSourcePath```

  设置此配置将指定**文件输出器**是否在**归档源目录**中以**归档前缀**命名的目录下创建以**归档日期**命名的目录用于存放**日志文件**，即在文件系统中使用**归档前缀**和**归档日期**分类**日志文件**，默认值在```filePrefix```或```dateFormat```无效时为```false```，其他情况时为```true```。

  ::: danger 注意
  此配置将**被**以下功能参数影响：
  
  - [归档前缀](#fileprefix-2)
  - [使用归档前缀构建输出目录](#fileprefixassourcepath-2)
  - [使用归档前缀构建输出文件名](#fileprefixasfilename-2)
  - [使用归档日期构建输出文件名](#dateasfilename)

  此配置将影响以下功能参数：

  - [使用归档日期构建输出文件名](#dateasfilename)

  因此，当我们指定的值违反了联动关系时将被**文件输出器**强制校正。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```dateAsFileName```

  设置此配置将指定**文件输出器**是否在**输出文件名**中展示**归档日期**，默认值在```dateFormat```无效时为```false```，其他情况时为```true```。

  ::: danger 注意
  此配置将**被**以下功能参数影响：
  
  - [归档前缀](#fileprefix-2)
  - [使用归档前缀构建输出目录](#fileprefixassourcepath-2)
  - [使用归档日期构建输出目录](#dateassourcepath)

  此配置将影响以下功能参数：

  - [使用归档日期构建输出目录](#dateassourcepath)

  因此，当我们指定的值违反了联动关系时将被**文件输出器**强制校正。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```keepDateNum```

  设置此配置将指定**文件输出器**的**归档周期保留数量**，当指定的**归档日期格式**无效或指定了```<=0```的值时将关闭自动清理，默认值为```0```。

  ::: tip 提示
  **文件输出器**将保留包含当前**归档周期**在内的最近```keepDateNum```个周期内生成的**日志文件**。比如：

  1. 指定**归档周期保留数量**为```2```。

  2. 指定**归档日期格式**为```'YYYY-MM'```。

  3. 当前日期为2011年10月，且**输出目录**中有五个**日志文件**：
     - ```2011-01.log```
     - ```2011-02.log```
     - ```2011-05.log```
     - ```2011-08.log```
     - ```2011-10.log```

  清理动作完成后，将只保留```2011-10.log```、```2011-08.log```两个**日志文件**。
  :::

- #### ```keepFileExt```

  设置此配置将指定**文件输出器**是否在**输出文件名**中附加文件后缀```.log```，默认值为```true```。

---

假设我们有一个间隔```150ms```执行的频次型业务需要使用**文件输出器**进行日志收集：

- 仅保留**最近5秒内**的日志

- 将此业务**每秒**产生的日志存储至**相同目录**

- **输出文件名**中展示业务执行次序和**归档时间**

```javascript
const Core = require('node-corejs');

let count = 0;

// 每150ms创建文件输出器并输出日志以模拟每次业务执行
setInterval(() => {
  count += 1;
  const logger = new Core.FileLogger({
    env: 'prod',
    level: 'infos',
    params: {
      fileName: count,                    // 归档文件名
      sourcePath: './testlogs',           // 归档源目录
      filePrefix: 'ComplexLogger',        // 归档前缀
      filePrefixAsSourcePath: true,       // 使用归档前缀预分类日志
      filePrefixAsFileName: false,        // 输出文件名不附加归档前缀
      dateFormat: 'YYYY-MM-DD_HH_mm_ss',  // 归档日期格式
      dateAsSourcePath: true,             // 使用归档日期分类日志
      dateAsFileName: true,               // 输出文件名不附加归档日期
      keepDateNum: 5                      // 保留最近5个归档日期
    }
  });

  // 每个文件输出器执行4次日志输出以模拟业务链路内产生日志
  logger.log('i', `infos级别的🌰日志 -> ${count}`);
  logger.log('w', `warns级别的🌰日志 -> ${count}`);
  logger.log('e', `error级别的🌰日志 -> ${count}`);
  logger.log('f', `fatal级别的🌰日志 -> ${count}`);
}, 150);
```

### 配置联动

在**文件输出器**的功能参数中，有两组联动关系：

#### 归档前缀联动

- [归档前缀](#fileprefix-2)：```filePrefix```
- [使用归档前缀构建输出目录](#fileprefixassourcepath-2)：```filePrefixAsSourcePath```
- [使用归档前缀构建输出文件名](#fileprefixasfilename-2)：```filePrefixAsFileName```

#### 归档日期联动

- [归档日期格式](#dateformat-2)：```dateFormat```
- [使用归档日期构建输出目录](#dateassourcepath)：```dateAsSourcePath```
- [使用归档日期构建输出文件名](#dateasfilename)：```dateAsFileName```

---

首先，我们分析**归档前缀**的联动逻辑关系：

1. 当**归档前缀**无效时，则**归档前缀**无法参与**输出目录**和**输出文件名**的构建。
2. 当**归档前缀**有效时，则**归档前缀**至少参与**输出目录**和**输出文件名**其中一项的构建，否则设置**归档前缀**没有意义。

接下来，我们分析**归档日期**的联动逻辑关系。**归档日期**与**归档前缀**的联动关系类似：

1. 如果**归档日期格式**无效，则**归档前缀**无法参与**输出目录**和**输出文件名**的构建。
2. 如果**归档日期格式**有效，则**归档日期**至少参与**输出目录**和**输出文件名**其中一项的构建，否则设置**归档日期格式**没有意义。

::: tip 说明
当**归档前缀**、**归档日期格式**没有指定或指定为```''```时，认为其无效。
:::

另外，我们已经知道，**使用归档前缀预分类日志文件时，才能通过归档日期对日志文件进行二次分类**。即：只有在**使用归档前缀构建输出目录**时才允许**使用归档日期构建输出目录**。

因此：如果**归档前缀**不参与构建**输出目录**，则**归档日期**也无法参与构建**输出目录**。

---

**文件输出器**将自动进行功能参数校正以满足联动关系。

对于**归档前缀**的联动关系，**文件输出器**将确保：

- **当```filePrefix```无效时**，将锁定```filePrefixAsSourcePath```和```filePrefixAsFileName```为```false```。

- **当```filePrefix```有效时**，则```filePrefixAsSourcePath```和```filePrefixAsFileName```中必须至少有一项指定为```true```。

  > **如果两项都指定为```false```，则锁定```filePrefixAsSourcePath```为```true```。**

对于**归档日期**的联动关系，**文件输出器**将确保：

- 当```dateFormat```无效时，将锁定```dateAsSourcePath```和```dateAsFileName```为```false```。

- 当```dateFormat```有效时，则```dateAsSourcePath```和```dateAsFileName```中必须至少有一项指定为```true```。
  
  > **如果两项都指定为```false```，则锁定```dateAsSourcePath```为```true```。**

::: tip 提示
**文件输出器**将在功能功能参数违反联动关系时，优先保证使用**归档前缀**或**归档日期**构建**输出目录**而不是用于构建**输出文件名**。
:::

---

对于**归档前缀**和**归档日期**维度的高阶联动，**文件输出器**将确保：

- **当```filePrefix```无效时**，将锁定```dateAsSourcePath```为```false```。

- **当```filePrefix```有效，且```filePrefixAsSourcePath```为```false```时**，将锁定```dateAsSourcePath```为```false```。

- **当```dateFormat```有效，且```dateAsSourcePath```因①或②而被锁定为```false```时**，则锁定```dateAsFileName```为```true```。

此策略将使**文件输出器**在保证**归档前缀**和**归档日期**的高阶联动性的基础上，使指定的**归档日期格式**发挥作用。

### 日志清理

::: tip 提示
**文件输出器**的分治清理规则非常抽象，仅做了解即可。
:::

**文件输出器**同样使用在实例化时向**清理引擎**注册清理策略的分治方式实现日志清理。

不同的是，**文件输出器**的实例化通常为高频行为，**需要引入防止清理规则重复挂载的反制策略**：

- **输出目录为归档源目录时**：

  将向**归档源目录**的规则池中挂载清理规则。

  对于相同**归档源目录**的规则池，将拒绝**归档前缀**、**归档日期格式**、**归档周期保留数量**完全一致的**文件输出器**进行二次规则挂载。

  此时，**清理引擎**将周期性选择**归档源目录**下与当前**文件输出器**拥有相同**归档前缀**且相同**归档日期格式**的**日志文件**按照归档周期保留数量进行清理仲裁。

- **输出目录非归档源目录时**：

  将向**归档源目录下的归档前缀子目录**的规则池中挂载清理规则。

  对于相同的**归档源目录下的归档前缀目录**的规则池，将拒绝**使用归档日期构建输出目录**、**归档日期格式**、**归档周期保留数量**完全一致的**文件输出器**进行二次规则挂载。

  此时，**清理引擎**将周期性选择**归档源目录下的归档前缀子目录**下与当前**文件输出器**拥有相同**归档日期格式**的**日志文件**按照归档周期保留数量进行清理仲裁。
