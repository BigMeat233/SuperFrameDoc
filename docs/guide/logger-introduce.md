# 日志输出器

## 输出器模型

[输出器模型](/images/test.png)

## 输出器配置

通常，Corejs内置输出器实例化时需要配置**运行环境**、**最小输出等级**和**功能参数**构成的对象，即```{ env, level, params }```。

- ```env```：输出器当前的运行环境，默认值为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```。

  运行环境将影响输出器行为：

  - 当运行环境为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，日志将统一输出到控制台。在[自定义输出器](/guide/logger-customizing.html)时尽量遵守此规则。
  - 当运行环境不为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，日志将根据实际的逻辑产生相应的输出行为。

  ::: tip 提示
  对于Corejs内置的[日期输出器](#日期输出器)和[文件输出器](#文件输出器)，运行环境为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，日志将输出至控制台。在输出器启动和关闭时，不再执行归档和清理计算，也不再操作系统文件句柄资源。
  :::

- ```level```：最小日志输出等级名称或别名，输出器仅输出权重大于等于此输出等级的日志。

  最小输出等级的默认值依赖于当前运行环境：

  - 当运行环境为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，默认值为：```all```。
  - 当运行环境不为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，默认值为：```error```。
  
  ::: danger 注意
  若默认或指定的最小输出等级不在输出器的等级支持列表中时，则使用[等级选举](#等级选举)产生的**默认日志等级**作为默认值。关于**默认日志等级**的说明见[输出等级](#输出等级)。
  :::

- ```params```：输出器的功能配置参数，控制输出器行为的参数在此项中配置。

  ::: tip 提示
  功能配置参数将被缓存在输出器实例中。[自定义输出器](/guide/logger-customizing.html)时可以直接通过```this.params```读取当前输出器的配置参数。通常，需要在整个输出器生命周期中共享的自定义参数可以放在此项中，**需要注意自定义参数不要与功能配置参数名称冲突，否则将影响输出器默认行为**。
  :::

## 输出等级

Corejs内置输出器支持在**输出等级配置**和**输出日志**时使用**标准等级名称**和**标准等级别名**作为日志输出等级，权重从小到大依次为：

- 追踪日志：```'trace'```、```'t'```，权重：```10000```。
- 调试日志：```'debug'```、```'d'```，权重：```20000```。
- 信息日志：```'infos'```、```'info'```、```'i'```，权重：```30000```。
- 警告日志：```'warns'```、```'warn'```、```'w'```，权重：```40000```。
- 错误日志：```'error'```、```'err'```、```'e'```，权重：```50000```。
- 灾难日志：```'fatal'```、```'f'```，权重：```60000```。

Corejs内置输出器中使用两个**内部输出等级**，仅用于**输出等级配置**：

- 开启所有日志：```all```、```a```，权重：```0```。
- 关闭所有日志：```off```、```o```，权重：```100000```。

Corejs内置输出器默认业务逻辑中需要使用**默认日志等级**、**默认警告日志等级**和**默认错误日志等级**。如果以上三个输出等级**未在配置项中指定**或**指定了不在输出等级支持列表中的等级**时，则使用[等级选举](#等级选举)中选举出的输出等级。

::: tip 使用场景

- 默认日志等级：在```log()```时**未指定输出等级**或**指定了不在输出等级支持列表中的等级**时，使用此等级作为日志输出等级。
- 默认警告日志等级：在输出器内部**需要输出警告信息**时，使用此等级作为日志输出等级。
- 默认错误日志等级：
  - 当输出权重大于等于此等级的日志时，输出器将自动附加调用栈至日志内容中。
  - 在```log()```时指定了```Error```类型的日志内容时，将使用此等级作为日志输出等级。
:::

## 等级选举

等级选举规则将在**输出等级支持列表**中选举出**默认日志等级**、**默认警告日志等级**和**默认错误日志等级**。在上述三个输出等级**未在配置项中指定**或**指定了不在输出等级支持列表中的等级**时，使用选举出产生的等级。

选举规则为：

- 枚举输出等级支持列表，在配置了```level.default```为```true```的输出等级中选择权重最大的输出等级作为**默认日志等级**。
- 若上述步骤中未能选举出**默认日志等级**（比如：支持列表中不存在```level.default```为```true```的输出等级），则选举输出等级支持列表中**权重居中**的等级作为**默认日志等级**。
- 若有两个权重居中的输出等级，则选择**权重较小者（两者中前者）**作为**默认日志等级**。
- 选举比**默认日志等级**权重**大一个梯度**的输出等级（即输出等级支持列表按权重升序排列后位于**默认日志等级**后一个位置的输出等级）作为**默认警告日志等级**。
- 若上述步骤中未能选举出**默认警告日志等级**（比如：**默认日志等级**位于等级支持列表的最末位），则使用**默认日志等级**作为**默认警告日志等级**。
- 选举比**默认日志等级**权重**大二个梯度**的输出等级（即输出等级支持列表按权重升序排列后位于**默认日志等级**后二个位置的输出等级）作为**默认错误日志等级**。
- 若上述步骤中未能选举出**默认错误日志等级**（比如：**默认日志等级**位于等级支持列表的最末位或倒数第二位），则使用**默认警告日志等级**作为**默认错误日志等级**。

## 基础输出器

基础输出器将日志输出到控制台，**一般不在生产环境中使用**。[自定义输出器](/guide/logger-customizing.html)时需要继承基础输出器。

### 功能说明

- 日志输出至控制台。
- **支持输出器自启动**，即实例化后自动启动输出器，无需显式执行```start()```。
- ```start()```、```close()```和```log()```中内置状态检测机制（可通过配置调整，默认打开）。

  ::: tip 说明
  - 执行```log()```时：检测输出器是否处于启动状态，若输出器未启动则**放弃此次日志输出，并输出警告日志**。
  - 执行```start()```时：检测输出器是否已处于启动状态，若输出器已启动则**不再执行启动逻辑，并输出警告日志**。
  - 执行```close()```时：检测输出器是否已处于关闭状态，若输出器已关闭则**不再执行关闭逻辑，并会输出警告日志**。

  > 通过在实例化基础输出器前修改宏的方式实现对警告日志内容的变更：
  > | 宏名称                                             | 描述                          |
  > | :------------------------------------------------ | :--------------------------- |
  > | ```Core.Message.BASE_LOGGER_MESSAGE_CANT_LOG```   | 执行```log()```时状态校验失败   |
  > | ```Core.Message.BASE_LOGGER_MESSAGE_CANT_START``` | 执行```start()```时状态校验失败 |
  > | ```Core.Message.BASE_LOGGER_MESSAGE_CANT_CLOSE``` | 执行```close()```时状态校验失败 |
  :::

- 支持使用多种调用方式快捷打印日志。

  | 调用方式                            | 行为说明                                                         |
  | :---------------------------------- | :--------------------------------------------------------------- |
  | ```log(message)```                  | 根据日志内容智能选择日志输出等级，且根据当前调用栈获取调用方法名 |
  | ```log(level, message)```           | 使用指定日志等级（别名）输出日志，且根据当前调用栈获取调用方法名 |
  | ```log(level, funcName, message)``` | 使用指定日志等级（别名）和指定方法名输出日志                     |

  ::: tip 提示
  执行```log(message)```时，输出器将根据```message```的类型自动选择日志输出等级：

  - ```message```为```Error```类型：使用**默认错误日志等级**输出日志。
  - ```message```为非```Error```类型：使用**默认日志等级**输出日志。
  :::

  ::: warning 注意
  调用```log()```时，如果输出等级权重大于等于**默认错误日志等级**时，将在日志内容中附加当前调用栈。

  - 日志内容为```Error```类型时，使用```Error```实例的调用栈。
  - 日志内容为非```Error```类型时，使用当前调用栈。**通过设置输出器```callStackOffset```配置调整调用栈偏移**。
  :::

- 日志内容输出格式：

   **[<%YYYY-MM-DD HH:mm:ss.SSS+ZZZZ%>] [<%ENV%> LOG] [<%LEVEL%>] - <<%FUNC_NAME%>><<%MESSAGE%>\n<%CALL_STACK%>\n>**

   | 内容元素                         | 说明         |
   | :------------------------------- | :----------- |
   | <%YYYY-MM-DD HH:mm:ss.SSS+ZZZZ%> | 时间戳字符串 |
   | <%ENV%>                          | 当前运行环境 |
   | <%LEVEL%>                        | 日志输出等级 |
   | <%FUNC_NAME%>                    | 调用方法名   |
   | <%MESSAGE%>                      | 日志文案     |
   | <%CALL_STACK%>                   | 当前调用栈   |

### 功能参数

- #### ```defaultLevel```

  设置此配置将指定输出器的**默认日志等级**，默认值为：```null```。

  此配置可以使用**输出等级支持列表中等级的全称或别名**，当配置了不在支持列表中的输出等级或配置为```null```时表示使用[等级选举](#等级选举)产生的默认日志等级。

  ::: tip 使用默认日志等级的场景
  - 输出器配置的最小输出等级不在输出等级支持列表中时，将使用默认日志等级。
  - 执行```log(message)```输出日志且**传入的日志内容不为```Error```类型**时，将使用默认日志等级输出。
  - 执行```log(level, message)```输出日志且**使用的输出等级不在输出等级支持列表中**时，将使用默认日志等级输出。
  - 执行```log(level, funcName, message)```输出日志且**使用的输出等级不在输出等级支持列表中**时，将使用默认日志等级输出。
  :::

- #### ```defaultWarnsLevel```

  设置此配置将指定输出器的**默认警告日志等级**，默认值为：```null```。

  此配置可以使用**输出等级支持列表中等级的全称或别名**，当配置了不在支持列表中的输出等级或配置为```null```时表示使用[等级选举](#等级选举)产生的默认警告日志等级。

  ::: tip 使用默认警告日志等级的场景
  执行```start()```、```close()```、```log()```过程中，**状态校验失败时**输出的警告日志将以默认警告日志等级输出。
  :::

- #### ```defaultErrorLevel```

  设置此配置将指定输出器的**默认错误日志等级**，默认值为：```null```。

  此配置可以使用**输出等级支持列表中等级的全称或别名**，当配置了不在支持列表中的输出等级或配置为```null```时表示使用[等级选举](#等级选举)产生的默认错误日志等级。

  ::: tip 使用默认错误日志等级的场景
  - 执行```log(message)```输出日志且**传入的日志内容为```Error```类型**时，将使用默认错误日志等级输出。
  - 执行```log(level, message)```输出日志，**使用的输出等级在输出等级支持列表中**且**权重大于等于默认错误日志等级权重**时，将自动在日志内容中附加调用栈。
  - 执行```log(level, funcName, message)```输出日志，**使用的输出等级在输出等级支持列表中**且**权重大于等于默认错误日志等级权重**时，将自动在日志内容中附加调用栈。
  :::

- #### ```callStackOffset```

  设置此配置或在调用```buildCallSnapshot()```之前修改输出器的```_callStackOffset```属性将设置构造调用栈时的偏移，默认值为：```Core.Macro.BASE_LOGGER_DEFAULT_CALLSTACK_OFFSET```。

  此配置将影响```buildCallSnapshot()```生成当前上下文调用信息时的调用栈偏移，用于过滤无意义的内部调用，一般情况下使用```Core.Macro.BASE_LOGGER_DEFAULT_CALLSTACK_OFFSET```作为偏移基数，执行自增或自减得到实际的调用栈偏移。

  ::: tip 提示
  当日志内容为```Error```类型时调用```buildCallSnapshot()```生成的调用栈不受此配置影响。
  :::

- #### ```_checkStateInLog```

  设置此配置或在调用```log()```之前修改输出器的```_checkStateInLog```属性将控制输出器在执行```log()```时是否检查当前状态，默认值为：```true```。

  ::: tip 提示
  当此配置为```true```时，输出器在执行```log()```时将检查当前输出器是否处于开启状态，**若不处于开启状态将输出警告日志**。通过在实例化输出器前修改```Macro.Message.SERVICE_CORE_MESSAGE_INVALID_STATE```修改默认警告日志内容。
  :::

- #### ```_checkStateInStart```

  设置此配置或在调用```start()```之前修改输出器的```_checkStateInStart```属性将控制输出器在执行```start()```时是否检查当前状态，默认值为：```true```。

  ::: danger 警告
  输出器**默认开启**此配置用于防止```start()```中的资源创建逻辑多次执行，请谨慎调整此配置。
  :::

  ::: tip 提示
  当此配置为```true```时，输出器在执行```start()```时将检查当前输出器是否处于开启状态，**若处于开启状态则不执行启动逻辑仅输出警告日志**。通过在实例化输出器前修改```Macro.Message.SERVICE_CORE_MESSAGE_INVALID_STATE```修改默认警告日志内容。
  :::

- #### ```_checkStateInClose```

  设置此配置或在调用```close()```之前修改输出器的```_checkStateInClose```属性将控制输出器在执行```close()```时是否检查当前状态，默认值为：```true```。

  ::: danger 警告
  输出器**默认开启**此配置用于防止```close()```中的释放资源逻辑多次执行，请谨慎调整此配置。
  :::

  ::: tip 提示
  当此配置为```true```时，输出器在执行```close()```时将检查当前输出器是否处于关闭状态，**若处于关闭状态则不执行启动逻辑仅输出警告日志**。通过在实例化输出器前修改```Macro.Message.SERVICE_CORE_MESSAGE_INVALID_STATE```修改默认警告日志内容。
  :::

### 样例代码

```javascript
const Core = require('node-corejs');
// 构造输出器
const logger = new Core.BaseLogger({
  env: 'prod',
  level: 'all',
  params: { defaultLevel: 'debug' }
});

// 输出日志至控制台
logger.log('debug'); // 因配置了defaultLevel为debug,故此条日志使用debug作为默认输出等级
logger.log('t', 'trace', 'trace日志');
logger.log('i', 'infos', 'infos日志');
logger.log('w', 'warns', 'warns日志');
logger.log('e', 'error', 'error日志');
logger.log('f', 'fatal', 'fatal日志');
logger.log(new Error('error日志'));
```

## 日期输出器

日期输出器继承自[基础输出器](#基础输出器)，**在运行环境为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时与基础输出器保持一致的输出行为：将日志输出至控制台**。在其他运行环境下，将**按照日期周期归档日志**。支持同一周期内**日志文件分割**、**过期文件自动清理**等辅助功能。

::: tip 提示
日期输出器通常用于按照周期收集日志的场景。比如：将每天产生的日志归档至同一文件或文件组中，仅保留最近7天的日志。
:::

**日期输出器支持[基础输出器](#基础输出器)的所有配置和功能，本节中仅介绍增量内容。**

### 功能说明

- 日志按照周期归档至文件中。

  ::: tip 说明
  通过配置```dateFormat```调整归档周期，同一周期内的日志将归档至相同的文件或文件组中。支持以月、日、时、分、秒(因年周期过长，故不支持)作为归档周期。
  :::

- 支持同周期内的日志文件自动分割为文件组。
- 支持设置保留周期个数，自动清理过期的日志文件或文件组。
- 支持设置归档目录、归档文件名的构成规则。

  ::: tip 关于归档目录和归档文件名
  归档目录可能由**源目录**和**归档前缀**构成；归档文件名可能由**归档前缀**、**归档日期**、**归档偏移**和**文件后缀**构成。
  
  **归档文件名结构为：<%归档前缀%>.<%归档日期%>.<%归档偏移%>.<%文件后缀%>**。

  | 构成元素 | 规则                            |
  | :------- | :---------------------------- |
  | 归档前缀 | 通过配置控制是否附加至归档文件名中   |
  | 归档日期 | 一定出现在归档文件名中             |
  | 归档偏移 | 仅开启了文件分割时附加至归档文件名中 |
  | 文件后缀 | 通过配置控制是否附加至归档文件名中   |
  :::

- 输出异常时保证日志完整性。
  
  ::: tip 说明
  - 当日期输出器产生异常警告时（比如：非法调用、状态错误等）时，将输出警告日志到控制台，不导致运行环境降级。
  - 当日期输出器产生阻塞级异常（比如：无法创建目录、无法创建文件等）时，运行环境降级为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```。
  :::

### 功能参数

- #### ```sourcePath```

  设置此配置将指定输出器的**归档源目录**，默认值为```path.resolve(process.cwd(), `./logs/${process.pid}`)```。

  ::: danger 警告
  若**归档源目录**不存在时，输出器将在实例化过程中**尝试创建归档源目录**，若**创建失败将导致运行环境降级为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```**。
  :::

  ::: warning 注意
  - 由于文件系统限制，**归档源目录中不允许使用以下6个字符：```<?*"|>```，将被自动替换为```'_'```**。
  - **在```Cluster```架构的应用程序中**，为避免多进程抢夺相同资源导致异常，推荐**归档源目录使用进程标识作为构建元素**。
  :::

- #### ```filePrefix```

  设置此配置将指定输出器的**归档前缀**，默认值为```''```。
  
  **可通过配置附加归档前缀至归档源目录或归档文件名**，由于文件系统限制，**不能使用以下10个字符：```<\.:?*"|/>```，将被自动替换为```'_'```**。

  ::: danger 注意
  若启动了```filePrefixAsSourcePath```配置，输出器将在实例化过程中**尝试创建```sourcePath/filePrefix```**，若**创建失败将导致运行环境降级为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```**。
  :::

  ::: tip 提示
  执行**文件分割**和**文件清理**时将对**归档源目录**中**归档前缀相同的文件/文件组**进行归类和计数（若无法从文件/文件组中提取**归档前缀**时，认为**归档前缀**为```''```）。因此，推荐**不同的日期输出器配置不同的归档前缀，并开启```filePrefixAsSourcePath```配置**。此时：
  
  - **不同输出器生成的日志文件/文件组将归档至不同目录**，目录结构更加清晰。
  - 执行日志文件统计（分割/清理）时，清理引擎认为**归档目录中全部文件具有相同归档前缀**，不再逐个对文件名组成结构进行解析，统计效率更高。
  :::

  关于文件分割/清理规则：

  - 执行文件分割时，将对**归档源目录**中所有**归档前缀**相同且**归档日期**与当前日期一致的文件组进行计数，得到文件组当前的**归档偏移**。当开启了```filePrefixAsSourcePath```配置时，将认为**归档目录**中全部文件的**归档前缀**相同，仅归类**归档日期**，执行效率更高。
  - 执行文件清理时，首先对**归档源目录**中所有**归档前缀**相同的文件或文件组按照**归档日期**分类得到**归档日期**列表，然后清理过期的**归档日期**对应的文件或文件组。当开启了```filePrefixAsSourcePath```时，将认为**归档目录**中所有文件的**归档前缀**相同，直接对文件按照**归档日期**分类，执行效率更高。

  ::: danger 注意
  此配置将极大的影响后续配置，输出器将自动确保以下配置规则：

  - 当此项未配置或为```''```时，将锁定```filePrefixAsSourcePath```、```filePrefixAsFileName```为```false```。即：**归档前缀无效时，无法将其附加至归档源目录和归档文件名**。
  - 当此配置不为```''```时，则```filePrefixAsSourcePath```和```filePrefixAsFileName```必须至少有一项为```true```。即：**归档前缀有效时，必须将其附加至归档源目录或归档文件名**。
  - 当此配置不为```''```时，若```filePrefixAsSourcePath```和```filePrefixAsFileName```都配置为```false```，输出器将锁定```filePrefixAsSourcePath```为```true```。即：**归档前缀有效时，若未配置其附加至归档源目录和归档文件名，将优先附加至归档源目录**。
  :::

- #### ```filePrefixAsSourcePath```

  设置此配置将指定输出器**附加归档前缀至归档源目录**，即归档目录为```sourcePath/filePrefix```，默认值为```true```。

  ::: warning 注意
  日期输出器将会自动确保以下规则：

  - 当```filePrefix```未配置或为```''```时，将锁定此配置为```false```。即：**归档前缀无效时，无法将其附加至归档源目录**。
  - 当```filePrefix```不为```''```时，则此配置和```filePrefixAsFileName```必须至少有一项为```true```。即：**归档前缀有效时，必须将其附加至归档源目录或归档文件名**。
  - 当```filePrefix```不为```''```时，若此配置和```filePrefixAsFileName```都配置为```false```，输出器将锁定此配置为```true```。即：**归档前缀有效时，若未配置其附加至归档源目录和归档文件名，将优先附加至归档源目录**。
  :::

- #### ```filePrefixAsFileName```

  设置此配置将指定输出器**附加归档前缀至归档文件名**，默认值为```true```。

  ::: warning 注意
  日期输出器将会自动确保以下规则：

  - 当```filePrefix```未配置或为```''```时，将锁定此配置为```false```。即：**归档前缀无效时，无法将其附加至归档源目录**。
  - 当```filePrefix```不为```''```时，则此配置和```filePrefixAsSourcePath```必须至少有一项为```true```。即：**归档前缀有效时，必须将其附加至归档源目录或归档文件名**。
  - 当```filePrefix```不为```''```时，若此配置和```filePrefixAsSourcePath```都配置为```false```，输出器将锁定```filePrefixAsSourcePath```为```true```。即：**归档前缀有效时，若未配置其附加至归档源目录和归档文件名，将优先附加至归档源目录**。
  :::

- #### ```dateFormat```
  
  设置此配置将指定输出器的**归档周期**和**归档日期格式**，默认值为```YYYY-MM-DD```。
  
  **归档日期将根据此格式附加至归档文件名中**，由于文件系统限制，**不能使用以下10个字符：```<\.:?*"|/>```，将被自动替换为```'_'```**。

  ::: danger 注意
  配置```dateFormat```时必须**使用递进方式组合日期元素**，即**设置的归档周期必须包含其前置周期**，比如：

  - 选择**月**作为归档周期时，配置```dateFormat```为```'YYYY-MM'```，即必须包含```'YYYY'```作为前置单位。
  - 选择**分**作为归档周期时，配置```dateFormat```为```'YYYY-MM-DD_HH_mm'```，必须包含```'YYYY'```、```'MM'```、```'DD'```、```'HH'```、```'mm'```作为前置单位。

  **输出器支持以月、日、时、分、秒（因年周期过长，故不支持）作为归档周期。可以使用以下日期元素：**
  
  - 年：```'YYYY'```
  - 月：```'MM'```
  - 日：```'DD'```
  - 时：```'HH'```
  - 分：```'mm'```
  - 秒：```'ss'```
  :::

- #### ```keepDateNum```

  设置此配置将指定输出器的**归档日期保留数量**，设置为**小于等于0的值时将关闭自动清理**，默认值为```0```。

  ::: warning 注意
  清理引擎在执行自动清理时，将保留含当前归档日期在内的最近```keepDateNum```个日期的归档文件或文件组。比如：
  - 当前有```2011-01.log```、```2011-02.log```、```2011-05.log```、```2011-08.log```、```2011-10.log```五个归档文件，当前是2011年10月且```keepDateNum```为```2```时，则保留```2011-10.log```、```2011-08.log```两个归档文件。
  :::

- #### ```maxSize```
  
  设置此配置将指定**归档文件组内最大的文件体积**，单位为```Byte```，设置为**小于等于0的值时将关闭自动分割**，默认值为```0```。

  ::: tip 提示
  启动文件分割功能后，归档文件名中将附加**归档偏移**。输出器将对**归档源目录**中所有**归档前缀**相同且**归档日期**与当前日期一致的文件组中的文件进行计数，得到文件组当前的**归档偏移**。当开启了```filePrefixAsSourcePath```时，将认为**归档目录**中全部文件的**归档前缀**相同，仅归类**归档日期**，执行效率更高。
  :::

- #### ```keepFileExt```

  设置此配置将指定是否为归档文件名附加```.log```作为拓展名，默认值为```true```。

### 样例代码

```javascript
const Core = require('node-corejs');
// 构造输出器
const logger = new Core.DateLogger({
  env: 'prod',
  level: 'infos',
  params: {
    // 日志归档目录: ./logs/DateLogger_Test/
    // 归档文件名称: DateLogger_Test.[归档时间].[归档偏移].log
    // 日志归档规则: 保留最后5秒内的日志文件,每个日志文件不超过1K
    sourcePath: './logs',
    filePrefix: 'DateLogger_Test',
    filePrefixAsSourcePath: true,
    filePrefixAsFileName: true,
    keepFileExt: true,
    dateFormat: 'YYYY-MM-DD_HH_mm_ss',
    keepDateNum: 5,
    maxSize: 1024
  },
});

// 每隔100ms输出日志
let count = 0;
setInterval(() => {
  count += 1;
  logger.log(new Error(`测试日志 -> [${count}]`));
}, 100);
```

## 文件输出器

文件输出器继承自[基础输出器](#基础输出器)，**在运行环境为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时与基础输出器保持一致的输出行为：将日志输出至控制台**。在其他运行环境下，输出器**输出的所有日志归档至同一文件中**。支持通过调整配置进行**归档日志分类**、**过期文件自动清理**等辅助功能。

::: tip 提示
文件输出器通常用于按次归档同类业务日志，将一次业务链路中产生的所有日志归档至同一文件。比如：按次归档应用处理用户请求时产生的日志，相同请求路径且每天内的日志归档至同一目录。
:::

**文件输出器支持[基础输出器](#基础输出器)的所有配置和功能，本节中仅介绍增量内容。**

### 功能说明

- 输出器输出的所有日志归档至同一文件中。
- 支持自动/手动模式管理输出器资源。
  
  ::: tip 说明
  - 自动模式：此模式下输出器将自动调用```start()```和```close()```控制资源的创建和释放，无需手动调用```start()```和```log()```，若强行调用将会输出警告日志。

    > - 输出器执行日志输出时将自动检测当前状态，若处于未启动状态则自动调用```start()```启动后再执行输出。
    > - 若输出器在```timeout```配置的时间没有执行日志输出行为时将自动调用```close()```释放资源。

  - 手动模式：此模式下输出器不自动执行```start()```和```close()```，需要手动显式调用。
  :::

- 支持设置归档目录、日志文件名的构成规则。

  归档目录可能由**源目录**、**归档前缀**、**归档日期**构成；日志文件名可能由**归档前缀**、**归档日期**、**归档文件名**、**归档类型**和**文件后缀**构成。
  
  **日志文件名结构为：<%归档前缀%>.<%归档文件名%>.<%归档日期%>.<%归档类型%>.<%文件后缀%>**。

  | 构成元素   | 规则                            |
  | :-------  | :----------------------------- |
  | 归档前缀   | 通过配置控制是否附加至日志文件名中   |
  | 归档日期   | 通过配置控制是否附加至日志文件名中   |
  | 归档文件名 | 一定出现在日志文件名中             |
  | 归档类型   | 通过配置控制是否附加至日志文件名中   |
  | 文件后缀   | 通过配置控制是否附加至日志文件名中   |

  ::: tip 关于归档类型
  **日志文件名核心元素为：<%归档前缀%>、<%归档日期%>、<%归档文件名%>。**

  - 当日志文件名核心元素**由<%归档文件名%>.<%归档日期%>构成**时，将自动附加**归档类型为```[FN]```**。
  - 当日志文件名核心元素**由<%归档前缀%>.<%归档文件名%>构成**时，将自动附加**归档类型为```[FP]```**。
  :::

- 支持设置保留周期个数，自动清理过期的日志文件或文件组。
- 输出异常时保证日志完整性。
  
  ::: tip 说明
  - 当文件输出器产生异常警告时（比如：非法调用、状态错误等）时，将输出警告日志到控制台，不导致运行环境降级。
  - 当文件输出器产生阻塞级异常（比如：无法创建目录、无法创建文件等）时，运行环境降级为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```。
  :::

### 功能参数

- #### ```sourcePath```

  设置此配置将指定输出器的**归档源目录**，默认值为```path.resolve(process.cwd(), `./logs/${process.pid}`)```。

  ::: danger 警告
  若**归档源目录**不存在时，输出器将在实例化过程中**尝试创建归档源目录**，若**创建失败将导致运行环境降级为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```**。
  :::

  ::: warning 注意
  - 由于文件系统限制，**归档源目录中不允许使用以下6个字符：```<?*"|>```，将被自动替换为```'_'```**。
  - **在```Cluster```架构的应用程序中**，为避免多进程抢夺相同资源导致异常，推荐**归档源目录使用进程标识作为构建元素**。
  :::

- #### ```auto```

  设置此配置将指定输出器**是否启动自动模式**，默认值为```true```。

- #### ```timeout```

  设置此配置将指定输出器**自动模式下释放资源的等待时间**，单位为毫秒，默认值为```10000```。

  ::: tip 提示
  此配置仅在**自动模式**（即：```auto```配置为```true```时）生效，在**手动模式**将锁定为```0```。
  :::

- #### ```fileName```
  
  设置此配置将指定日志文件的**归档文件名**，默认值为```_generateFileName()```。

  **归档文件名将附加至日志文件名中**，由于文件系统限制，**不能使用以下10个字符：```<\.:?*"|/>```，将被自动替换为```'_'```**。默认通过```_generateFileName()```生成**归档文件名**，即根据**进程标识**、**当前时间戳**和**8位随机小写字母和数字**组成16长度的字符串作为**归档文件名**。

  ::: danger 注意
  **归档文件名不是最终输出的日志文件名**，仅作为**最终输出的日志文件名的构成元素**。
  :::

- #### ```filePrefix```

  设置此配置将指定输出器的**归档前缀**，默认值为```''```。
  
  **归档前缀可配置附加至归档源目录或日志文件名**，由于文件系统限制，**不能使用以下10个字符：```<\.:?*"|/>```，将被自动替换为```'_'```**。

  ::: danger 注意
  若启动了```filePrefixAsSourcePath```配置，输出器将在实例化过程中**尝试创建```sourcePath/filePrefix```**，若**创建失败将导致运行环境降级为```Core.Macro.BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```**。
  :::

  ::: tip 提示
  执行**文件清理**时将对**归档源目录**中**归档前缀相同的文件**按照**归档日期**归类（若无法从文件中提取**归档前缀**时，认为**归档前缀**为```''```）。因此，推荐**输出同类日志的输出器配置相同的归档前缀，并开启```filePrefixAsSourcePath```**。此时：
  
  - **同类日志将被归档至相同目录**，目录结构更加清晰。
  - 执行日志文件清理时，清理引擎认为**归档目录中全部文件具有相同归档前缀**，不再逐个对文件进行解析，执行效率更高。
  :::

  关于文件清理规则：

  - 执行文件清理时，首先对**归档源目录**中所有**归档前缀**相同的文件按照**归档日期**分类得到**归档日期**列表，然后清理过期的**归档日期**对应的文件。当开启了```filePrefixAsSourcePath```时，将认为**归档目录**中所有文件的**归档前缀**相同，直接对文件按照**归档日期**分类，执行效率更高。

  ::: danger 注意
  此配置将极大的影响后续配置，输出器将自动确保以下配置规则：

  - 当此项未配置或为```''```时，将锁定```filePrefixAsSourcePath```、```filePrefixAsFileName```、```dateAsSourcePath```为```false```。即：**归档前缀无效时，无法将其附加至归档源目录和日志文件名，也无法附加归档日期至归档目录**。
  - 当此配置不为```''```时，则```filePrefixAsSourcePath```和```filePrefixAsFileName```必须至少有一项为```true```。即：**归档前缀有效时，必须将其附加至归档源目录或日志文件名**。
  - 当此配置不为```''```时，若```filePrefixAsSourcePath```和```filePrefixAsFileName```都配置为```false```，输出器将锁定```filePrefixAsSourcePath```为```true```。即：**归档前缀有效时，若未配置其附加至归档源目录和日志文件名，将优先附加至归档源目录**。
  :::

- #### ```filePrefixAsSourcePath```

  设置此配置将指定输出器**附加归档前缀至归档源目录**，即归档目录为```sourcePath/filePrefix```，默认值为```true```。

  ::: warning 注意
  文件输出器将会自动确保以下规则：

  - 当```filePrefix```未配置或为```''```时，将锁定此配置为```false```。即：**归档前缀无效时，无法将其附加至归档源目录**。
  - 当```filePrefix```不为```''```时，则此配置和```filePrefixAsFileName```必须至少有一项为```true```。即：**归档前缀有效时，必须将其附加至归档源目录或归档文件名**。
  - 当```filePrefix```不为```''```时，若此配置和```filePrefixAsFileName```都配置为```false```，输出器将锁定此配置为```true```。即：**归档前缀有效时，若未配置其附加至归档源目录和归档文件名，将优先附加至归档源目录**。
  - 若此配置为```false```时，将锁定```dateAsSourcePath```为```false```。即：**归档前缀未附加至归档源目录时，不允许附加归档日期至归档目录。**
  :::

- #### ```filePrefixAsFileName```

  设置此配置将指定输出器**附加归档前缀至日志文件名**，默认值为```true```。

  ::: warning 注意
  文件输出器将会自动确保以下规则：

  - 当```filePrefix```未配置或为```''```时，将锁定此配置为```false```。即：**归档前缀无效时，无法将其附加至归档源目录**。
  - 当```filePrefix```不为```''```时，则此配置和```filePrefixAsSourcePath```必须至少有一项为```true```。即：**归档前缀有效时，必须将其附加至归档源目录或归档文件名**。
  - 当```filePrefix```不为```''```时，若此配置和```filePrefixAsSourcePath```都配置为```false```，输出器将锁定```filePrefixAsSourcePath```为```true```。即：**归档前缀有效时，若未配置其附加至归档源目录和归档文件名，将优先附加至归档源目录**。
  :::

- #### ```dateFormat```

  设置此配置将指定输出器的**归档日期格式**，默认值为```YYYY-MM-DD```。
  
  **归档日期可配置附加至归档源目录或日志文件名**，由于文件系统限制，**不能使用以下10个字符：```<\.:?*"|/>```，将被自动替换为```'_'```**。

  ::: danger 注意
  配置```dateFormat```时必须**使用递进方式组合日期元素**，即**设置的归档周期必须包含其前置周期**，比如：

  - 选择**月**作为归档周期时，配置```dateFormat```为```'YYYY-MM'```，即必须包含```'YYYY'```作为前置单位。
  - 选择**分**作为归档周期时，配置```dateFormat```为```'YYYY-MM-DD_HH_mm'```，必须包含```'YYYY'```、```'MM'```、```'DD'```、```'HH'```、```'mm'```作为前置单位。

  **输出器支持以月、日、时、分、秒（因年周期过长，故不支持）作为归档周期。可以使用以下日期元素：**
  
  - 年：```'YYYY'```
  - 月：```'MM'```
  - 日：```'DD'```
  - 时：```'HH'```
  - 分：```'mm'```
  - 秒：```'ss'```
  :::

  通过启动```dateAsSourcePath```配置，将**归档日期**附加至**归档目录**，即：日志文件按照归档日期被归档至：```sourcePath/filePrefix/fileDate```。实现同一归档日期内的日志文件归档至同一目录中。此时：

  - **相同归档前缀的输出器在同一归档日期中的日志文件将归档至相同目录**，目录结构更加清晰。
  - 执行日志文件清理时，清理引擎认为**归档目录中全部文件具有相同的归档前缀和归档日期**，直接删除过期的目录，执行效率更高。

  ::: danger 注意
  此配置将极大的影响后续配置，输出器将自动确保以下配置规则：

  - 当此项未配置或为```''```时，将锁定```dateAsSourcePath```、```dateAsFileName```为```false```。即：**归档日期格式无效时，无法将其附加至归档目录和日志文件名**。
  - 当此配置不为```''```时，则```dateAsSourcePath```和```dateAsFileName```必须至少有一项为```true```。即：**归档日期格式有效时，必须将其附加至归档目录和日志文件名**。
  - 当此配置不为```''```时，若```dateAsSourcePath```和```dateAsFileName```都配置为```false```，输出器将锁定```dateAsSourcePath```为```true```。即：**归档日期格式有效时，若未配置其附加至归档目录和日志文件名，将优先附加至归档目录**。
  - 当此项不为```''```时，若```dateAsSourcePath```因```filePrefix```或```filePrefixAsSourcePath```被锁定为```false```时，则锁定```dateAsFileName```为```true```。即：**归档日期格式有效时，若因其他配置联动影响无法配置其附加至归档目录，将优先附加至归档文件名**。
  > 文件输出器不允许在**归档源目录**下直接创建**归档日期**目录，仅允许在**归档前缀**目录下创建。因此当```filePrefixAsSourcePath```为```false```时，将锁定```dateAsSourcePath```为```false```。因```filePrefix```无效时，```filePrefixAsSourcePath```将锁定为```false```，根据联动关系，此时将锁定```dateAsSourcePath```为```false```。
  :::

- #### ```dateAsSourcePath```

  设置此配置将指定输出器**附加归档日期至归档目录**，即归档目录为```sourcePath/filePrefix/fileDate```，默认值为```true```。

  ::: warning 注意
  文件输出器将会自动确保以下规则：

  - 当```dateFormat```未配置或为```''```时，将锁定此配置为```false```。即：**归档日期格式无效时，无法将其附加至归档目录**。
  - 当```dateFormat```不为```''```时，则此配置和```dateAsFileName```必须至少有一项为```true```。即：**归档日期格式有效时，必须将其附加至归档目录或日志文件名**。
  - 当```dateFormat```不为```''```时，若此配置和```dateAsFileName```都配置为```false```，输出器将锁定此配置为```true```。即：**归档日期格式有效时，若未配置其附加至归档目录和日志文件名，将优先附加至归档目录**。
  - 当```dateFormat```不为```''```时，若此配置因```filePrefix```或```filePrefixAsSourcePath```被锁定为```false```时，则锁定```dateAsFileName```为```true```。即：**归档日期格式有效时，若因其他配置联动影响无法配置其附加至归档目录，将优先附加至归档文件名**。
  > 文件输出器不允许在**归档源目录**下直接创建**归档日期**目录，仅允许在**归档前缀**目录下创建。因此当```filePrefixAsSourcePath```为```false```时，将锁定此配置为```false```。因```filePrefix```无效时，```filePrefixAsSourcePath```将锁定为```false```，根据联动关系，此时将锁定此配置为```false```。
  :::

- #### ```dateAsFileName```

  设置此配置将指定输出器**附加归档日期至日志文件名**，默认值为```true```。

  ::: warning 注意
  文件输出器将会自动确保以下规则：

  - 当```dateFormat```未配置或为```''```时，将锁定此配置为```false```。即：**归档日期格式无效时，无法将其附加至日志文件名**。
  - 当```dateFormat```不为```''```时，则此配置和```dateAsSourcePath```必须至少有一项为```true```。即：**归档日期格式有效时，必须将其附加至归档目录或日志文件名**。
  - 当```dateFormat```不为```''```时，若此配置和```dateAsSourcePath```都配置为```false```，输出器将锁定```dateAsSourcePath```为```true```。即：**归档日期格式有效时，若未配置其附加至归档目录和日志文件名，将优先附加至归档目录**。
  - 当```dateFormat```不为```''```时，若```dateAsSourcePath```因```filePrefix```或```filePrefixAsSourcePath```被锁定为```false```时，则锁定此配置为```true```。即：**归档日期格式有效时，若因其他配置联动影响无法配置其附加至归档目录，将优先附加至归档文件名**。
  > 文件输出器不允许在**归档源目录**下直接创建**归档日期**目录，仅允许在**归档前缀**目录下创建。因此当```filePrefixAsSourcePath```为```false```时，将锁定```dateAsSourcePath```为```false```。因```filePrefix```无效时，```filePrefixAsSourcePath```将锁定为```false```，根据联动关系，此时将锁定```dateAsSourcePath```为```false```。
  :::

- #### ```keepDateNum```

  设置此配置将指定输出器的**归档日期保留数量**，设置为**小于等于0的值时将关闭自动清理**，默认值为```0```。

  ::: tip 提示
  执行文件清理时，首先对**归档源目录**中所有**归档前缀**相同的文件按照**归档日期**分类得到**归档日期**列表，然后清理过期的**归档日期**对应的文件。
  
  - 开启```dateAsSourcePath```选项时，**清理引擎**认为```sourcePath/filePrefix```下的目录为**归档日期**，不再逐个对文件名组成结构进行解析，执行效率更高。
  - 开启```filePrefixAsSourcePath```时，**清理引擎**认为```sourcePath/filePrefix```中全部文件具有相同的**归档前缀**，不再逐个对文件名组成结构进行解析，执行效率更高。
  :::

  ::: warning 注意
  清理引擎在执行自动清理时，将保留含当前归档日期在内的最近```keepDateNum```个日期的归档文件或文件组。比如：
  - 当前有```2011-01.log```、```2011-02.log```、```2011-05.log```、```2011-08.log```、```2011-10.log```五个归档文件，当前是2011年10月且```keepDateNum```为```2```时，则保留```2011-10.log```、```2011-08.log```两个归档文件。
  :::

- #### ```keepFileExt```

  设置此配置将指定是否为归档文件名附加```.log```作为拓展名，默认值为```true```。

### 样例代码

```javascript
const Core = require('node-corejs');

let count = 0;
setInterval(() => {
  count += 1;
  const logger = new Core.FileLogger({
    env: 'prod',
    level: 'infos',
    params: {
      // 日志归档目录: ./logs/FileLogger_Test/[归档时间]/
      // 归档文件名称: FileLogger_Test.[归档文件名].[归档时间].log
      // 日志归档规则: 将每秒的日志归档至同一目录，保留最后5秒内的日志文件
      sourcePath: './logs',
      auto: true,
      timeout: 5000,
      filePrefix: 'FileLogger_Test',
      filePrefixAsSourcePath: true,
      filePrefixAsFileName: true,
      dateFormat: 'YYYY-MM-DD_HH_mm_ss',
      dateAsSourcePath: true,
      dateAsFileName: true,
      keepDateNum: 5,
      keepFileExt: true,
    },
  });
  logger.log(new Error(`测试日志 -> ${count}`));
  logger.log(new Error(`测试日志 -> ${count}`));
  logger.log(new Error(`测试日志 -> ${count}`));
  logger.log(new Error(`测试日志 -> ${count}`));
  logger.log(new Error(`测试日志 -> ${count}`));
}, 100);
```
