# 日志输出器

::: tip 说明
本章中使用的宏变量存储在```Core.Macros```中。
:::

## 输出模型

[输出模型](/images/test.png)

## 输出器配置

通常，实例化**日志输出器**需要使用由**运行环境**、**最小输出等级**和**功能参数**构成的配置对象，即```{ env, level, params }```。

- ```env```：**日志输出器**的**运行环境**，默认值为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```。

  需要注意的是，**运行环境**将影响**日志输出器**的行为：

  - 当运行环境为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，日志将统一输出到控制台。
  - 当运行环境不为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，日志输出器将根据实际类型产生对应的输出行为。

  ::: warning 注意
  对于Corejs内置的[日期输出器](#日期输出器)和[文件输出器](#文件输出器)，当运行环境为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，日志将输出至控制台。在输出器启动和关闭时，仅执行基本的状态判断，不再执行资源计算，也不再申请操作系统文件句柄资源。

  **同样，我们在[自定义输出器](/guide/logger-customizing.html)时也应该遵守在```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```下输出日志到控制台的约定。**
  :::

- ```level```：最小日志输出等级的名称或别名，**日志输出器**仅输出权重大于等于此输出等级的日志。

  最小输出等级的默认值依赖于当前**日志输出器**的**运行环境**：

  - 当运行环境为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，默认值为：```all```。
  - 当运行环境不为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时，默认值为：```error```。
  
  ::: tip 说明 
  如果业务指定或系统默认的**最小输出等级**不在日志输出器的输出等级支持列表中时，**日志输出器**将使用[等级选举](#等级选举)产生的**默认日志等级**作为**最小输出等级**。

  我们可以在[输出等级](#输出等级)一节中了解**日志输出器**原生支持的输出等级。
  :::

- ```params```：**日志输出器**的功能配置参数，将控制**日志输出器**的输出行为。

  ::: tip 提示
  功能配置参数将在实例化过程中成为**日志输出器**的实例属性。
  
  因此，我们可以在[自定义输出器](/guide/logger-customizing.html)时使用功能配置参数的缓存机制存储**自定义参数**。这样，我们可以在输出器生命周期的任意阶段通过解构```this.params```访问**自定义参数**。
  
  **需要注意的是，自定义参数不要与功能配置参数的键名冲突，否则将影响日志输出器的行为。**
  :::

## 输出等级

**日志输出器**支持在**配置输出等级**和**执行输出动作**时使用**输出等级名称**和**输出等级别名**表示日志输出等级。

默认支持6个**日志输出等级**：

| 日志类型 | 等级名称        | 等级别名                 | 权重         |
| :------ | :------------ | :---------------------- | :---------- |
| 追踪日志 | ```'trace'``` | ```'t'```               | ```10000``` |
| 调试日志 | ```'debug'``` | ```'t'```               | ```20000``` |
| 信息日志 | ```'infos'``` | ```'i'```、```'info'``` | ```30000``` |
| 警告日志 | ```'warns'``` | ```'w'```、```'warn'``` | ```40000``` |
| 错误日志 | ```'error'``` | ```'e'```、```'err'```  | ```50000``` |
| 灾难日志 | ```'fatal'``` | ```'f'```               | ```60000``` |

另外，**日志输出器**使用2个内部**日志输出等级**用于等级管理：

| 日志过滤规则 | 等级名称      | 等级别名                 | 等级权重      |
| :--------- | :---------- | :---------------------- | :----------- |
| 保留所有日志 | ```'all'``` | ```'a'```               | ```0```      |
| 禁止所有日志 | ```'off'``` | ```'o'```               | ```100000``` |

---

**日志输出器**内部使用三个可以通过**功能配置参数**指定的**基准输出等级**：

- 默认日志等级
- 默认警告日志等级
- 默认错误日志等级

如果**基准输出等级**未在配置项中指定或指定了不在输出等级支持列表中的等级时，将使用[等级选举](#等级选举)产生的**基准输出等级**。

## 等级选举

在**日志输出器**实例化时将进行**等级选举**。进行**等级选举**的目的是在**输出等级支持列表**中选出**基准输出等级**的默认值。一旦某个**基准输出等级**无效，则使用选举结果。

::: warning 注意
**等级选举**将产生绝对有效的**默认日志等级**、**默认警告日志等级**和**默认错误日志等级**，但是**日志输出器**不会应用全部的选举结果。

比如当业务层指定的**默认日志等级**无效，但是**默认警告日志等级**和**默认错误日志等级**有效时，**日志输出器**仅使用选举结果中的**默认日志等级**。
:::

---

输出等级选举规则为：

1. 枚举**输出等级支持列表**中的每个**输出等级**，尝试在配置了```default```为```true```的**输出等级**中选择权重最高项作为**默认日志等级**。

2. 若上述步骤未能产生**默认日志等级**（比如：**输出等级支持列表**中不存在```default```为```true```的**输出等级**），则使用**输出等级支持列表**中权重居中项作为**默认日志等级**。

3. 若上述步骤产生了两个**权重居中**的**输出等级**，则使用**权重较小项**（两者中前者）作为**默认日志等级**。

4. 选举比**默认日志等级**权重大一个梯度的输出等级（即**输出等级支持列表**按权重升序排列后位于**默认日志等级**后一个位置的**输出等级**）作为**默认警告日志等级**。

5. 若上述步骤未能产生**默认警告日志等级**（比如：**默认日志等级**位于**输出等级支持列表**的最末位），则使用**默认日志等级**作为**默认警告日志等级**。 

6. 选举比**默认日志等级**权重大二个梯度的输出等级（即**输出等级支持列表**按权重升序排列后位于**默认日志等级**后二个位置的**输出等级**）作为**默认错误日志等级**。

7. 若上述步骤未能产生**默认错误日志等级**（比如：**默认日志等级**位于**输出等级支持列表**的最末位或倒数第二位），则使用**默认警告日志等级**作为**默认错误日志等级**。

## 基础输出器

**基础输出器**提供了**日志输出器**的基本功能，将日志输出到控制台。因此，我们在生产环境中通常不使用**基础输出器**进行日志收集。

另外，我们在[自定义输出器](/guide/logger-customizing.html)时需要继承**基础输出器**，否则自定义的输出器将无法通过一些**日志输出器**类型判断的校验。

### 功能说明

1. 日志输出至控制台。

2. 支持**日志输出器自**启动。即：实例化后自动启动**日志输出器**，无需显式执行```start()```即可执行输出动作。

3. 在```start()```、```close()```和```log()```时内置状态检测机制（可通过配置调整，默认打开）。

   - **执行```log()```时**：检测**日志输出器**是否处于启动状态，若**日志输出器**未启动则**放弃此次日志输出**。

   - **执行```start()```时**：检测**日志输出器**是否已处于启动状态，若**日志输出器**已启动则**不再执行启动逻辑**。

   - **执行```close()```时**：检测**日志输出器**是否已处于关闭状态，若**日志输出器**已关闭则**不再执行关闭逻辑**。

   ::: tip 说明
   当**日志输出器**尝试发起某个动作但未通过状态检测时将抛出异常信息，可通过在实例化时配置```_errorHandler```对异常进行捕获。
   :::

4. 支持多种快捷打印日志的调用方式。

   | 调用方式                             | 说明                                                       |
   | :---------------------------------- | :-------------------------------------------------------- |
   | ```log(message)```                  | 根据日志内容智能选择**日志输出等级**，且根据当前调用栈获取调用方法名 |
   | ```log(level, message)```           | 使用指定的输出等级（别名）输出日志，且根据当前调用栈获取调用方法名   |
   | ```log(level, funcName, message)``` | 使用指定的输出等级（别名）和指定方法名输出日志                    |

   ::: tip 说明

   执行```log(message)```时，**日志输出器**将根据日志内容```message```的类型自动选择日志输出等级：

   - **```message```不为```Error```类型**：使用**默认日志等级**输出日志。
   - **```message```为```Error```类型**：使用**默认错误日志等级**输出日志。
   
   ---

   执行```log()```时，如果**日志输出等级**的权重高于或等于**默认错误日志等级**时，将在日志内容中附加当前调用栈。

   - 日志内容为```Error```类型时，使用```Error```实例携带的调用栈。
   - 日志内容为非```Error```类型时，使用实际调用栈。我们可以通过在**日志输出器**实例化时配置```callStackOffset```调整构建调用栈时的偏移基准。

   :::

5. 日志内容输出格式：

   **[<%YYYY-MM-DD HH:mm:ss.SSS+ZZZZ%>] [<%ENV%> LOG] [<%LEVEL%>] - <<%FUNC_NAME%>><<%MESSAGE%>\n<%CALL_STACK%>\n>**

   | 内容元素                          | 说明        |
   | :------------------------------- | :--------- |
   | <%YYYY-MM-DD HH:mm:ss.SSS+ZZZZ%> | 时间戳字符串 |
   | <%ENV%>                          | 当前运行环境 |
   | <%LEVEL%>                        | 日志输出等级 |
   | <%FUNC_NAME%>                    | 调用方法名   |
   | <%MESSAGE%>                      | 日志文案     |
   | <%CALL_STACK%>                   | 当前调用栈   |

### 功能参数

- #### ```defaultLevel```

  设置此配置将指定**日志输出器**的**默认日志等级**，默认值为：```null```。

  我们可以使用**日志输出等级**的名称或别名作为**默认日志等级**。当指定此配置为```null```或指定了不在**输出等级支持列表**中的值时，将使用[等级选举](#等级选举)产生的**默认日志等级**。

  ::: tip 使用默认日志等级的场景
  
  - **日志输出器**配置的**最小输出等级**不在**输出等级支持列表**中时，将使用**默认日志等级**作为**最小输出等级**。
  - **日志输出器**使用```log(message)```方式输出日志，且日志内容```message```不为```Error```类型时，将使用**默认日志等级**输出日志。
  - **日志输出器**使用```log(level, message)```方式输出日志，且指定的**输出等级**不在**输出等级支持列表**中时，将使用**默认日志等级**输出日志。
  - **日志输出器**使用```log(level, funcName, message)```方式输出日志，且指定的**输出等级**不在**输出等级支持列表**中时，将使用**默认日志等级**输出日志。
  :::

  让我们来看一个设置**默认日志等级**的🌰：

  ```javascript
  const Core = require('node-corejs');

  // 创建一个指定了无效最小输出等级的输出器
  const logger = new Core.BaseLogger({
    level: 'x', // 此时最小输出等级为error
    params: { defaultLevel: 'error' },
  });

  logger.log('i', '此条日志不会被输出');             // infos日志权重小于当前的最小输出等级error
  logger.log('这是一条红色的错误日志');               // 不指定输出等级时将使用默认等级error
  logger.log('x', '这是一条红色的错误日志');          // 输出等级无效时将使用默认等级error
  logger.log('x', '方法名', '这是一条红色的错误日志'); // 输出等级无效时将使用默认等级error
  ```

- #### ```defaultWarnsLevel```

  设置此配置将指定**日志输出器**的**默认警告日志等级**，默认值为：```null```。

  我们可以使用**日志输出等级**的名称或别名作为**默认警告日志等级**。当指定此配置为```null```或指定了不在**输出等级支持列表**中的值时，将使用[等级选举](#等级选举)产生的**默认日志等级**。

  ::: tip 说明
  **默认警告日志等级**是**日志输出器**的预留属性，并没有在实际业务中使用。
  
  我们可以在[自定义输出器](/guide/logger-customizing.html)过程中，处理内部产生的异常时使用**默认警告日志等级**进行输出。
  :::

- #### ```defaultErrorLevel```

  设置此配置将指定**日志输出器**的**默认错误日志等级**，默认值为：```null```。

  我们可以使用**日志输出等级**的名称或别名作为**默认错误日志等级**。当指定此配置为```null```或指定了不在**输出等级支持列表**中的值时，将使用[等级选举](#等级选举)产生的**默认日志等级**。

  ::: tip 使用默认错误日志等级的场景
  - **日志输出器**使用```log(message)```方式输出日志，且日志内容```message```为```Error```类型时，将使用**默认错误日志等级**输出日志。
  - **日志输出器**使用```log(level, message)```方式输出日志，且指定的**日志输出等级**的权重高于或等于**默认错误日志等级**的权重时，将在日志内容中附加调用栈。
  - **日志输出器**使用```log(level, funcName, message)```方式输出日志，且指定的**日志输出等级**的权重高于或等于**默认错误日志等级**的权重时，将在日志内容中附加调用栈。
  :::

  让我们来看一个设置**默认错误日志等级**的🌰：

  ```javascript
  const Core = require('node-corejs');

  // 创建一个指定infos为默认错误等级的输出器
  const logger = new Core.BaseLogger({
    params: { defaultErrorLevel: 'i' },
  });

  logger.log(new Error('这是一条绿色且包含调用栈的错误日志'));        // Error类型的日志内容将以infos等级输出
  logger.log('i', new Error('这是一条绿色且包含调用栈的错误日志'));   // 指定infos及以上的输出等级时将在日志内容中添加调用栈
  logger.log('d', new Error('这是一条蓝色且不包含调用栈的错误日志')); // debug等级的权重小于infos因此不在日志内容中添加调用栈
  ```

- #### ```callStackOffset```

  设置此配置将指定**日志输出器**构建调用栈时使用的**偏移基准**，默认值为：```BASE_LOGGER_DEFAULT_CALLSTACK_OFFSET```。

  ---

  我们可以根据实际场景使用```Function```或```Number```类型的**偏移基准**：

  - **```Function```类型**：**日志输出器**通过```Error.captureStackTrace()```提取执行日志输出动作时的调用栈，即仅保留调用链路中**偏移基准**上层的调用栈记录。
    
    ::: warning 注意
    通过```Error.captureStackTrace()```提取调用栈时，如果指定的**偏移基准**不在调用链路中则将获取到空的调用栈。
    
    因此，我们在使用```Function```类型的**偏移基准**时务必需要保证**偏移基准**存在于调用链路中。
    :::
  
  - **```Number```类型**：**日志输出器**首先通过```Error.captureStackTrace()```提取```log()```之前的调用栈记录，接下来通过```slice()```指定的**偏移基准**得到最终的调用栈。

    ::: warning 注意
    **日志输出器**默认的**偏移基准**```BASE_LOGGER_DEFAULT_CALLSTACK_OFFSET```的值为```0```。通常，我们通过对```BASE_LOGGER_DEFAULT_CALLSTACK_OFFSET```进行+/-操作得到期望的**偏移基准**。
    
    需要注意的是，nodejs默认提取```10```条调用栈记录；而使用```Number```类型的**偏移基准**将在此基础上进行偏移，会降低调用栈的信息量。
    :::
  
  ---

  通常，我们使用**日志输出器**的某个原型方法作为```Function```类型的**偏移基准**。
  
  比如，我们想查看**基础输出器**的日志输出链路组成的调用栈信息：

  ```javascript
  const Core = require('node-corejs');

  // 创建BaseLogger
  const logger = new Core.BaseLogger({
    // 使用BaseLogger的原型方法作为偏移基准
    params: { callStackOffset: Core.BaseLogger.prototype.buildCallSnapshot }
  });

  logger.log('e', '日志输出链路的实际调用栈');
  ```

  ::: tip 说明
  当日志内容```message```为```Error```类型时，将使用```message```携带的调用栈信息，不受**偏移基准**影响。
  :::

- #### ```_checkStateInLog```

  设置此配置将指定**日志输出器**在执行```log()```时是否检查输出器状态，默认值为：```true```。

  在**日志输出器**的输出模型设计上，输出器的状态（开启/关闭）应与输出动作所需资源的创建与否具有相关性。因此，**日志输出器**引入了此配置在执行输出动作时检查输出器状态。
  
  启用此配置后，如果**日志输出器**在执行输出动作时处于关闭状态，将抛出异常信息并跳过输出。异常信息可通过实例化**日志输出器**时配置[```_errorHandler```](#errorhandler)进行捕获。

- #### ```_checkStateInStart```

  设置此配置将指定**日志输出器**在执行```start()```时是否检查输出器状态，默认值为：```true```。

  ::: danger 警告
  **日志输出器**默认开启此配置用于避免资源创建的相关逻辑多次执行，请谨慎调整此配置。
  :::

  启用此配置后，如果**日志输出器**在执行启动动作时已经处于开启状态，则抛出异常信息并放弃执行后续的启动逻辑。异常信息可通过实例化**日志输出器**时配置[```_errorHandler```](#errorhandler)进行捕获。

- #### ```_checkStateInClose```

  设置此配置将指定**日志输出器**在执行```close()```时是否检查输出器状态，默认值为：```true```。

  ::: danger 警告
  **日志输出器**默认开启此配置用于防止资源释放的相关逻辑多次执行，请谨慎调整此配置。
  :::

  启用此配置后，如果**日志输出器**在执行关闭动作时已经处于关闭状态，则抛出异常信息并放弃执行后续的关闭逻辑。异常信息可通过实例化**日志输出器**时配置[```_errorHandler```](#errorhandler)进行捕获。

- #### ```_errorHandler```
  
  设置此配置将指定**日志输出器**的**异常处理器**。
  
  **异常处理器**是一个参数列表为```(errType, errDetail)```的```Function```：

  - **```errType```**：异常的类型，为```String```。

    在**基础输出器**的**异常处理器**中，可能捕获到以下类型的异常：

    | 名称                                     | 描述                   | 产生原因                            |
    | :-------------------------------------- | :--------------------- | :-------------------------------- |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_LOG```   | 日志输出器无法执行输出动作 | 日志输出器输出链路中产生了未被捕获的异常 |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_INIT```  | 日志输出器无法构建/实例化  | 日志输出器实例化过程中产生了未被捕获异常 |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_START``` | 日志输出器无法启动        | 日志输出器启动时产生了未被捕获的异常    |
    | ```BASE_LOGGER_ERROR_TYPE_CANT_CLOSE``` | 日志输出器无法关闭        | 日志输出器关闭时产生了未被捕获的异常    |
  
  - **```errDetail```**：异常的细节信息，为```Object```。**基础输出器**中异常的细节信息结构为：```{ error }```。

    通常，异常细节信息中的```error```指向造成异常的```Error```对象，**基础输出器**将在以下场景中抛出自定义```Error```：

    | Error                                | 描述                | 产生原因                           |
    | :----------------------------------- | :----------------- | :-------------------------------- |
    | ```BASE_LOGGER_MESSAGE_CANT_LOG```   | 日志输出器无法输出日志 | 日志输出器执行输出动作时无法通过状态检验 |
    | ```BASE_LOGGER_MESSAGE_CANT_START``` | 日志输出器无法启动    | 日志输出器执行启动行为时无法通过状态校验 |
    | ```BASE_LOGGER_MESSAGE_CANT_CLOSE``` | 日志输出器无法关闭    | 日志输出器执行关闭行为时无法通过状态校验 |

    ::: tip 提示
    我们可能遇到一些需要自定义异常文案的场景，此时可以通过在这些自定义```Error```产生之前修改```Core.Messages```中对应的宏变量以实现对自定义```Error```文案的变更。
    :::

## 日期输出器

**日期输出器**继承自[基础输出器](#基础输出器)，支持**基础输出器**的所有**配置参数**。并且，在**运行环境**为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时保持与**基础输出器**一致的输出行为，即：将日志输出至控制台。

另外，**日期输出器**还拓展了许多激动人心的功能，我们可以在周期性归档日志的场景中使用它。

**日期输出器**在非```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```的**运行环境**中，提供了按**归档周期**归档日志的能力。我们可以选择将日志输出至**单个日志文件**或是自动拆分成**多个日志文件**。同时，我们还可以指定**归档周期保留数量**，**日期输出器**会帮我们自动清理过期的**日志文件**。

### 功能说明

1. 将日志按照指定的**归档周期**归档至文件中。

2. 支持**日志文件**自动分割。

3. 支持设置**周期保留数量**。

4. 支持设置日志输出目录和文件名的构成规则。

   ::: tip 关于日志输出目录和文件名

   - **日志输出目录**可能由**归档源目录**和**归档前缀**构成。

   - **日志文件名**结构为：**<%归档前缀%>.<%归档日期%>.<%归档偏移%>.<%文件后缀%>**。

   | 构成元素 | 规则                                                                              |
   | :------ | :------------------------------------------------------------------------------- |
   | 归档前缀 | 通过实例化日期输出器时配置```filePrefix```和```filePrefixAsFileName```附加至日志文件名中 |
   | 归档日期 | 一定出现在归档文件名中。日期格式将使用实例化日期输出器时指定的```dateFormat```              |
   | 归档偏移 | 通过实例化日期输出器时配置```maxSize```启动日志文件自动分割时会附加至日志文件名中            |
   | 文件后缀 | 通过实例化日期输出器时配置```keepFileExt```启用日志文件后缀时会附加至日志文件名中           |

   :::

5. 输出环境异常时自动降级保证日志完整性。
  
   ::: tip 说明
   当**日志输出器**无法创建日志输出目录或文件时，**运行环境**自动降级至```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```将日志输出至控制台。
   :::

### 异常捕获

与**基础输出器**捕获异常的方式相同，在实例化**日期输出器**时指定异常处理器```_errorHandler```即可对**日期输出器**运行过程中产生的异常进行捕获。

---

**日期输出器**中的异常处理器对异常类型```errType```进行了拓展：

| 异常类型（```errType```）                         | 描述              | 产生原因                            |
| :---------------------------------------------- | :---------------- | :-------------------------------- |
| ```DATE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   | 无法创建日志输出文件 | 应用权限不足或操作系统异常（磁盘不足等） |
| ```DATE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` | 无法创建日志输出目录 | 应用权限不足或操作系统异常（磁盘不足等） |

同时，**日期输出器**拓展的异常类型附带的细节信息```errDetail```也更加详细，其结构为```{ error, errorPath, errorDescription }```。

- **```error```**：导致异常的```Error```实例。
- **```errorPath```**：导致异常的日志输出目录/文件路径。
- **```errorDescription```**：异常的描述文案。

我们同样可以通过修改```Core.Messages```中对应的宏变量以变更异常描述文案```errorDescription```：

| 异常描述宏                                     | 产生时机                     | 异常类型（```errType```）归属                      |
| :------------------------------------------- | :-------------------------- | :---------------------------------------------- |
| ```DATE_LOGGER_MESSAGE_CANT_CREATE_FILE```   | 日期输出器无法创建日志输出文件时 | ```DATE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   |
| ```DATE_LOGGER_MESSAGE_CANT_CREATE_FOLDER``` | 日期输出器无法创建日志输出目录时 | ```DATE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` |

### 功能参数

- #### ```sourcePath```

  设置此配置将指定**日期输出器**的**归档源目录**，默认值为```path.resolve(process.cwd(), `./logs/${process.pid}`)```。

  **归档源目录**是进行日志文件分割/清理的工作区，我们将在[日志分割](#日志分割)和[日志清理](#日志清理)中进行详细讨论。

  ::: tip 提示

  - 由于文件系统限制，我们在设置**归档源目录**时不能使用```<?*"|>```这6个非法字符，**日期输出器**将自动替换非法字符为```'_'```。

  - 在使用了```Cluster```架构的应用程序中，多进程抢夺相同的文件资源导致日志归档异常。因此，我们应尽量使用进程标识符（比如：```process.pid```）作为**归档源目录**的构成元素。

  - 当由**归档源目录**或**归档前缀**构成的**日志输出目录**在文件系统中不存在时，**日期输出器**将在实例化过程中尝试创建；如果**日志输出目录**创建失败将导致**运行环境**降级。

  :::

  ---

  通常，应用程序中的**日志输出器**使用相同的**归档源目录**以实现日志的集中存储：

  ```javascript
  const Core = require('node-corejs');

  // 公用的日志归档源目录
  const sourcePath = './testlogs';

  // 创建第一个日期输出器
  const logger1 = new Core.DateLogger({
    env: 'prod',
    params: { filePrefix: 'DateLogger1', sourcePath }
  });

  // 创建第二个日期输出器
  const logger2 = new Core.DateLogger({
    env: 'prod',
    params: { filePrefix: 'DateLogger2', sourcePath }
  });
  ```

- #### ```filePrefix```

  设置此配置将指定**日期输出器**的**归档前缀**，默认值为```''```。

  **归档前缀**可以作为**日志输出目录**和**日志文件名**的组成部分。因此，由于文件系统限制，我们在设置**归档前缀**时不能使用```<\.:?*"|/>```这10个非法字符，**日期输出器**将自动替换非法字符为```'_'```。
  
  ::: danger 注意
  **归档前缀**是一个非常关键的配置项，将极大影响**日期输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动)一节中进行详细讨论。
  :::

- #### ```filePrefixAsSourcePath```

  设置此配置将指定**日期输出器**是否在**归档源目录**中创建以**归档前缀**命名的目录用于存放**日志文件**，即在文件系统中使用**归档前缀**分类**日志文件**，默认值为```true```。

  ::: danger 注意
  此配置与**归档前缀**和**使用归档前缀构建日志输出文件**具有联动关系。因此，当我们指定的值违反联动关系时可能被**日期输出器**重置。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动)一节中进行详细讨论。
  :::

- #### ```filePrefixAsFileName```

  设置此配置将指定**日期输出器**是否在**日志文件名**中展示**归档前缀**，默认值为```true```。

  ::: danger 注意
  此配置与**归档前缀**和**使用归档前缀构建日志输出目录**具有联动关系。因此，当我们指定的值违反联动关系时可能被**日期输出器**重置。
  
  对于联动关系的注意事项，我们将在[配置联动](#配置联动)一节中进行详细讨论。
  :::

---

让我们来看一个使用**归档前缀**构建**日志输出目录**和**日志输出文件**的🌰：

```javascript
const Core = require('node-corejs');

const sourcePath = './testlogs';

// 日志输出目录：./testlogs/DateLogger1
// 日志输出文件：[归档日期].log
const logger1 = new Core.DateLogger({
  env: 'prod',
  level: 'infos',
  params: {
    sourcePath,
    filePrefix: 'DateLogger1',
    filePrefixAsFileName: false,
    filePrefixAsSourcePath: true,
  }
});

// 日志输出目录：./testlogs/DateLogger2
// 日志输出文件：DateLogger2.[归档日期].log
const logger2 = new Core.DateLogger({
  env: 'prod',
  level: 'infos',
  params: {
    sourcePath,
    filePrefix: 'DateLogger2',
    filePrefixAsFileName: true,
    filePrefixAsSourcePath: true,
  }
});

// 日志输出目录：./testlogs
// 日志输出文件：DateLogger3.[归档日期].log
const logger3 = new Core.DateLogger({
  env: 'prod',
  level: 'infos',
  params: {
    sourcePath,
    filePrefix: 'DateLogger3',
    filePrefixAsFileName: true,
    filePrefixAsSourcePath: false,
  }
});

// 执行日志输出
logger1.log('一条🌰日志');
logger2.log('一条🌰日志');
logger3.log('一条🌰日志');
```

- #### ```dateFormat```
  
  设置此配置将指定**日期输出器**的**归档周期**和**归档日期格式**，默认值为```YYYY-MM-DD```。
  
  **归档日期**将根据此配置中指定的**归档日期格式**附加至**日志文件名**。因此，由于文件系统限制，我们在设置此配置时不能使用```<\.:?*"|/>```这10个非法字符，**日期输出器**将自动替换非法字符为```'_'```。

  我们需要注意的是，指定**归档日期格式**时必须使用**递进方式组合日期元素**，即**归档日期格式**必须包含**归档周期**前置的所有日期元素。

  ---

  首先我们需要知道，**日期输出器**支持以月、日、时、分、秒（因年周期过长，故不支持）作为归档周期，其对应的日期元素为：

  - **年**：```'YYYY'```
  - **月**：```'MM'```
  - **日**：```'DD'```
  - **时**：```'HH'```
  - **分**：```'mm'```
  - **秒**：```'ss'```

  接下来我们来看几个关于**递进方式组合日期元素**的🌰：

  - 当选择**月**作为**归档周期**时，则需要包含的日期元素为年（```'YYYY'```）和月（```'MM'```），因此我们指定**归档日期格式**为：```'YYYY-MM'```。

  - 当选择**分**作为**归档周期**时，则需要包含的日期元素为年（```'YYYY'```）、月（```'MM'```）、日（```'DD'```）、时（```'HH'```）和分（```'mm'```），因此我们指定**归档日期格式**为：```'YYYY-MM-DD_HH_mm'```。

  ---

  现在，我们可以尝试构建一个以秒为**归档周期**的**日期输出器**：

  ```javascript
  const Core = require('node-corejs');

  // 创建输出器
  const logger = new Core.DateLogger({
    env: 'prod',
    level: 'infos',
    params: {
      sourcePath: './testlogs',
      dateFormat: 'YYYY-MM-DD_HH_mm_ss' // 指定日期格式和归档周期
    }
  });
  
  // 每150ms执行一次日志输出
  setInterval(() => { logger.log('一条🌰日志') }, 150);
  ```


- #### ```keepDateNum```

  设置此配置将指定**日期输出器**的**归档周期保留数量**，当指定了```<=0```的值时将关闭自动清理，默认值为```0```。

  需要注意的是，**日期输出器**将保留包含当前**归档周期**在内的最近```keepDateNum```个周期内生成的**日志文件**。

  ---

  让我们来看一个🌰：
  
  1. 指定**归档周期保留数量**为```2```。

  2. 指定**归档日期格式**为```'YYYY-MM'```。

  3. 当前日期为2011年10月，且**日志输出目录**中有五个**日志文件**：
     - ```2011-01.log```
     - ```2011-02.log```
     - ```2011-05.log```
     - ```2011-08.log```
     - ```2011-10.log```

  清理动作完成后，将只保留```2011-10.log```、```2011-08.log```两个**日志文件**。

- #### ```maxSize```
  
  设置此配置将指定**日期输出器**触发**日志文件**分割的最大体积，单位为```Byte```，当指定了```<=0```的值时将关闭自动分割，默认值为```0```。

  ::: tip 提示
  启动自动分割后，**日志文件名**中将附加**归档偏移**。
  :::

- #### ```keepFileExt```

  设置此配置将指定**日期输出器**是否在**日志文件名**中附加文件后缀```.log```，默认值为```true```。

---

让我们使用**日期输出器**在一个复杂的场景下进行日志收集：

- 保留最近5个归档日期内的日志。

- 将每秒内产生的日志归档至同一**日志文件**，超出```1KB```时自动分割。

- **日志文件**按照**归档前缀**存储，且**日志文件名**中不展示**归档前缀**。

```javascript
const Core = require('node-corejs');

// 构建输出器
const logger = new Core.DateLogger({
  env: 'prod',
  params: {
    maxSize: 1024,                      // 最大日志文件体积为1K
    keepDateNum: 5,                     // 保留最近5个周期
    sourcePath: './testlogs',           // 归档源目录
    filePrefix: 'ComplexLogger',        // 归档前缀
    filePrefixAsFileName: false,        // 日志文件名不附加归档前缀
    filePrefixAsSourcePath: true,       // 在归档源目录中创建归档前缀目录
    dateFormat: 'YYYY-MM-DD_HH_mm_ss',  // 以秒作为归档周期
  },
});

// 每100ms执行一次日志输出
setInterval(() => logger.log(new Error(`一个🌰日志`)), 100);
```

### 配置联动

在**日期输出器**的功能配置参数中，其中三个配置参数具有联动关系：

- **归档前缀**：```filePrefix```
- **使用归档前缀构建日志输出文件**：```filePrefixAsFileName```
- **使用归档前缀构建日志输出目录**：```filePrefixAsSourcePath```

首先，我们先分析这三个配置的关系：

1. 如果**归档前缀**无效，则**归档前缀**无法参与**日志输出目录**和**日志输出文件**的构建。
2. 如果**归档前缀**有效，则**归档前缀**至少参与**日志输出目录**和**日志输出文件**其中一项的构建，否则设置**归档前缀**没有意义。

::: tip 说明
当**归档前缀**没有指定或是指定为```''```时，认为无效。
:::

---

因此，**日期输出器**将自动进行配置参数校正以满足联动关系：

- 当```filePrefix```无效时，将锁定```filePrefixAsSourcePath```和```filePrefixAsFileName```为```false```。

- 当```filePrefix```有效时，则```filePrefixAsSourcePath```和```filePrefixAsFileName```中必须至少有一项指定为```true```。

- 当```filePrefix```有效时，若```filePrefixAsSourcePath```和```filePrefixAsFileName```都指定为```false```，则锁定```filePrefixAsSourcePath```为```true```。

即：**日期输出器**将在配置参数违反联动关系时，优先使用**归档前缀**构建**日志输出目录**而不是用于构建**日志输出文件**。

### 日志分割

我们已经知道，指定```maxSize```为```>0```的值时将启动**日期输出器**对**日志文件**的自动分割。接下来，我们来讨论**日志分割**的原理：

#### 在日期输出器实例化时：

1. 在**归档源目录**中提取**归档前缀**与当前**日期输出器**相同的**日志文件**。

   ::: tip 提示
   
   **日期输出器**提供了在文件系统中使用**归档前缀**分类**日志文件**的能力。
   
   启动此功能时，**日期输出器**进行**日志分割**检索时将不再逐个解析每个**日志文件名**中包含的**归档前缀**，而是认为**日志输出目录**下的所有**日志文件**具有相同的**归档前缀**，执行效率更高。

   ---

   因此，我们在使用**日期输出器**时应该：

   - 不同的**日期输出器**使用不同的**归档前缀**，即```filePrefix```。

   - 在文件系统中使用**归档前缀**分类**日志文件**，即指定```filePrefixAsSourcePath```为```true```。

   :::

2. 解析拥有相同**归档前缀**的**日志文件**中包含的**归档偏移**，并尝试读取**归档偏移**最大的**日志文件**。

3. 根据最后一个偏移处**日志文件**的体积计算新的**归档偏移**决定接下来输出的目标**日志文件**，并缓存目标**日志文件**的体积。

#### 在日期输出器执行输出时：

1. 计算日志输出动作造成的体积增量，并更新至缓存中的**日志文件**体积。

2. 比较缓存中的**日志文件**体积与分割阈值```maxSize```的关系，决定输出的目标**日志文件**。

### 日志清理

**日期输出器**使用**清理引擎**实现日志清理。**清理引擎**实现了在**归档源目录**挂载多个不同周期的清理规则时自动选择最小触发周期以降低磁盘读写达到性能优化的目的。

我们通过指定```keepDateNum```为```>0```的值以启动**日期输出器**对**日志文件**的自动清理。

清理检索阶段**日期输出器**在**归档源目录**中提取**归档前缀**相同的**日志文件**。我们在[日志分割](#日志分割)一节中已经知道，使用有效的**归档前缀**构建**日期输出目录**时将提升清理检索的效率。

---

向**清理引擎**挂载清理规则时需要指定：

- 目标清理目录

- 项目选中规则

- 日期提取规则

- 保留日期数量

---

**清理引擎**将按照配置指定的规则进行定向清理：

1. **清理引擎**首先读取并迭代**目标清理目录**中的文件和目录名称，并筛选出符合**项目选中规则**的文件/目录名称。

2. 迭代符合**项目选中规则**的文件/目录名称，使用**日期提取规则**提取其包含的**归档日期**，最终得到源**归档日期**列表。

3. 将源**归档日期**列表进行去重和排序，并根据**保留日期数量**确定需要保留的**归档日期**。

4. 删除不在需要保留的**归档日期**范围内的文件/目录。

---

对于**日期输出器**向**清理引擎**挂载的清理规则：

**目标清理目录**

- 当未使用**归档前缀**预分类**日志文件**时，使用**归档源目录**。
- 当使用了**归档前缀**预分类**日志文件**时，使用附加了**归档前缀**的**归档源目录**。

**项目选中规则**

- 通过在**日志文件名**中提取**归档日期**，并选择**归档前缀**与当前**日期输出器**一致且**归档日期**小于当前日期的文件。

**日期提取规则**

- 解析**日志文件名**得到**归档日期**。

## 文件输出器

**文件输出器**继承自[基础输出器](#基础输出器)，支持**基础输出器**所有的**配置参数**。并且，在**运行环境**为```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```时保持与**基础输出器**一致的输出行为，即：将日志输出至控制台。

同样，**文件输出器**也拓展了许多激动人心的功能。我们可以在日志集中收集的场景中使用它。

---

**文件输出器**在非```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```环境中，将输出器产生的所有日志输出至同一**日志文件**。

我们可以通过在**文件输出器**实例化时调整功能配置参数，使多个具有相同且有效**归档前缀**的**文件输出器**产生的**日志文件**按照**归档周期**归档。同样，我们可以指定**归档周期保留数量**，**文件输出器**会帮我们自动清理过期的**日志文件**。

::: tip 提示
**文件输出器**通常用于频次型业务链路的日志收集。

比如：我们可以使用**文件输出器**将每次客户端请求处理链路的日志归档至同一**日志文件**；并将每天产生的**日志文件**存储在同一**日志输出目录**内，同时只保留最近一周的**日志文件**。
:::

### 功能说明

1. **文件输出器**产生的所有日志输出至同一文件。

2. 支持自动/手动模式管理**文件输出器**资源。

3. 支持设置日志输出目录和文件名的构成规则。

4. 支持设置**归档周期**和**周期保留数量**。

5. 输出环境异常时自动降级保证日志完整性。

   ::: tip 说明
   当**文件输出器**无法创建日志输出目录或文件时，**运行环境**自动降级至```BASE_LOGGER_DEVELOPMENT_ENVIRONMENT```将日志输出至控制台。
   :::

### 异常捕获

与**基础输出器**捕获异常的方式相同，在实例化**文件输出器**时指定异常处理器```_errorHandler```即可对**文件输出器**运行过程中产生的异常进行捕获。

---

**文件输出器**中的异常处理器拓展了执行输出器启动和关闭动作时产生的异常细节信息（```errDetail```）内自定义```Error```的类型。

我们可以通过修改```Core.Messages```中对应的宏变量以变更自定义```Error```的文案：

| 异常场景                               | 异常类型（```errType```）归属             | 导致异常的自定义```Error```                     |
| :----------------------------------- | :-------------------------------------- | :------------------------------------------- |
| 自动模式下的文件输出器执行了```start()``` | ```BASE_LOGGER_ERROR_TYPE_CANT_START``` | ```FILE_LOGGER_MESSAGE_CANT_START_IN_AUTO``` |
| 自动模式下的文件输出器执行了```close()``` | ```BASE_LOGGER_ERROR_TYPE_CANT_CLOSE``` | ```FILE_LOGGER_MESSAGE_CANT_CLOSE_IN_AUTO``` |

---

除此之外，**文件输出器**中的异常处理器还对异常类型```errType```进行了拓展：

| 名称                                             | 描述              | 产生原因                            |
| :---------------------------------------------- | :---------------- | :-------------------------------- |
| ```FILE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   | 无法创建日志输出文件 | 应用权限不足或操作系统异常（磁盘不足等） |
| ```FILE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` | 无法创建日志输出目录 | 应用权限不足或操作系统异常（磁盘不足等） |

同时，**文件输出器**拓展的异常类型附带的细节信息```errDetail```也更加详细，其结构为```{ error, errorPath, errorDescription }```。

- **```error```**：导致异常的```Error```实例。
- **```errorPath```**：导致异常的日志输出目录/文件路径。
- **```errorDescription```**：异常的描述文案。

我们同样可以通过修改```Core.Messages```中对应的宏变量以变更异常描述文案```errorDescription```：

| 异常描述宏                                     | 产生时机                     | 异常类型（```errType```）归属                      |
| :------------------------------------------- | :-------------------------- | :---------------------------------------------- |
| ```FILE_LOGGER_MESSAGE_CANT_CREATE_FILE```   | 文件输出器无法创建日志输出文件时 | ```FILE_LOGGER_ERROR_TYPE_CANT_CREATE_FILE```   |
| ```FILE_LOGGER_MESSAGE_CANT_CREATE_FOLDER``` | 文件输出器无法创建日志输出目录时 | ```FILE_LOGGER_ERROR_TYPE_CANT_CREATE_FOLDER``` |

### 运行模式

**文件输出器**支持使用**自动模式**和**手动模式**管理状态和资源，默认使用**自动模式**。当然，我们可以在实例化**文件输出器**时调整```auto```以选择**文件输出器**的**运行模式**。

#### 自动模式

---

此模式下，**文件输出器**将自动完成状态和资源管理。

我们无需在业务层中显式调用```start()```和```close()```；期望输出日志时直接调用```log()```即可。

::: tip 提示
在我们使用**自动模式**时，通常配合```timeout```设置**文件输出器**自动进行资源控制的懒惰程度。
:::

---

**文件输出器**将会在合适的时机自动进行状态和资源管理：

- **执行日志输出动作前**：检测输出器状态，如果处于关闭状态，将自动创建相关资源并变更为启动状态再执行输出动作。
- **执行日志输出动作后**：检测无操作时间，如果在```timeout```指定的时间内没有进行日志输出动作，将自动变更为关闭状态并释放其占用的资源（比如：文件句柄等）。

#### 手动模式

---

此模式下，需要在业务层完成**文件输出器**的状态和资源管理。当进行非法操作时，**文件输出器**将抛出异常。

我们需要知道的是：

- **文件输出器**仅允许在启动状态使用```log()```输出日志。
- ```start()```的作用是：将**文件输出器**变更为启动状态并创建相关资源。
- ```close()```的作用是：将**文件输出器**变更为关闭状态并释放占用资源。

---

因此，我们在期望输出日志时，需要先显式执行```start()```启动**文件输出器**；并在不需要使用输出器时使用```close()```解除资源占用。

### 输出规则

在**文件输出器**实例化时调整配置参数以指定日志的**输出目录**和**输出文件名**。

#### 日志输出目录

---

**日志输出目录**可能由**归档源目录**、**归档前缀**和**归档日期**构成。

**文件输出器**提供了使用**归档前缀**和**归档日期**对**日志文件**进行分类的能力。我们可以通过实例化**文件输出器**时调整配置参数以指定是否附加**归档前缀**或**归档日期**至**归档源目录**构成最终的**日志输出目录**以实现**日志文件**的分类。

::: warning 注意
出于**日志文件**检索的复杂性考虑，我们无法直接附加**归档日期**至**归档源目录**得到**日志输出目录**。

即：仅在使用**归档前缀**预分类**日志文件**时，才能通过**归档日期**对**日志文件**进行分类。

我们将在[配置联动](#配置联动-2)一节中详细讨论配置参数间的依赖关系。
:::

#### 日志输出文件

---

**日志文件名**的结构为：**<%归档前缀%>.<%归档文件名%>.<%归档日期%>.<%归档类型%>.<%文件后缀%>**。

| 构成元素   | 规则                                                                                             |
| :-------- | :---------------------------------------------------------------------------------------------- |
| 归档前缀   | 通过实例化文件输出器时配置```filePrefix```和```filePrefixAsFileName```附加至日志文件名中                |
| 归档文件名 | 一定出现在归档文件名中。首选实例化文件输出器时配置的```fileName```，若配置无效则使用长度为```16```的随机字符串 |
| 归档日期   | 通过实例化文件输出器时配置```dateFormat```和```dateAsFileName```附加至日志文件名中                      |
| 归档类型   | 文件输出器根据日志文件名构成元素的排列方式自动生成归档类型                                                |
| 文件后缀   | 通过实例化文件输出器时配置```keepFileExt```启用日志文件后缀时会附加至日志文件名中                          |

::: tip 说明
**归档类型**由**归档前缀**、**归档日期**和**归档文件名**的排列方式决定。**文件输出器**将自动根据构成元素附加**归档类型**至**日志文件名**：

- 当**日志文件名**由**归档文件名**和**归档日期**构成时，**归档类型**为```[FN]```。

- 当**日志文件名**由**归档前缀**和**归档文件名**构成时，**归档类型**为```[FP]```。

- 其他场景下，不附加**归档类型**至**日志文件名**。

需要注意的是，**归档类型**记录了**日志文件名**的元信息，我们不要对**日志输出目录**中已生成的**日志文件**进行重命名操作。
:::

### 功能参数

- #### ```sourcePath```

  设置此配置将指定**文件输出器**的**归档源目录**，默认值为```path.resolve(process.cwd(), `./logs/${process.pid}`)```。

  ::: tip 提示

  - 由于文件系统限制，我们在设置**归档源目录**时不能使用```<?*"|>```这6个非法字符，**文件输出器**将自动替换非法字符为```'_'```。

  - 在使用了```Cluster```架构的应用程序中，多进程抢夺相同的文件资源导致日志归档异常。因此，我们应尽量使用进程标识符（比如：```process.pid```）作为**归档源目录**的构成元素。

  - 当由**归档源目录**和**归档前缀**或**归档日期**构成的**日志输出目录**在文件系统中不存在时，**文件输出器**将在实例化过程中尝试创建；如果**日志输出目录**创建失败将导致**运行环境**降级。

  :::

  ---

  通常，应用程序中的**日志输出器**使用相同的**归档源目录**以实现日志的集中存储：

  ```javascript
  const Core = require('node-corejs');

  // 公用的日志归档源目录
  const sourcePath = './testlogs';

  // 创建日期输出器
  const dateLogger = new Core.DateLogger({
    env: 'prod',
    level: 'infos',
    params: { filePrefix: 'DateLogger', sourcePath }
  });

  // 创建文件输出器
  const fileLogger = new Core.FileLogger({
    env: 'prod',
    level: 'infos',
    params: { filePrefix: 'FileLogger', sourcePath }
  });

  // 执行日志输出
  dateLogger.log('一条🌰日志');
  fileLogger.log('一条🌰日志');
  ```

- #### ```auto```

  设置此配置将指定**文件输出器**是否使用**自动模式**作为**运行模式**，默认值为```true```。

- #### ```timeout```

  设置此配置将指定**文件输出器**在**自动模式**中自动释放资源的等待时间，单位为**毫秒**，默认值为```10000```。

  ::: tip 提示
  此配置仅在**文件输出器**使用**自动模式**时生效，**手动模式**下将被锁定为```0```。
  :::

---

在**文件输出器**使用**自动模式**时，我们无需显式调用```start()```和```close()```即可执行日志输出动作。如果强行调用```start()```和```close()```，**文件输出器**将抛出异常，我们可以通过在实例化时配置```_errorHandler```进行捕获：

```javascript
const Core = require('node-corejs');

// 创建使用自动模式的文件输出器
const logger = new Core.FileLogger({
  env: 'prod',
  params: {
    // 指定使用自动模式
    auto: true,
    timeout: 10000,
    // 将捕获到的异常输出到控制台
    _errorHandler(errType, errDetail) { console.log(errType, errDetail) }
  }
});

// 强行调用start()和close()
logger.start();
logger.close();
```

---

同样，在**文件输出器**使用**手动模式**时，如果在执行```log()```发起日志输出动作前没有显式调用```start()```和```close()```变更**文件输出器**状态，同样会抛出异常：

```javascript
const Core = require('node-corejs');

// 创建使用手动模式的文件输出器
const logger = new Core.FileLogger({
  env: 'prod',
  params: {
    // 指定使用手动模式
    auto: false,
    timeout: 10000,
    // 将捕获到的异常输出到控制台
    _errorHandler(errType, errDetail) { console.log(errType, errDetail) }
  }
});

// 强行发起log()
logger.log('一条🌰日志');
```

- #### ```fileName```
  
  设置此配置将指定**文件输出器**的**归档文件名**，默认通过```_generateFileName()```根据**进程标识**、**当前时间戳**和**8位随机小写字母和数字**生成16长度的字符串作为**归档文件名**。

  **归档文件名**将作为**日志文件名**的组成部分。因此，由于文件系统限制，我们在设置**归档文件名**时不能使用```<\.:?*"|/>```这10个非法字符，**文件输出器**将自动替换非法字符为```'_'```。

  ::: tip 提示
  **归档文件名**不是最终输出至文件系统的**日志文件名**，而是作为**日志文件名**的构成元素。
  :::

- #### ```filePrefix```

  设置此配置将指定**文件输出器**的**归档前缀**，默认值为```''```。

  **归档前缀**可以作为**日志输出目录**和**日志文件名**的组成部分。因此，由于文件系统限制，我们在设置**归档前缀**时不能使用```<\.:?*"|/>```这10个非法字符，**文件输出器**将自动替换非法字符为```'_'```。
  
  ::: danger 注意
  **归档前缀**是一个非常关键的配置项，将可能联动很多其他配置，进而极大影响**文件输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```filePrefixAsSourcePath```

  设置此配置将指定**文件输出器**是否在**归档源目录**中创建以**归档前缀**命名的目录用于存放**日志文件**，即在文件系统中使用**归档前缀**分类**日志文件**，默认值为```true```。

  ::: danger 注意
  此配置可能联动很多其他配置，进而极大影响**文件输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```filePrefixAsFileName```

  设置此配置将指定**文件输出器**是否在**日志文件名**中展示**归档前缀**，默认值为```true```。

  ::: danger 注意
  此配置可能联动很多其他配置，进而极大影响**文件输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```dateFormat```

  设置此配置将指定**文件输出器**的**归档周期**和**归档日期格式**，默认值为```YYYY-MM-DD```。
  
  **归档日期**将可能根据此配置中指定的**归档日期格式**附加至**日志文件名**。因此，由于文件系统限制，我们在设置此配置时不能使用```<\.:?*"|/>```这10个非法字符，**文件输出器**将自动替换非法字符为```'_'```。

  同样，指定**文件输出器**使用的**归档日期格式**时也必须使用**递进方式组合日期元素**。关于如何**递进方式组合日期元素**，我们可以参考[日期输出器](#日期输出器)中对[```dateFormat```](#dateformat)配置项的介绍。

  ::: danger 注意
  **归档日期格式**也是一个非常关键的配置项，将可能联动很多其他配置，进而极大影响**文件输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```dateAsSourcePath```

  设置此配置将指定**文件输出器**是否在**归档源目录**中以**归档前缀**命名的目录下创建以**归档日期**命名的目录用于存放**日志文件**，即在文件系统中使用**归档前缀**和**归档日期**分类**日志文件**，默认值为```true```。

  ::: danger 注意
  此配置可能联动很多其他配置，进而极大影响**文件输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```dateAsFileName```

  设置此配置将指定**文件输出器**是否在**日志文件名**中展示**归档日期**，默认值为```true```。

  ::: danger 注意
  此配置可能联动很多其他配置，进而极大影响**文件输出器**的行为。对于联动关系的注意事项，我们将在[配置联动](#配置联动-2)一节中进行详细讨论。
  :::

- #### ```keepDateNum```

  设置此配置将指定**文件输出器**的**归档周期保留数量**，当指定了```<=0```的值时将关闭自动清理，默认值为```0```。

  需要注意的是，**文件输出器**将保留包含当前**归档周期**在内的最近```keepDateNum```个周期内生成的**日志文件**。

- #### ```keepFileExt```

  设置此配置将指定**文件输出器**是否在**日志文件名**中附加文件后缀```.log```，默认值为```true```。

---

让我们使用**文件输出器**在一个复杂的场景下进行日志收集：

- 保留最近5秒内的日志。

- **日志文件名**中展示**归档时间**，但不展示**归档前缀**。

- **日志文件**按照**归档前缀**存储，并将每秒内产生的**日志文件**归档至同一目录。

```javascript
const Core = require('node-corejs');

let count = 0;

// 每150ms创建文件输出器并输出日志
setInterval(() => {
  count += 1;
  const logger = new Core.FileLogger({
    env: 'prod',
    level: 'infos',
    params: {
      fileName: count,                    // 归档文件名
      sourcePath: './testlogs',           // 归档源目录
      filePrefix: 'ComplexLogger',        // 归档前缀
      filePrefixAsSourcePath: true,       // 使用归档前缀预分类日志
      filePrefixAsFileName: false,        // 日志文件名不附加归档前缀
      dateFormat: 'YYYY-MM-DD_HH_mm_ss',  // 归档日期格式
      dateAsSourcePath: true,             // 使用归档日期分类日志
      dateAsFileName: true,               // 日志文件名不附加归档日期
      keepDateNum: 5                      // 保留最近5个归档日期
    }
  });

  // 每个文件输出器执行4次日志输出
  logger.log('i', `infos级别的🌰日志 -> ${count}`);
  logger.log('w', `warns级别的🌰日志 -> ${count}`);
  logger.log('e', `error级别的🌰日志 -> ${count}`);
  logger.log('f', `fatal级别的🌰日志 -> ${count}`);
}, 150);
```

### 配置联动

在**文件输出器**的功能配置参数中，有两组联动关系：

#### 归档前缀联动

- **归档前缀**：```filePrefix```
- **使用归档前缀构建日志输出文件**：```filePrefixAsFileName```
- **使用归档前缀构建日志输出目录**：```filePrefixAsSourcePath```

#### 归档日期联动

- **归档日期格式**：```dateFormat```
- **使用归档日期构建日志输出文件**：```dateAsFileName```
- **使用归档日期构建日志输出目录**：```dateAsSourcePath```

---

首先，我们来分析**归档前缀**的联动关系：

1. 如果**归档前缀**无效，则**归档前缀**无法参与**日志输出目录**和**日志输出文件**的构建。
2. 如果**归档前缀**有效，则**归档前缀**至少参与**日志输出目录**和**日志输出文件**其中一项的构建，否则设置**归档前缀**没有意义。

接下来，我们分析**归档日期**的联动关系。**归档日期**与**归档前缀**的联动关系类似：

1. 如果**归档日期格式**无效，则**归档前缀**无法参与**日志输出目录**和**日志输出文件**的构建。
2. 如果**归档日期格式**有效，则**归档日期**至少参与**日志输出目录**和**日志输出文件**其中一项的构建，否则设置**归档日期格式**没有意义。

另外，我们已经知道，**只有在使用归档前缀预分类日志文件时，才能通过归档日期对日志文件进行分类**。即：只有在**使用归档前缀构建日志输出目录**时才能启用**使用归档日期构建日志输出目录**。因此：

- 如果**归档前缀**不参与构建**日志输出目录**，则**归档日期**无法参与**日志输出目录**。

::: tip 说明
当**归档前缀**、**归档日期格式**没有指定或是指定为```''```时，认为无效。
:::

---

**文件输出器**将自动进行配置参数校正以满足联动关系。

对于**归档前缀**的联动关系，**文件输出器**将确保：

- 当```filePrefix```无效时，将锁定```filePrefixAsSourcePath```和```filePrefixAsFileName```为```false```。

- 当```filePrefix```有效时，则```filePrefixAsSourcePath```和```filePrefixAsFileName```中必须至少有一项指定为```true```。

- 当```filePrefix```有效时，若```filePrefixAsSourcePath```和```filePrefixAsFileName```都指定为```false```，则锁定```filePrefixAsSourcePath```为```true```。

对于**归档日期**的联动关系，**文件输出器**将确保：

- 当```dateFormat```无效时，将锁定```dateAsSourcePath```和```dateAsFileName```为```false```。

- 当```dateFormat```有效时，则```dateAsSourcePath```和```dateAsFileName```中必须至少有一项指定为```true```。

- 当```dateFormat```有效时，若```dateAsSourcePath```和```dateAsFileName```都指定为```false```，则锁定```dateAsSourcePath```为```true```。

::: tip 提示
**日期输出器**将在配置参数违反联动关系时，优先保证使用**归档前缀**或**归档日期**构建**日志输出目录**而不是用于构建**日志输出文件**。
:::

---

对于**归档前缀**和**归档日期**维度的高阶联动，**文件输出器**将确保：

- 当```filePrefix```无效时，将锁定```dateAsSourcePath```为```false```。

- 当```filePrefix```有效，且```filePrefixAsSourcePath```为```false```时，将锁定```dateAsSourcePath```为```false```。

- 当```dateFormat```有效，且```dateAsSourcePath```因①或②而被锁定为```false```时，则锁定```dateAsFileName```为```true```。

此策略将使**文件输出器**既能够保证**归档前缀**和**归档日期**的高阶联动性，又可以使指定的**归档日期格式**发挥作用。

### 日志清理

**文件输出器**同样使用**清理引擎**实现日志清理。我们通过指定```keepDateNum```为```>0```的值以启动**文件输出器**对**日志文件**的自动清理。

清理检索阶段**文件输出器**同样是在**归档源目录**中寻找**归档前缀**相同的**日志文件**。因此，我们可以通过指定```filePrefix```和```filePrefixAsSourcePath```配置，使用有效的**归档前缀**构建**日期输出目录**以提升清理检索的效率。

---

接下来，我们来讨论**文件输出器**向**清理引擎**挂载的清理规则。关于**清理引擎**的运行原理，可以参照[日期输出器](#日期输出器)的[日志清理](#日志清理)一节。

**目标清理目录**

- 当未使用**归档前缀**预分类**日志文件**时，使用**归档源目录**。
- 当使用了**归档前缀**预分类**日志文件**时，使用附加了**归档前缀**的**归档源目录**。

**项目选中规则**

- 当未使用**归档前缀**预分类**日志文件**时，通过在**日志文件名**中提取**归档日期**，并选择**归档前缀**与当前**文件输出器**一致且**归档日期**小于当前日期的文件。
- 当使用了**归档前缀**预分类**日志文件**时：
  - 如果未使用**归档日期**分类**日志文件**，此时**清理引擎**应用**项目选中规则**的内容为**日志文件名**。通过在**日志文件名**中提取**归档日期**，并选择**归档日期**符合**文件输出器**指定**归档日期格式**的**日志文件**。
  - 如果使用了**归档日期**分类**日志文件**，此时**清理引擎**应用**项目选中规则**的内容为**归档日期**创建的目录名。选择**归档日期**符合**文件输出器**指定**归档日期格式**的**日志目录**。

**日期提取规则**

- 当未使用**归档前缀**预分类**日志文件**时，解析**日志文件名**得到**归档日期**。
- 当使用了**归档前缀**预分类**日志文件**时：
  - 如果未使用**归档日期**分类**日志文件**，此时**清理引擎**应用**日期提取规则**的内容为**日志文件名**。解析**日志文件名**得到**归档日期**。
  - 如果使用了**归档日期**分类**日志文件**，此时**清理引擎**应用**日期提取规则**的内容为以**归档日期**创建的目录名，直接作为**归档日期**。
